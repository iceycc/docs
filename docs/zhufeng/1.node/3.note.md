# ğŸŒ¹ nodeJSè¶…é•¿æ€»ç»“ 3 KOA
## ğŸŒ¹ğŸŒ¹ ğŸ± ğŸ¶ ğŸ­ ğŸ˜ ğŸ³ âœˆï¸ ğŸš„ ğŸš— âš½ï¸ ğŸ’† ğŸ¥š ğŸ§’ ğŸŒ¹ ğŸ¯ 
ä¸Šæ¬¡æ€»ç»“åˆ°äº†httpçš„å®ç°ã€‚ã€‚ã€‚ã€‚å¦å¼€ä¸€ç« ï¼Œç»§ç»­æ€»ç»“è®°å½•

---

# ğŸŒ¹ koa
## ğŸŒ¹ğŸŒ¹ å¼€å§‹ä¸€ä¸ªkoa ,å®˜æ–¹æ–‡æ¡£
### 1. ç®€ä»‹
* Koa æ˜¯ä¸€ä¸ªæ–°çš„ web æ¡†æ¶ï¼Œç”± Express å¹•åçš„åŸç­äººé©¬æ‰“é€ ï¼Œ è‡´åŠ›äºæˆä¸º web åº”ç”¨å’Œ API å¼€å‘é¢†åŸŸä¸­çš„ä¸€ä¸ªæ›´å°ã€æ›´å¯Œæœ‰è¡¨ç°åŠ›ã€æ›´å¥å£®çš„åŸºçŸ³ã€‚
* é€šè¿‡åˆ©ç”¨ async å‡½æ•°ï¼ŒKoa å¸®ä½ ä¸¢å¼ƒå›è°ƒå‡½æ•°ï¼Œå¹¶æœ‰åŠ›åœ°å¢å¼ºé”™è¯¯å¤„ç†ã€‚ 
* Koa å¹¶æ²¡æœ‰æ†ç»‘ä»»ä½•ä¸­é—´ä»¶ï¼Œ è€Œæ˜¯æä¾›äº†ä¸€å¥—ä¼˜é›…çš„æ–¹æ³•ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿè€Œæ„‰å¿«åœ°ç¼–å†™æœåŠ¡ç«¯åº”ç”¨ç¨‹åºã€‚

### 2. å®‰è£…
1. node 7.6ä»¥ä¸Šç‰ˆæœ¬
2. ä½ç‰ˆæœ¬ç”¨bableç¼–è¯‘
````
$ nvm install 7
$ npm i koa
$ node my-koa-app.js
````

### 3. åº”ç”¨ç¨‹åº
#### hellow world:
````javascript
const Koa = require('koa'); // å¼•å…¥
const app = new Koa(); // åˆ›å»ºå®åŠ›

app.use(async ctx => { // 
  ctx.body = 'Hello World';
});

app.listen(3000); // 
````

#### çº§è”

````javascript
const Koa = require('koa');
const app = new Koa();

// logger

app.use(async (ctx, next) => {
  await next();
  const rt = ctx.response.get('X-Response-Time');
  console.log(`${ctx.method} ${ctx.url} - ${rt}`);
});

// x-response-time

app.use(async (ctx, next) => {
  const start = Date.now();
  await next();
  const ms = Date.now() - start;
  ctx.set('X-Response-Time', `${ms}ms`);
});

// response

app.use(async ctx => {
  ctx.body = 'Hello World';
});

app.listen(3000);
````
#### app.listen(...)
åˆ›å»ºå¹¶è¿”å› HTTP æœåŠ¡å™¨ï¼Œå°†ç»™å®šçš„å‚æ•°ä¼ é€’ç»™ Server#listen():
````javascript
const Koa = require('koa');
const app = new Koa();
app.listen(3000);
````
è¿™é‡Œçš„ app.listen(...) æ–¹æ³•åªæ˜¯ä»¥ä¸‹æ–¹æ³•çš„è¯­æ³•ç³–:
````javascript
const http = require('http');
const Koa = require('koa');
const app = new Koa();
http.createServer(app.callback()).listen(3000);
````
è¿™æ„å‘³ç€æ‚¨å¯ä»¥å°†åŒä¸€ä¸ªåº”ç”¨ç¨‹åºåŒæ—¶ä½œä¸º HTTP å’Œ HTTPS æˆ–å¤šä¸ªåœ°å€ï¼š
````javascript
const http = require('http');
const https = require('https');
const Koa = require('koa');
const app = new Koa();
http.createServer(app.callback()).listen(3000);
https.createServer(app.callback()).listen(3001);
````
#### app.callback()
è¿”å›é€‚ç”¨äº http.createServer() æ–¹æ³•çš„å›è°ƒå‡½æ•°æ¥å¤„ç†è¯·æ±‚ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ­¤å›è°ƒå‡½æ•°å°† koa åº”ç”¨ç¨‹åºæŒ‚è½½åˆ° Connect/Express åº”ç”¨ç¨‹åºä¸­ã€‚

#### app.use(function)
å°†ç»™å®šçš„ä¸­é—´ä»¶æ–¹æ³•æ·»åŠ åˆ°æ­¤åº”ç”¨ç¨‹åº
#### app.keys=
è®¾ç½®ç­¾åçš„ Cookie å¯†é’¥ã€‚è¿™äº›è¢«ä¼ é€’ç»™ KeyGripï¼Œä½†æ˜¯ä½ ä¹Ÿå¯ä»¥ä¼ é€’ä½ è‡ªå·±çš„ KeyGrip å®ä¾‹ã€‚
````javascript
app.keys = ['im a newer secret', 'i like turtle'];
app.keys = new KeyGrip(['im a newer secret', 'i like turtle'], 'sha256');
````
è¿™äº›å¯†é’¥å¯ä»¥å€’æ¢ï¼Œå¹¶åœ¨ä½¿ç”¨ { signed: true } å‚æ•°ç­¾å Cookie æ—¶ä½¿ç”¨ã€‚
````javascript
ctx.cookies.set('name', 'tobi', { signed: true });
````
#### app.context
* app.context æ˜¯ä»å…¶åˆ›å»º ctx çš„åŸå‹ã€‚æ‚¨å¯ä»¥é€šè¿‡ç¼–è¾‘ app.context ä¸º ctx æ·»åŠ å…¶ä»–å±æ€§ã€‚
* è¿™å¯¹äºå°† ctx æ·»åŠ åˆ°æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„å±æ€§æˆ–æ–¹æ³•éå¸¸æœ‰ç”¨ï¼Œè¿™å¯èƒ½ä¼šæ›´åŠ æœ‰æ•ˆï¼ˆä¸éœ€è¦ä¸­é—´ä»¶ï¼‰å’Œ/æˆ– æ›´ç®€å•ï¼ˆæ›´å°‘çš„ require()ï¼‰ï¼Œè€Œæ›´å¤šåœ°ä¾èµ–äºctxï¼Œè¿™å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ç§åæ¨¡å¼ã€‚

ä¾‹å¦‚ï¼Œè¦ä» ctx æ·»åŠ å¯¹æ•°æ®åº“çš„å¼•ç”¨ï¼š
````javascript
app.context.db = db();

app.use(async ctx => {
  console.log(ctx.db);
});
````
æ³¨æ„
* ctx ä¸Šçš„è®¸å¤šå±æ€§éƒ½æ˜¯ä½¿ç”¨ getter ï¼Œsetter å’Œ Object.defineProperty() å®šä¹‰çš„ã€‚ä½ åªèƒ½é€šè¿‡åœ¨ app.context ä¸Šä½¿ç”¨ Object.defineProperty() æ¥ç¼–è¾‘è¿™äº›å±æ€§ï¼ˆä¸æ¨èï¼‰ã€‚
* å®‰è£…çš„åº”ç”¨ç¨‹åºç›®å‰ä½¿ç”¨å…¶çˆ¶çº§çš„ ctx å’Œè®¾ç½®ã€‚ å› æ­¤ï¼Œå®‰è£…çš„åº”ç”¨ç¨‹åºåªæ˜¯ä¸€ç»„ä¸­é—´ä»¶ã€‚

#### é”™è¯¯å¤„ç†
````javascript
// é»˜è®¤æƒ…å†µä¸‹ï¼Œå°†æ‰€æœ‰é”™è¯¯è¾“å‡ºåˆ° stderrï¼Œé™¤é app.silent ä¸º trueã€‚ å½“ err.status æ˜¯ 404 æˆ– err.expose æ˜¯ true æ—¶é»˜è®¤é”™è¯¯å¤„ç†ç¨‹åºä¹Ÿä¸ä¼šè¾“å‡ºé”™è¯¯ã€‚ è¦æ‰§è¡Œè‡ªå®šä¹‰é”™è¯¯å¤„ç†é€»è¾‘ï¼Œå¦‚é›†ä¸­å¼æ—¥å¿—è®°å½•ï¼Œæ‚¨å¯ä»¥æ·»åŠ ä¸€ä¸ª â€œerrorâ€ äº‹ä»¶ä¾¦å¬å™¨ï¼š
app.on('error', err => {
  log.error('server error', err)
});
// å¦‚æœ req/res æœŸé—´å‡ºç°é”™è¯¯ï¼Œå¹¶ä¸” _æ— æ³•_ å“åº”å®¢æˆ·ç«¯ï¼ŒContextå®ä¾‹ä»ç„¶è¢«ä¼ é€’ï¼š
app.on('error', (err, ctx) => {
  log.error('server error', err, ctx)
});
````
å½“å‘ç”Ÿé”™è¯¯ _å¹¶ä¸”_ ä»ç„¶å¯ä»¥å“åº”å®¢æˆ·ç«¯æ—¶ï¼Œä¹Ÿæ²¡æœ‰æ•°æ®è¢«å†™å…¥ socket ä¸­ï¼ŒKoa å°†ç”¨ä¸€ä¸ª 500 â€œå†…éƒ¨æœåŠ¡å™¨é”™è¯¯â€ è¿›è¡Œé€‚å½“çš„å“åº”ã€‚åœ¨ä»»ä¸€æƒ…å†µä¸‹ï¼Œä¸ºäº†è®°å½•ç›®çš„ï¼Œéƒ½ä¼šå‘å‡ºåº”ç”¨çº§ â€œé”™è¯¯â€ã€‚

### 4.ä¸Šä¸‹æ–‡ Context/ctx
* Koa Context å°† node çš„ request å’Œ response å¯¹è±¡å°è£…åˆ°å•ä¸ªå¯¹è±¡ä¸­ã€‚
* Context/ctxå°±æ˜¯reqå’Œresçš„å°è£…
````javascript
app.use(async ctx => {
  ctx; // è¿™æ˜¯ Context 
  // ä¼šè‡ªåŠ¨å°†ä¸€äº›apiå§”æ‰˜ç»™ ctx.requestæˆ–è€… koa Response
  // ä¾‹å¦‚ ctx.type å’Œ ctx.length å§”æ‰˜ç»™ response å¯¹è±¡ï¼Œctx.path å’Œ ctx.method å§”æ‰˜ç»™ requestã€‚
  ctx.request; // è¿™æ˜¯ koa Request è¯·æ±‚æŠ¥æ–‡
  ctx.response; // è¿™æ˜¯ koa Response ç›¸åº”æŠ¥æ–‡
});
````
### 5.API Context/ctx å…·ä½“æ–¹æ³•å’Œè®¿é—®å™¨. è¯¦ç»†å‚è€ƒå®˜æ–¹æ–‡æ¡£
* `ctx.req`  nodeçš„requestå¯¹è±¡
* `ctx.res`  nodeçš„responseå¯¹è±¡
* `ctx.request`  koa çš„ Request å¯¹è±¡.
* `ctx.response` koa çš„ Response å¯¹è±¡. 
* `ctx.state`: 
    * æ¨èçš„å‘½åç©ºé—´ï¼Œç”¨äºé€šè¿‡ä¸­é—´ä»¶ä¼ é€’ä¿¡æ¯å’Œä½ çš„å‰ç«¯è§†å›¾ã€‚ 
    * `ctx.state.user = await User.find(id);`
* `ctx.app` åº”ç”¨ç¨‹åºå®ä¾‹å¼•ç”¨
* `ctx.cookies.get(name, [options])`
    * é€šè¿‡ options è·å– cookie name: `signed æ‰€è¯·æ±‚çš„cookieåº”è¯¥è¢«ç­¾å`
    * koaä½¿ç”¨cookieæ¨¡å—ï¼Œå…¶ä¸­åªéœ€ä¼ é€’å‚æ•° 
* `ctx.cookies.set(name, value, [options])`

## è‡ªå·±å®ç°ä¸€ä¸ªkoa
* koaä½¿ç”¨æ–¹æ³•
````javascript
let Koa = require('./koa/application');
let app = new Koa();
let logger = function () {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve();
    }, 1000);
  })
}
// returnæˆ–è€…await éƒ½å¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœ
let fs = require('fs');
app.use((ctx, next) => {
  ctx.body = fs.createReadStream('./1.txt');
  // console.log(1);
  // //throw new Error('å‡ºé”™äº†');
  // return next(); // è¿™ä¸ªå‡½æ•°æ˜¯å¼‚æ­¥å‡½æ•°
  // console.log(2);
});
app.use(async (ctx, next) => {
  console.log(3);
  await logger();
  next();
  console.log(4);
});
app.use(async (ctx, next) => {
  console.log(5);
  await next();
  console.log(6);
});
app.on('error', err => {
  console.log(err);
})
app.listen(3000);
````
* application.js
````javascript
let http = require('http');
let context = require('./context');
let request = require('./request');
let response = require('./response');
let Stream = require('stream');
let EventEmitter = require('events');
class Koa extends EventEmitter{
  constructor(){
    super();
    this.middlewares = [];
    this.context = Object.create(context);
    this.request = Object.create(request);
    this.response = Object.create(response);
  }
  use(fn){
    this.middlewares.push(fn);
  }
  createContext(req,res){
    // ä¸Šä¸‹æ–‡å°±æ˜¯ä¸€ä¸ªå¯¹è±¡è€Œå·²
    let ctx = this.context;
    // ctxä¸Šæ‹¥æœ‰ä¸¤ä¸ªè‡ªå®šä¹‰çš„å±æ€§ request response
    ctx.request = this.request;
    ctx.response = this.response;
    // reqå’Œresæ˜¯è‡ªå·±èº«ä¸Šçš„
    ctx.req = ctx.request.req = req;
    ctx.res = ctx.response.res = res;
    return ctx;
  }
  compose(ctx,middlewares){
    function dispatch(index) {
      if(index === middlewares.length) return Promise.resolve();
      let fn = middlewares[index];
      return Promise.resolve(fn(ctx,()=>dispatch(index+1)));
      }
    return dispatch(0);
  }
  handleRequest(req,res){
    let ctx = this.createContext(req,res);
    let p = this.compose(ctx,this.middlewares); // æŠŠå‡½æ•°ç»„åˆèµ·æ¥
    p.then(() => {
      let body = ctx.body;// å½“æ‰€æœ‰çš„å‡½æ•°éƒ½æ‰§è¡Œå®Œåå–å‡ºbodyçš„å€¼ï¼Œå“åº”å›å»å³å¯
      console.log(body instanceof Stream);
      if (body instanceof Stream){
        body.pipe(res);
      }else if(Buffer.isBuffer(body) || typeof body === 'string'){
        res.end(body);
      }else if(typeof body === 'object' ){
        res.end(JSON.stringify(body));
      }else{
        res.end(body);
      }
    }).catch(err => {
      this.emit('error', err);
    });
  }
  listen(...args){
    let server = http.createServer(this.handleRequest.bind(this));
    server.listen(...args);
  }
}
module.exports = Koa;
````
* context.js
````javascript
// ä¸Šä¸‹æ–‡å¯¹è±¡
let proto = {
  
}

// ctx.path
function defineGetter(target,property) {
  proto.__defineGetter__(property,function () {
    return this[target][property]
  });
}
function defineSetter(target,property) {
  proto.__defineSetter__(property,function (value) {
    this[target][property] = value
  })
}
// ctx.path = ctx.request.path;
defineGetter('request','path');
defineGetter('request','query');
defineGetter('response','body');
// ctx.body = ctx.response.body;
defineSetter('response','body')

module.exports = proto;
````
* request.js
````javascript
let request = {
  // ç±»ä¼¼äº Object.definProperty å±æ€§ä¸­çš„get
  get url(){
    return this.req.url 
  },
  get path(){
    let {pathname} = require('url').parse(this.req.url);
    return pathname
  },
  get query(){
    let { query } = require('url').parse(this.req.url,true);
    return query
  },
  get headers() {
    return this.req.headers
  }
}


module.exports = request
````

* response.js
````javascript
let response = {
  get body(){
    return this._body;
  },
  set body(value){
    this._body = value;
  }
}
response.body
module.exports = response
````


# ejs
## æ¨¡ç‰ˆå¼•æ“
````javascript

````

## è‡ªå·±å®ç°ä¸€ä¸ªç®€å•çš„ejs
å…ˆå¤ä¹ ä¸‹æ­£åˆ™
````javascript
let path = require('path');
let fs = require('fs');
let r = fs.readFileSync(path.join(__dirname, './1.html'), 'utf8');
let obj = { arr: [1, 2, 3] };

function render(str,obj) {
  let head = `let tmpl=''\r\n`;
  head += `with (obj) {\r\n`
  let content = 'tmpl+=`\r\n';
  str = str.replace(/<%=([\s\S]*?)%>/g,function () {
    return '${'+arguments[1]+'}'
  })
  content +=str.replace(/<%([\s\S]*?)%>/g,function () {
      return '`\r\n'+arguments[1] +"\r\ntmpl+=`"
  })
  let tail = '`}\r\n return tmpl';
  return head + content + tail
}
r = render(r,obj);
let fnStr = new Function('obj',r);
let result = fnStr(obj);
fs.writeFile('./1.js',result)
````

# koa-views 
koa-views ç¬¬ä¸‰æ–¹æ¨¡å— ä¸“é—¨å®ç° æ¨¡æ¿å¼•æ“çš„
## ç”¨æ³• + è‡ªå·±å®ç°
````javascript
// koa-views ç¬¬ä¸‰æ–¹æ¨¡å— ä¸“é—¨å®ç° æ¨¡æ¿å¼•æ“çš„
let Koa = require('koa');
// let views = require('koa-views') 
let app = new Koa();
let path = require('path');
// è‡ªå·±ç®€å•å®ç° 
function views(dir,{extension}) {
  return async (ctx,next)=>{
    // ctx.renderæ˜¯ä¸€ä¸ªpromiseæ–¹æ³•
    ctx.render = async function (p,obj) {
      let realPath = path.join(dir, p) + '.'+ extension;
      let fs = require('fs');
      let util = require('util');
      let readFile = util.promisify(fs.readFile);
      let str = await readFile(realPath,'utf8');
      ctx.body = require(extension).render(str, obj)
    }
    await next();
  }
}

app.use(views(path.join(__dirname, 'views'), {
  extension: 'ejs'
}));
app.use(async (ctx,next)=>{
  // renderæ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªpromise å¦‚æœä¸å†™await
  await ctx.render('index',{name:'zfpx'});
});

app.listen(3000);
````

# koa-static

## ç”¨æ³• + è‡ªå·±ç®€å•å®ç°
````javascript
let Koa = require('koa');
// let static = require('koa-static');
let app = new Koa();
let path = require('path');
let fs = require('fs');
let {promisify} = require('util');
let stat = promisify(fs.stat);
function static(root) {
  return async (ctx,next)=>{
    let realPath = path.join(root,ctx.path);
    try{
      let statObj = await stat(realPath);
      if(statObj.isDirectory()){
        let p = path.join(realPath,'index.html');
        await stat(p);
        ctx.body = fs.createReadStream(p);
      }else{
        ctx.body = fs.createReadStream(realPath);
      }
    }catch(e){
      return next();
    }
  }
}
app.use(static(path.join(__dirname,'public')));
app.use( (ctx,next) => {
    ctx.body = 'hello world'
})
app.listen(3000);
````

# body-parser
## è¿™æ˜¯å¹²å•¥
````javascript
let Koa = require('koa');
let app = new Koa();
let fs = require('fs');
let path = require('path');
app.use(async (ctx, next) => {
  if (ctx.path === '/' && ctx.method === 'GET') {
    ctx.set('Content-Type', 'text/html;charset=utf8');
    ctx.body = fs.createReadStream(path.join(__dirname, '1.html'));
  } else {
    await next();
  }
});
function bodyParser(ctx) {
  return new Promise((resolve, reject) => {
    let arr = [];
    ctx.req.on('data', function (data) {
      arr.push(data);
    });
    ctx.req.on('end', function () {
      resolve(Buffer.concat(arr));
    })
  })
}
app.use(async (ctx, next) => {
  if (ctx.path === '/login' && ctx.method === 'POST') {
    console.log('æäº¤æ¥äº†');
    // a=b
    ctx.set('Content-Type', 'text/plain;charset=utf8');
    ctx.body = await bodyParser(ctx);
  }
})
app.listen(3000);
// koaä¸Šä¼ æ–‡ä»¶ cookie session è¿›ç¨‹ express ä¸­é—´ä»¶
````