# ğŸŒ¹ nodeJSè¶…é•¿æ€»ç»“ 2
## ğŸŒ¹ğŸŒ¹ ğŸ± ğŸ¶ ğŸ­ ğŸ˜ ğŸ³ âœˆï¸ ğŸš„ ğŸš— âš½ï¸ ğŸ’† ğŸ¥š ğŸ§’ ğŸŒ¹ ğŸ¯ 
ä¸Šæ¬¡æ€»ç»“åˆ°äº†æµï¼Œå¿«ä¸¤åƒäº”ç™¾è¡Œã€‚ã€‚ã€‚ã€‚å¦å¼€ä¸€ç« ï¼Œç»§ç»­æ€»ç»“è®°å½•

---

# ğŸŒ¹ TCP
---
## ğŸŒ¹ğŸŒ¹ TCPåŸºç¡€çŸ¥è¯†

## ğŸŒ¹ğŸŒ¹ åˆ›å»ºTCPæœåŠ¡å™¨
````javascript
let net = require('net'); // åº”ç”¨netæ¨¡å—
let server = net.createServer();
function connectionListener(socket){
    console.log('å®¢æˆ·ç«¯å·²ç»é“¾æ¥')
}
server.on('connection',connectionListener); // é“¾æ¥æœåŠ¡å™¨
server.listen(8080,'hostname',function(){ // ç›‘å¬ç«¯å£ è®¾ç½®å›è°ƒ
    console.log('æœåŠ¡å™¨å¼€å§‹ç›‘å¬')
});

// ç«¯å£å ç”¨ å¯ä»¥é‡å¯æ–°çš„ç«¯å£å·
server.on('error', function (err) {
  if (err.code === 'EADDRINUSE') {
    server.listen(3001);
  }
})
````
æˆ–è€…
````javascript
let server = net.createServer();
function connectionListener(socket){
    console.log('å®¢æˆ·ç«¯å·²ç»é“¾æ¥')
}
let server = net.createServer(options,connectionListener);
server.listen('3000','hostname',function(){
    console.log('æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ')
})
````
* option.allowHalfOpené»˜è®¤ä¸ºfalse,å¦‚æœæ”¹ä¸ºtrueï¼Œå½“TCPæœåŠ¡å™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªFINåŒ…æ—¶ä¸ä¼šå›å‘FINåŒ…
* connectionListenerå‚æ•°ç”¨äºæŒ‡å®šå½“å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥æ—¶æ‰€è¦è°ƒç”¨çš„å›è°ƒå‡½æ•°ï¼Œå›è°ƒä¸­æœ‰ä¸€ä¸ªå‚æ•°socket,æŒ‡çš„æ˜¯TCPæœåŠ¡å™¨ç›‘å¬çš„socketç«¯å£å¯¹è±¡

## ğŸŒ¹ğŸŒ¹ æœåŠ¡å™¨å‚æ•°
serveråˆ›å»ºåå¯ä»¥ï¼Œè‡ªå¸¦å„ç§å‚æ•°ï¼š
````javascript
let net = require('net');
let server = net.createServer();
server.on('connection',(socket) => {
    // socket æ˜¯ä¸€ä¸ªåŒå·¥æµ
    // æ¯æ¬¡é“¾æ¥éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„socket
})
server.address();
server.getConnections((err,count) =>{
    // count
})
server.close(); //ä¸å…è®¸æ–°è¿›æ¥çš„é“¾æ¥ åªæœ‰è°ƒç”¨closeæ—¶æ‰ä¼šè§¦å‘å…³é—­
server.unref(); // å…³é—­ å½“é¥­åº—æœ€åä¸€ä¸ªäººç¦»å¼€äº† å°±ä¼šå…³é—­
server.getConnections((err,count)=>{
    console.log('å·²ç»é“¾æ¥'+count+'ä¸ªç”¨æˆ·')
});
server.on('close',callback);
server.listen(3000);
````
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ server.address();
è¿”å›æ“ä½œç³»ç»ŸæŠ¥å‘Šçš„ socket çš„åœ°å€ã€åœ°å€æ—å’Œç«¯å£ã€‚è¿”å›çš„å¯¹è±¡æœ‰ä¸‰ä¸ªå±æ€§ï¼Œä¾‹å¦‚ï¼š { port: 12346, family: 'IPv4', address: '127.0.0.1' }
* port ç«¯å£å·
* address TCPæœåŠ¡å™¨ç›‘å¬çš„åœ°å€
* family åè®®çš„ç‰ˆæœ¬

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ connections
å¼‚æ­¥è·å–æœåŠ¡å™¨çš„å½“å‰å¹¶å‘è¿æ¥æ•°ã€‚å½“ socket è¢«ä¼ é€’ç»™å­è¿›ç¨‹æ—¶å·¥ä½œã€‚
å›è°ƒå‡½æ•°çš„ä¸¤ä¸ªå‚æ•°æ˜¯ err å’Œ countã€‚
````javascript
server.getConnections((err,count)=>{ // 
    console.log('å·²ç»é“¾æ¥'+count+'ä¸ªç”¨æˆ·')
});
server.maxConnections = 2; // æœ€å¤§è¿æ¥æ•°
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ close
````javascript
server.close();
server.on('close',callback);
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ unref&ref #
unrefæ–¹æ³•æŒ‡å®šå‘å®¢æˆ·ç«¯è¿æ¥è¢«å…¨éƒ¨å…³é—­æ—¶é€€å‡ºåº”ç”¨ç¨‹åº
`server.unref();`

## ğŸŒ¹ğŸŒ¹ socketå¯¹è±¡
net.Socketä»£è¡¨ä¸€ä¸ªsocketç«¯å£å¯¹è±¡ï¼Œä»–æ˜¯ä¸€ä¸ªåŒå·¥æµ
````javascript
let net = require('net');
let server = net.createServer(function(socket){
  console.log(socket.address()) // è·å–å®¢æˆ·ç«¯åœ°å€
  socket.setEncoding('utf8'); // è½¬ç 
  socket.on('data',function(data){ // è¯»æ–‡ä»¶
    console.log(data);
    socket.write('hello');  // å†™ï¼Œè¿”å›åˆ°å®¢æˆ·ç«¯
  })
  socket.on('end',function(){
      console.log('å®¢æˆ·éƒ½æŒ‰å…³é—­')
  })
});
server.listen(8080);
```
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ `socket.address()`

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ è¯»å–æ•°æ® 
````javascript
let net = require('net')
let server = net.createServer(function(socket){
    socket.setEncoding('utf8');
    socket.on('data',function(data){
        console.log(data);
    })
    socket.on('end',function(){
        console.log('å®¢æˆ·éƒ½æŒ‰å…³é—­')
    })
})
server.listen(8000)
````
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ pipe&unpipe
* pipeæ–¹æ³•å¯ä»¥å°†å®¢æˆ·ç«¯å‘é€çš„æ•°æ®å†™åˆ°æ–‡ä»¶æˆ–å…¶å®ƒç›®æ ‡ä¸­
`socket.pipe(destinatin,[options]);`  
* options.end è®¾ç½®ä¸ºfalseæ—¶å½“å®¢æˆ·ç«¯ç»“æŸå†™æ“ä½œæˆ–å…³é—­åå¹¶ä¸ä¼šå…³é—­ç›®æ ‡å¯¹è±¡ï¼Œè¿˜å¯ä»¥ç»§ç»­å†™å…¥æ•°æ®
````javascript
let net = require('net');
let path = require('path');
let ws = require('fs').createWriteStream(path.resolve(__dirname, 'msg.txt'));
let server = net.createServer(function (socket) {
  socket.on('data', function (data) {
      console.log(data);
  });
  socket.pipe(ws, { end: false }); // è¿˜å¯ä»¥ç»§ç»­å†™å…¥æ•°æ®
  socket.on('end', function () {
      ws.end('over', function () {
          socket.unpipe(ws);
      });
  });
});
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ write
åƒå®¢æˆ·ç«¯å†™æ•°æ®  
`socket.write(data,[encoding],[callback]);`

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ bufferSize
writeçš„è¿”å›å€¼å’ŒbufferSizeå±æ€§å€¼  
````javascript
let net = require('net');
let fs = require('fs');
let path = require('path');
let server = net.createServer({ allowHalfOpen: true }, function (socket) {
    console.log("å®¢æˆ·ç«¯å·²ç»è¿æ¥");
    socket.setEncoding('utf8');
    let rs = fs.createReadStream(path.resolve(__dirname, '1.txt'), { highWaterMark: 2 });
    rs.on('data', function (data) {
        let flag = socket.write(data);
        console.log("flag:", flag);
        console.log('ç¼“å­˜å­—èŠ‚:' + socket.bufferSize); // 
        console.log('å·²å‘é€å­—èŠ‚:' + socket.bytesWritten);
    })
    socket.on('data', function (data) {
        console.log('data', data);
    });
    socket.on('drain', function (err) {
        console.log("ç¼“å­˜åŒºå·²å…¨éƒ¨å‘é€")
    });
});
server.listen('8080')
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ setTimeout
````javascript
let net = require('net');
let path = require('path');
let ws = require('fs').createWriteStream(path.resolve(__dirname, 'msg.txt'));
let server = net.createServer(function (socket) {
    socket.setTimeout(5 * 1000);
    socket.on('timeout', function () {
        socket.end(); // è¶…æ—¶å…³é—­
    });
    //socket.setTimeout(0);å–æ¶ˆè¶…æ—¶æ—¶é—´çš„è®¾ç½®
});
server.listen(8080);
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ pause&&resume
pauseå¯ä»¥æš‚åœdataäº‹ä»¶è§¦å‘ï¼ŒæœåŠ¡å™¨ä¼šæŠŠå®¢æˆ·ç«¯å‘é€çš„æ•°æ®æš‚å­˜åœ¨ç¼“å­˜åŒºé‡Œ
````javascript
const net = require('net');
const path = require('path');
let file = require('fs').createWriteStream(path.join(__dirname, 'msg.txt'));
let server = net.createServer(function (socket) {
    socket.pause(); // æš‚åœ
    setTimeout(function () {
        socket.resume();
        socket.pipe(file);
    }, 10 * 1000);
});
server.listen(8080);
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ keepAlive
* å½“æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å»ºç«‹è¿æ¥åï¼Œå½“ä¸€æ–¹ä¸»æœºçªç„¶æ–­ç”µã€é‡å¯ã€ç³»ç»Ÿå´©æºƒç­‰æ„å¤–æƒ…å†µæ—¶ï¼Œå°†æ¥ä¸åŠå‘å¦ä¸€æ–¹å‘é€FINåŒ…ï¼Œè¿™æ ·å¦ä¸€æ–¹å°†æ°¸è¿œå¤„äºè¿æ¥çŠ¶æ€ã€‚ å¯ä»¥ä½¿ç”¨setKeepAliveæ–¹æ³•æ¥è§£å†³è¿™ä¸€ä¸ªé—®é¢˜  
`socket.setKeepAlive([enaable],[initialDelay]);`
* enable æ˜¯å¦å¯ç”¨å—…æ¢ï¼Œä¸ºtrueæ—¶ä¼šä¸ä½†å‘å¯¹æ–¹å‘é€æ¢æµ‹åŒ…ï¼Œæ²¡æœ‰å“åº”åˆ™è®¤ä¸ºå¯¹æ–¹å·²ç»å…³é—­è¿æ¥ï¼Œè‡ªå·±åˆ™å…³é—­è¿æ¥
* initialDelay å¤šä¹…å‘é€ä¸€æ¬¡æ¢æµ‹åŒ…ï¼Œå•ä½æ˜¯æ¯«ç§’
  
## ğŸŒ¹ğŸŒ¹ TCPå®¢æˆ·ç«¯
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ åˆ›å»ºTCPå®¢æˆ·ç«¯
````javascript
const net = require('net');
let socket = new net.Socket(options);

socket.connect(port, host, callback);
----------æˆ–è€…-----------
socket.on('connect', callback);
````
* writeè¡¨ç¤ºå‘æœåŠ¡å™¨å†™å…¥æ•°æ®
* end ç”¨äºç»“æŸè¿æ¥
* error è¿æ¥å‘ç”Ÿé”™è¯¯
* destroy é”€æ¯æµ
* close è¡¨ç¤ºè¿æ¥å…³é—­æˆåŠŸï¼ŒhasError=trueä»£è¡¨æœ‰å¯èƒ½æœ‰é”™è¯¯

## ğŸŒ¹ğŸŒ¹ èŠå¤©å®¤
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ ç®€å•ç‰ˆæœ¬
é€šè¿‡telnetå»ºç«‹å®¢æˆ·ç«¯ï¼Œæ¨¡æ‹Ÿå¤šç”¨æˆ·
````javascript
let net = require('net');
// èŠå¤©å®¤ 
let server = net.createServer();
let client = []; 
server.on('connection',
  function (socket) {
    client.push(socket);
    server.getConnections((err, count) => {
      socket.write(`å½“å‰èŠå¤©å®¤å¯ä»¥å®¹çº³${server.maxConnections},ä½ æ˜¯å½“å‰ç¬¬${count}äºº\r\n`);
    })
    socket.setEncoding('utf8');
    socket.on('data', function (data) {
      data = data.replace("\r\n", '');
      client.forEach(s => {
        if (s == socket) return;
        s.write(data);
      });
    });
    socket.on('end', () => {
      client = client.filter(s => s != socket);
    });
  });
// æœ€å¤§è¿æ¥æ•°
server.on('close', function () {
  console.log('close');
})
server.maxConnections = 3;
server.listen(3000);

// æœåŠ¡å™¨å…³é—­
      // server.close(); //ä¸å…è®¸æ–°è¿›æ¥çš„é“¾æ¥ åªæœ‰è°ƒç”¨closeæ—¶æ‰ä¼šè§¦å‘å…³é—­
      // server.unref(); // å…³é—­ å½“é¥­åº—æœ€åä¸€ä¸ªäººç¦»å¼€äº† å°±ä¼šå…³é—­
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ è¿›é˜¶ç‰ˆæœ¬ å¯ä»¥è®¾ç½®ç”¨æˆ·åï¼Œç§èŠåŠŸèƒ½
````javascript
// æŒ‡ä»¤
// l: æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·
// b: æˆ‘çˆ±ä½  å¹¿æ’­
// s:zs:æˆ‘çˆ±ä½ 
// r:zs
// xxx: å‘½ä»¤ä¸å­˜åœ¨
let net = require('net');
let clients = {
  //'å”¯ä¸€çš„å€¼':{name:'åŒ¿å',socket:soclet}
}
let server = net.createServer(function (socket) {
  let key = socket.remoteAddress + socket.remotePort;
  clients[key] =  {
      name: 'åŒ¿å',
      socket
    }
  server.getConnections(()=>{
    socket.write('æ¬¢è¿æ¥åˆ°èŠå¤©å®¤:\r\n');
  });
  socket.setEncoding('utf8');
  socket.on('data',function (data) {
    data = data.replace("\r\n",'');
    let char = data.split(":");
    switch (char[0]) {
      case 'l':
        list(socket); // æŠŠåˆ—è¡¨æ˜¾ç¤ºç»™å½“å‰çš„ç”¨æˆ·
        break;
      case 'b': // b:æˆ‘çˆ±ä½ 
        broadCast(key,char[1]);
        break;
      case 's': // s:zs:ä½ å¥½
        private(char[1],char[2],key);
        break;
      case 'r': // r:zs
        rname(socket,char[1],key);
        break;
      default:
        break;
    }
  })
});
// let c = { 'xxx': { name: 'zfpx',socket }, 'qqq': { name: 'zs' }}
function private(username,content,key) {
  let user = Object.values(clients).find(item=>item.name==username);
  user.socket.write(`${clients[key].name}:${content}\r\n`);
}
function broadCast(key,content) {
  for(let k in clients){
    if(k !=key){
      clients[k].socket.write(`${clients[key].name}:${content}\r\n`);
    }
  }
}
function rname(socket,newName,key) {
    clients[key].name = newName;
    socket.write(`æ­å–œ:æ–°çš„åå­—${newName}\r\n`);
}
function list(socket) {
  let userList = Object.values(clients).map(item=>item.name).join('\r\n');
  socket.write(`å½“å‰ç”¨æˆ·åˆ—è¡¨\r\n${userList}\r\n`);
}
server.listen(3000);
````

## ğŸŒ¹ğŸŒ¹ UDP
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ UDPæœåŠ¡å™¨
````javascript
let dgram = require('dgram');
let socket = dgram.createSocket('udp4');
socket.on('message',function(msg,rinfo){
    console.log(msg.toString());
    socket.send('ä½ å¥½',rinfo.port,rinfo.address)
});
socket.bind(41234,'localhost');
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ UDPå®¢æˆ·ç«¯
````javascript
let dgram = require('dgram');
let socket = dgram.createSocket('udp4');
socket.send('ç å³°',41234,'localhost',function(err,bytes){
    console.log('send');
});
socket.on('message',function(data){
    console.log(data.toString());
})
````
## ğŸŒ¹ğŸŒ¹ è½¯ä»¶/å·¥å…·
* putty https://www.putty.org/
* windowç”¨æˆ·è£… ç§‘æ¥ç½‘ç»œåˆ†æç³»ç»Ÿ http://www.colasoft.com.cn/
* macç”¨æˆ·è£… wireshark https://www.wireshark.org/download.html

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ telnet
````
FF FB 1F FF FB 20 FF FB 18 FF FB 27 FF FD 01 FF FB 03 FF FD 03
FF FB 1F window size
FF FB 20 terminal speed
FF FB 18 terminal type
FF FB 27 Telnet Environment Option
FF FD 01 echo
FF FB 03 suppress go ahead
FF FD 03 suppress go ahead
å¦‚æœä¸éœ€è¦é€™äº›, æ”¹ç”¨RAWæ¨¡å¼å°±å¯ä»¥äº†
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ curl

# ğŸŒ¹ http å’Œ tcp
## ğŸŒ¹ğŸŒ¹ åŸºç¡€çŸ¥è¯†
* é•¿é“¾æ¥
* ç®¡çº¿åŒ–
* URLå’ŒURI
* httpåè®®å’Œtpc

# ğŸŒ¹ HTTæ ¸å¿ƒæ¨¡å— todo 
## ğŸŒ¹ğŸŒ¹ HTTPæœåŠ¡å™¨ 
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ åˆ›å»ºhttpæœåŠ¡å™¨
###ğŸŒ¹ğŸŒ¹ğŸŒ¹ å¯åŠ¨httpæœåŠ¡å™¨
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ å…³é—­HTTPæœåŠ¡å™¨
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ ç›‘å¬æœåŠ¡å™¨é”™è¯¯
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ connection
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ setTimeout
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ è·å–å®¢æˆ·ç«¯è¯·æ±‚ä¿¡æ¯
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ urlæ¨¡å—
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ å‘é€æœåŠ¡å™¨å“åº”æµ
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ æ¨¡æ‹ŸhttpæœåŠ¡
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ è·å–å®¢æˆ·ç«¯è¯·æ±‚ä¿¡æ¯
## ğŸŒ¹ HTTPå®¢æˆ·ç«¯ todo
å‘å…¶ä»–ç½‘ç«™è¯·æ±‚æ•°æ®
## httpå¸¸è§çš„åŠŸèƒ½ action  
### 1 å¤šè¯­è¨€åˆ‡æ¢
### 2 å›¾ç‰‡é˜²ç›—é“¾
### 3 WEBæœåŠ¡å™¨
### 4 ä»£ç†æœåŠ¡å™¨
[æ­£å‘ä»£ç†å’Œåå‘ä»£ç†](https://www.cnblogs.com/Anker/p/6056540.html)
### 5 è™šæ‹Ÿä¸»æœº
### 6 User-Agent
## ğŸŒ¹ğŸŒ¹ querystringæ ¸å¿ƒæ¨¡å—
 
# httpå®ç°åŠŸèƒ½
## ğŸŒ¹ğŸŒ¹ crypto åŠ å¯†æ¨¡å—
## ğŸŒ¹ğŸŒ¹ cache ç¼“å­˜
* å¼ºåˆ¶ç¼“å­˜
* å¯¹æ¯”ç¼“å­˜
* æµè§ˆå™¨åˆ°ç¼“å­˜ç­–ç•¥
* httpåˆ°ç¼“å­˜ç­–ç•¥
  
### ç®€å•å®ç°
````javascript
// 304 æœåŠ¡ç«¯è®¾ç½® 
// ç¼“å­˜ç­–ç•¥:å¼ºåˆ¶ç¼“å­˜ 200 from memory from disk
// å¯¹æ¯”ç¼“å­˜ å…ˆæ¯”ä¸€ä¸‹åœ¨èµ°ç¼“å­˜

let http = require('http');
let path = require('path');
let fs = require('fs');
let { promisify} = require('util');
let stat = promisify(fs.stat);
// é™æ€æœåŠ¡å™¨
// localhost:3000/index.html?a=1
let url = require('url'); // ä¸“é—¨ç”¨æ¥å¤„ç†urlè·¯å¾„çš„
// http://username:password@hostname:port/pathname?query
let server = http.createServer(async function (req,res) {
  let { pathname,query} = url.parse(req.url,true); // å°±æ˜¯å°†queryè½¬åŒ–æˆå¯¹è±¡
  let readPath = path.join(__dirname, 'public', pathname);
  try {
  let statObj = await stat(readPath);
  // æ ¹å®¢æˆ·ç«¯è¯´ 10må†…åˆ«æ¥çƒ¦æˆ‘
  res.setHeader('Cache-Control','max-age=10');
  res.setHeader('Expires',new Date(Date.now()+10*1000).toGMTString());
  
    if (statObj.isDirectory()) {
      let p = path.join(readPath, 'index.html');
      await stat(p);
      // å¦‚æœå½“å‰ç›®å½•ä¸‹æœ‰htmlé‚£ä¹ˆå°±è¿”å›è¿™ä¸ªæ–‡ä»¶
      fs.createReadStream(p).pipe(res);
    } else {
      // æ˜¯æ–‡ä»¶ è¯»å–å¯¹åº”çš„æ–‡ä»¶ç›´æ¥è¿”å›å³å¯
      fs.createReadStream(readPath).pipe(res);
    }
  }catch(e){
    res.statusCode = 404;
    res.end(`Not found`);
  }
}).listen(3000);
````

### è¿›é˜¶å®ç° httpç¼“å­˜
````javascript
let http = require('http');
let path = require('path');
let fs = require('fs');
let { promisify} = require('util');
let stat = promisify(fs.stat);
let url = require('url'); 
// å…ˆè®¿é—®æœåŠ¡å™¨ æœåŠ¡å™¨å‘Šè¯‰ä»–10såˆ«æ¥çƒ¦æˆ‘
// è¿‡äº†10sä¼šç»§ç»­çƒ¦æˆ‘ï¼Œå…ˆçœ‹ä¸‹ä¸€ä¸‹æ˜¯å¦è¢«ä¿®æ”¹è¿‡ï¼Œå¦‚æœæ²¡æ”¹è¿‡è¿”å›304ï¼Œå®¢æˆ·ç«¯ä»ç¼“å­˜ä¸­è¯»å–ç»“æœ
let server = http.createServer(async function (req,res) {
  let { pathname,query} = url.parse(req.url,true);
  let readPath = path.join(__dirname, 'public', pathname);
  try {
  let statObj = await stat(readPath);
  res.setHeader('Cache-Control','no-cache');
    if (statObj.isDirectory()) {
      let p = path.join(readPath, 'index.html');
      let statObj = await stat(p);
      res.setHeader('Last-Modified', statObj.ctime.toGMTString());
      if (req.headers['if-modified-since'] === statObj.ctime.toGMTString()){
        res.statusCode = 304;
        res.end();
        return; // èµ°ç¼“å­˜
      }
      fs.createReadStream(p).pipe(res);
    } else {
      res.setHeader('Last-Modified', statObj.ctime.toGMTString());
      if (req.headers['if-modified-since'] === statObj.ctime.toGMTString()) {
        res.statusCode = 304;
        res.end();
        return; // èµ°ç¼“å­˜
      }
      fs.createReadStream(readPath).pipe(res);
    }
  }catch(e){
    res.statusCode = 404;
    res.end(`Not found`);
  }
}).listen(3000);

````
### ç»ˆæå®ç°
````javascript
let http = require('http');
let path = require('path');
let fs = require('fs');
let { promisify} = require('util');
let stat = promisify(fs.stat);
let url = require('url'); 
let crypto = require('crypto');
let server = http.createServer(async function (req,res) {
  let { pathname,query} = url.parse(req.url,true);
  let readPath = path.join(__dirname, 'public', pathname);
  try {
  let statObj = await stat(readPath);
  res.setHeader('Cache-Control','no-cache');
    if (statObj.isDirectory()) {
      let p = path.join(readPath, 'index.html');
      let statObj = await stat(p);
      
      // æˆ‘è¦æ ¹æ®æ–‡ä»¶å†…å®¹ ç”Ÿæˆä¸€ä¸ªmd5çš„æ‘˜è¦ æœ€è€—æ€§èƒ½ ï¼Œç»™å®ä½“åŠ ä¸€ä¸ªæ ‡ç­¾
      let rs = fs.createReadStream(p);
      let md5 = crypto.createHash('md5'); // ä¸èƒ½å†™å®Œç›¸åº”ä½“åœ¨å†™å¤´
      let arr = [];
      rs.on('data',function (data) {
        md5.update(data);
        arr.push(data);
      });
      rs.on('end',function () {
        let r = md5.digest('base64');
        res.setHeader('Etag', r);
        if (req.headers['if-none-match'] === r ){
          res.statusCode = 304;
          res.end();
          return;
        }
        res.end(Buffer.concat(arr));
      })
    } else {
      let rs = fs.createReadStream(readPath);
      let md5 = crypto.createHash('md5'); // ä¸èƒ½å†™å®Œç›¸åº”ä½“åœ¨å†™å¤´
      let arr = [];
      rs.on('data', function (data) {
        md5.update(data);
        arr.push(data);
      });
      rs.on('end', function () {
        let r = md5.digest('base64');
        res.setHeader('Etag', r);
        if (req.headers['if-none-match'] === r) {
          res.statusCode = 304;
          res.end();
          return;
        }
        res.end(Buffer.concat(arr));
      })
    }
  }catch(e){
    res.statusCode = 404;
    res.end(`Not found`);
  }
}).listen(3000);

// å¼ºåˆ¶ç¼“å­˜ Cache-Control Expires
// Last-Modified if-modified-since
// Etag if-none-match
````

## ğŸŒ¹ğŸŒ¹ yargs


## ğŸŒ¹ğŸŒ¹ proxy ä»£ç†
### ğŸŒ° åå‘çš„ä¾‹å­
````javascript
// æ­£å‘ä»£ç† ç§‘å­¦ä¸Šç½‘ åå‘ä»£ç† nginx
// æ­£å‘ä»£ç† æˆ‘ä»¬å®¢æˆ·ç«¯é…ç½®çš„
// åå‘ä»£ç† cdn å®ç°
// åå‘ä»£ç† webpack proxyTable å…¸å‹çš„åå‘ä»£ç†
// ngix å…¸å‹çš„åå‘ä»£ç† 
// è™šæ‹Ÿä¸»æœº www.zf1.cn  localhost:3001 
// è™šæ‹Ÿä¸»æœº www.zf2.cn  localhost:3002 
// http-proxy http-proxy-middleware

let http = require('http');
let httpProxy = require('http-proxy');
let proxyServer = httpProxy.createProxy();
let map = {
  'www.zf1.cn':'http://localhost:3001',
  'www.zf2.cn':'http://localhost:3002'
}
http.createServer(function (req,res) {
  let target = req.headers['host'];
  proxyServer.web(req,res,{
    target: map[target]
  }); // å°†ä»£ç†çš„ç½‘ç«™çš„ç»“æœ è¿”å›ç»™æˆ‘è‡ªå·±çš„æœåŠ¡
}).listen(80);
````
### ğŸŒ° æ­£å‘åˆ°æ —å­ è™šæ‹Ÿä¸»æœº
````javascript
// æˆ‘ä»¬å…ˆè®¿é—®è‡ªå·±çš„æœåŠ¡å™¨ 80
// æˆ‘ä»¬çš„æœåŠ¡å™¨å…¶å®æ˜¯æƒ³ä»£ç†åˆ°3001çš„æœåŠ¡å™¨ä¸Š
// 80 ä¸èƒ½ç›´æ¥è®¿é—®3001
// ä»£ç†æœåŠ¡å™¨å¯èƒ½éœ€è¦åŠ ä¸€ä¸ªå‡­è¯æ‰èƒ½è®¿é—®3001
// 80 æ‰èƒ½è®¿é—®3000

let http = require('http');
let proxy = require('http-proxy');
let httpProxy = proxy.createProxyServer();
http.createServer(function (req,res) {
  httpProxy.on('proxyReq', function (proxyReq, req, res, options) {
    proxyReq.setHeader('key', 'zfpx');
  });
  httpProxy.web(req,res,{
    target:'http://localhost:3001'
  });
}).listen(80);
// è¿™ä¸ªæ˜¯æˆ‘ä»¬çš„æœåŠ¡
````

## ğŸŒ¹ğŸŒ¹ gzip å‹ç¼©
### zlibåŒ…
````javascript
// æœåŠ¡ç«¯è¦å¯ç”¨å‹ç¼©
//Content-Encoding: gzip æœåŠ¡å™¨è¿”å›çš„å¤´ å‘Šè¯‰å®¢æˆ·ç«¯æˆ‘ç”¨gzipå‹ç¼©è¿‡äº†
//Accept-Encoding: gzip, deflate, br æµè§ˆå™¨å’ŒæœåŠ¡å™¨è¯´ æˆ‘æ”¯æŒè¿™å‡ ç§å‹ç¼©æ ¼å¼

let zlib = require('zlib'); // ä¸“é—¨åšå‹ç¼©çš„åŒ…
let fs = require('fs');
let path = require('path');
function gzip(filePath) {
  let transform = zlib.createGzip();
  fs.createReadStream(filePath).pipe(transform).pipe(fs.createWriteStream(filePath+'.gz'));
}
 gzip('1.txt');

function gunzip(filePath) {
  let transform = zlib.createGunzip();
  fs.createReadStream(filePath).pipe(transform).pipe(fs.createWriteStream(path.basename(filePath,'.gz')));
}
//gunzip('1.txt.gz');
````
### è‡ªå·±å®ç°ä¸€ä¸ªhttpå‹ç¼©
````javascript
let http = require('http');
let fs = require('fs');
let path = require('path');
let zlib = require('zlib');
http.createServer(function (req,res) {
  if(req.url === '/download'){
    res.setHeader('Content-Disposition', 'attachment' )
    return fs.createReadStream(path.join(__dirname, '1.html')).pipe(res);
  }
  let rule = req.headers['accept-encoding'];
  if(rule){
    if(rule.match(/\bgzip\b/)){
      res.setHeader('Content-Encoding','gzip');
      fs.createReadStream(path.join(__dirname, '1.html'))
      .pipe(zlib.createGzip())
      .pipe(res);
    } else if (rule.match(/\bdeflate\b/)){
      res.setHeader('Content-Encoding', 'deflate');
      fs.createReadStream(path.join(__dirname, '1.html'))
        .pipe(zlib.createDeflate())
        .pipe(res);
    }else{
      fs.createReadStream(path.join(__dirname, '1.html')).pipe(res);
    }
  }else{
    fs.createReadStream(path.join(__dirname, '1.html')).pipe(res);
  }
}).listen(3000);
````

## ğŸŒ¹ğŸŒ¹ safe é˜²ç›—é“¾
````javascript
let http =  require('http');
let fs = require('fs');
let url = require('url');
let path = require('path');
// è¿™æ˜¯ç™¾åº¦çš„æœåŠ¡å™¨
let whiteList = ['www.zf1.cn:3000'];
let server = http.createServer(function (req,res) {
  let { pathname } = url.parse(req.url);
  let realPath = path.join(__dirname,pathname);
  fs.stat(realPath,function(err,statObj) {
    if(err){
      res.statusCode = 404;
      res.end();
    }else{
      let referer = req.headers['referer'] || req.headers['referred'];
      if(referer){
        let current = req.headers['host'] // ä»£è¡¨çš„æ˜¯å½“å‰å›¾ç‰‡çš„åœ°å€
        referer = url.parse(referer).host// å¼•ç”¨å›¾ç‰‡çš„ç½‘å€
        if (current === referer || whiteList.includes(referer)){
          fs.createReadStream(realPath).pipe(res);
        }else{
          fs.createReadStream(path.join(__dirname,'images/2.jpg')).pipe(res);
        }
      }else{
        fs.createReadStream(realPath).pipe(res);
      }
    }
  })
}).listen(3000);
````

## ğŸŒ¹ğŸŒ¹ language å¤šè¯­è¨€
````javascript
// Accept-Language: zh-CN,zh;q=0.9
// ç‰¹ç‚¹æ˜¯å¤šä¸ªè¯­è¨€ç”¨ , åˆ†å‰² æƒé‡ç”¨=åˆ†å‰² æ²¡æœ‰é»˜è®¤æƒé‡ä¸º1
let langs = {
  en:  'hello world',
  'zh-CN':'ä½ å¥½ä¸–ç•Œ',
  zh:'ä½ å¥½',
  ja: 'ã“ã‚“ã«ã¡ã¯ã€ä¸–ç•Œ'
}
// 
let defualtLanguage = 'en'
// å¤šè¯­è¨€æ–¹æ¡ˆ  æœåŠ¡ç«¯æ¥åš (æµè§ˆå™¨ä¼šå‘ä¸€ä¸ªå¤´) å‰ç«¯æ¥åš  é€šè¿‡urlå®ç°å¤šè¯­è¨€
let http = require('http');
http.createServer(function (req,res) {
    let lan = req.headers['accept-language'];
    //[[zh,q=0.9],[zh-CN]] =>[{name:'zh-CN',q=1},{name:'zh',q:0.9}]
    if(lan){
      lan = lan.split(',');
      lan = lan.map(l=>{
        let [name,q] = l.split(';');
        q = q?Number(q.split('=')[1]):1 
        return {name,q}
      }).sort((a,b)=>b.q-a.q); // æ’å‡º æƒé‡æ•°ç»„

      for(let i = 0 ;i <lan.length;i++){
        // å°†æ¯ä¸ªäººçš„åå­— å–å‡ºæ¥
        let name= lan[i].name;
        if(langs[name]){ //å»è¯­è¨€åŒ…æŸ¥æ‰¾ æŸ¥æ‰¾åˆ°å°±è¿”å›
          res.end(langs[name]);
          return;
        }
      }
      res.end(langs[defualtLanguage]); // é»˜è®¤è¯­è¨€
    }else{
      res.end(langs[defualtLanguage]); // é»˜è®¤è¯­è¨€
    }
}).listen(3000);
````

# è‡ªå·±å®ç°ä¸€ä¸ªhttp-serveråŒ…
````javascript
// è¦å®ç°æ‰“å¼€ç½‘é¡µåå¯ä»¥å°†ç›®å½•ä¸‹çš„å†…å®¹å±•ç¤ºç»™ç”¨æˆ·,æµ·å¯ä»¥è¿›è¡Œå¯¹åº”çš„ç‚¹å‡»æ“ä½œ
// ç¼“å­˜ï¼Œgzipå‹ç¼© ï¼Œ èŒƒå›´è¯·æ±‚....
// æç¤ºç”¨æˆ·çš„å‘½ä»¤
// å‘åŒ…
let http = require('http');

let util = require('util');
let url = require('url');
let zlib = require('zlib');
let fs = require('fs');
let path = require('path');
//ç¬¬ä¸‰æ–¹
let ejs = require('ejs'); // æ¨¡æ¿å¼•æ“
let template = fs.readFileSync(path.join(__dirname, 'template.html'), 'utf8');

let chalk = require('chalk'); // ç²‰ç¬”
let mime = require('mime');   // ç±»å‹æ¨¡å—
// éœ€è¦ å½“ä½ ç”µè„‘ä¸Šæœ‰ ç¯å¢ƒå˜é‡ DEBUG=helloæ—¶ æ‰ä¼šè¾“å‡ºå¯¹åº”çš„å†…å®¹
let debug = require('debug')('hello'); // è°ƒè¯•æ¨¡å—
// åœ¨å†™ä»£ç çš„æ—¶å€™ å¯èƒ½ä¼šæ‰“å°å‡ºå¾ˆå¤šæ—¥å¿— å‘åŒ…åä¸å¸Œæœ›æ—¥å¿—è¢«æ‰“å°
let config = require('./config');

let stat = util.promisify(fs.stat);
let readdir = util.promisify(fs.readdir);
class Server {
  constructor(command) { // ç”¨ç”¨æˆ·åœ¨å‘½ä»¤è¡Œç§è¾“å…¥çš„å†…å®¹è¿›è¡Œæ˜¾ç¤º
    this.config = { ...config, ...command};
    this.template = template;
  }
  async handleRequest(req, res) {
    let { dir } = this.config; // éœ€è¦å°†è¯·æ±‚çš„è·¯å¾„å’Œdiræ‹¼æ¥åœ¨ä¸€èµ·
    // http://localhost:3000/index.html
    let { pathname } = url.parse(req.url);
    if (pathname === '/favicon.ico') return res.end();
    let p = path.join(dir, pathname);
    try {
      // åˆ¤æ–­å½“å‰è·¯å¾„æ˜¯æ–‡ä»¶ è¿˜æ˜¯æ–‡ä»¶å¤¹
      let statObj = await stat(p);
      if (statObj.isDirectory()) {
        // è¯»å–å½“å‰è®¿é—®çš„ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹ readdir æ•°ç»„ æŠŠæ•°ç»„æ¸²æŸ“å›é¡µé¢
        res.setHeader('Content-Type', 'text/html;charset=utf8')
        let dirs = await readdir(p);
        dirs = dirs.map(item=>({
          name:item,
          // å› ä¸ºç‚¹å‡»ç¬¬äºŒå±‚æ—¶ éœ€è¦å¸¦ä¸Šç¬¬ä¸€å±‚çš„è·¯å¾„ï¼Œæ‰€æœ‰æ‹¼æ¥ä¸Šå°±okäº†
          href:path.join(pathname,item)
        }))
        let str = ejs.render(this.template, {
          name: `Index of ${pathname}`,
          arr: dirs
        });
        res.end(str);
      } else {
        this.sendFile(req, res, statObj, p);
      }
    } catch (e) {
      debug(e); // å‘é€é”™è¯¯
      this.sendError(req, res);
    }
  }
  /**
   * æ­¤æ–¹æ³•ç”¨æ¥å¤„ç†ç”¨æˆ·ç¼“å­˜
   */
  cache(req, res, statObj, p){
    res.setHeader('Cache-Control','no-cache');
    res.setHeader('Expires', new Date(Date.now() + 10 * 1000).getTime());
    // æ¯”è¾ƒetag ctime+size æ¯”è¾ƒlast-modified ctime
    // æœåŠ¡ç«¯æƒ³è¦è®¾ç½®çš„
    let etag = statObj.ctime.getTime()+'-'+statObj.size;
    let lastModified = statObj.ctime.getTime();
    // æŠŠè¿™ä¸¤ä¸ªå‚æ•°è®¾ç½®ç»™å®¢æˆ·ç«¯
    res.setHeader('Etag', etag);
    res.setHeader('Last-Modified', lastModified);
    // å®¢æˆ·ç«¯æŠŠä¸Šæ¬¡è®¾ç½®çš„å¸¦è¿‡æ¥çš„
    let ifNoneMatch = req.headers['if-none-match'];
    let ifModifiedSince = req.headers['if-modified-since'];
    // æœ‰å…¶ä¸­ä»»ä½•ä¸€ä¸ªä¸ç”Ÿæ•ˆå°±ä¸ç”Ÿæ•ˆ
    if (etag !== ifNoneMatch && lastModified !== ifModifiedSince){
      return false
    }
    return true;
  }
  gzip(req, res, statObj, p){
    let encoding = req.headers['accept-encoding'];
    if(encoding){
      if(encoding.match(/\bgzip\b/)){
        res.setHeader('Content-Encoding','gzip')
        return zlib.createGzip();
      }
      if (encoding.match(/\bdeflate\b/)) {
        res.setHeader('Content-Encoding', 'deflate')
        return zlib.createDeflate();
      }
      return false;
    }else{
      return false
    }
  }
  // èŒƒå›´è¯·æ±‚
  range(req, res, statObj, p){
    let range  = req.headers['range'];
    if(range){
    let [,start,end] = range.match(/bytes=(\d*)-(\d*)/);
    start = start? Number(start):0;
    end = end? Number(end):statObj.size - 1;
      res.statusCode = 206;
      res.setHeader('Content-Range', `bytes ${start}-${end}/${statObj.size - 1}`);
      fs.createReadStream(p,{start,end}).pipe(res);
    }else{
      return false;
    }
  }
  sendFile(req, res, statObj, p) {
    // è®¾ç½®ç¼“å­˜ï¼Œå¦‚æœæ–‡ä»¶ä»¥åŠæ‰“å¼€è¿‡äº† è¦ä¸‹ä¸€æ¬¡å¤šå°‘ç§’å†…ä¸è¦å†æ¬¡è®¿é—®äº†
    // ä¸‹æ¬¡å†è®¿é—®æœåŠ¡å™¨çš„æ—¶å€™ è¦ä½¿ç”¨å¯¹æ¯”ç¼“å­˜
    if (this.cache(req, res, statObj, p)){
      res.statusCode = 304;
      return res.end();
    }
    if (this.range(req, res, statObj, p)) return
    res.setHeader('Content-Type', mime.getType(p) + ';charset=utf8');
    let transform = this.gzip(req, res, statObj, p)
    if (transform){ // è¿”å›ä¸€ä¸ªå‹ç¼©åçš„å‹ç¼©æµ
      return fs.createReadStream(p).pipe(transform).pipe(res);
    }
    fs.createReadStream(p).pipe(res);
  }
  sendError(req, res) {
    res.statusCode = 404;
    res.end(`Not found`);
    this.start();
  }
  start() {
    let server = http.createServer(this.handleRequest.bind(this));
    server.listen(this.config.port, this.config.host, () => {
      console.log(`server start http://${this.config.host}:${chalk.green(this.config.port)}`);
    });
  }
}
module.exports = Server;
````

# cookie-sessionåˆ°å®ç°

 
