

# ğŸŒ¹ nodeJSè¶…é•¿æ€»ç»“ 1
## ğŸŒ¹ğŸŒ¹ ğŸ± ğŸ¶ ğŸ­ ğŸ˜ ğŸ³ âœˆï¸ ğŸš„ ğŸš— âš½ï¸ ğŸ’† ğŸ¥š ğŸ§’ ğŸŒ¹ ğŸ¯ â¡ï¸
æŒç»­æ›´æ–°ã€‚ã€‚ã€‚ã€‚å¾ˆå¤šè¿˜æ²¡å†™å‘¢

---

# ğŸŒ¹ æ­å»ºnodeå¼€å‘ç¯å¢ƒ
---
## ğŸŒ¹ğŸŒ¹ 1ã€å…ˆå®‰è£…ä¸€ä¸ª nvm
> `curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.25.2/install.sh | bash`

## ğŸŒ¹ğŸŒ¹ 2ã€å®‰è£…node
easy todo
## ğŸŒ¹ğŸŒ¹ 3ã€npmä»‹ç»
å®‰è£…
- æœ¬åœ°å®‰è£…
- å…¨å±€å®‰è£… (åœ¨å‘½ä»¤è¡Œä½¿ç”¨)
```
npm install http-server -g ç”Ÿæˆé™æ€ç›®å½• 
npm install nrm -g åˆ‡æ¢æº
npm install yarn -g é™¤äº†npm è¿˜æœ‰å®‰åŒ…çš„æ–¹å¼ yarn
npm uninstall yarn -g
```

å®ç°å…¨å±€åŒ…
- æ·»åŠ bin
- æ·»åŠ #! /usr/bin/env node
- npm link  

å‘åŒ…  
- åˆ‡æ¢åˆ°å®˜æ–¹æº
- npm addUser
- å¡«ä¸Šç”¨æˆ·åé‚®ç®± å¯†ç 
- npm publish

# ğŸŒ¹ nodeå¸¸è§æ¦‚å¿µ
---
## ğŸŒ¹ğŸŒ¹ è¿›ç¨‹å’Œçº¿ç¨‹
todo
## ğŸŒ¹ğŸŒ¹ å¼‚æ­¥å’ŒåŒæ­¥
todo
## ğŸŒ¹ğŸŒ¹ é˜»å¡å’Œéé˜»å¡
todo
## ğŸŒ¹ğŸŒ¹ é˜Ÿåˆ—å’Œæ ˆ ï¼ˆå †ï¼‰
todo
## ğŸŒ¹ğŸŒ¹ å®ä»»åŠ¡å¾®ä»»åŠ¡
macrotask å’Œ microtask è¡¨ç¤ºå¼‚æ­¥ä»»åŠ¡çš„ä¸¤ç§åˆ†ç±»ã€‚åœ¨æŒ‚èµ·ä»»åŠ¡æ—¶ï¼ŒJS å¼•æ“ä¼šå°†æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§ç±»åˆ«åˆ†åˆ°è¿™ä¸¤ä¸ªé˜Ÿåˆ—ä¸­ï¼Œé¦–å…ˆåœ¨ macrotask çš„é˜Ÿåˆ—ï¼ˆè¿™ä¸ªé˜Ÿåˆ—ä¹Ÿè¢«å«åš task queueï¼‰ä¸­å–å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæ¯•åå–å‡º microtask é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡é¡ºåºæ‰§è¡Œï¼›ä¹‹åå†å– macrotask ä»»åŠ¡ï¼Œå‘¨è€Œå¤å§‹ï¼Œç›´è‡³ä¸¤ä¸ªé˜Ÿåˆ—çš„ä»»åŠ¡éƒ½å–å®Œã€‚

ä¸¤ä¸ªç±»åˆ«çš„å…·ä½“åˆ†ç±»å¦‚ä¸‹ï¼š

macro-task: scriptï¼ˆæ•´ä½“ä»£ç ï¼‰, setTimeout, setInterval, setImmediate, I/O, UI rendering
micro-task: process.nextTick, Promisesï¼ˆè¿™é‡ŒæŒ‡æµè§ˆå™¨å®ç°çš„åŸç”Ÿ Promiseï¼‰,Object.observe, MutationObserver

# ğŸŒ¹ nodeçš„æ¨¡å—
---
## ğŸŒ¹ğŸŒ¹ 1ã€å…¨å±€æ¨¡å—
ä¸éœ€è¦å¼•å…¥ æ‹¿æ¥å³ç”¨ `console.log(global)`å¾—åˆ°æ ¸å¿ƒå¯¹è±¡
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ console
> nodeä¸­console.log(this) æŒ‡å‘çš„æ˜¯ module.exports, nodeå°†`this != global this=module.exports`
> nodeä¸­çš„å…¨å±€å¯¹è±¡æ˜¯console.log(global) 

````javascript
console.log(this); // nodeä¸ºäº†å®ç°æ¨¡å—åŒ– å¤–è¾¹æœ‰ä¸€ä¸ªé—­åŒ…
// å‡½æ•°å¤–è¾¹æŠŠthisæ›´æ”¹æ‰äº† this != global this=module.exports

console.log(global); // å¯ä»¥é€šè¿‡ç›´æ¥å–å€¼çš„æ–¹å¼æ‹¿åˆ°ç»“æœ ä¸éœ€è¦å£°æ˜

// console è¾“å‡º
console.log('log');
console.info('info'); // æ ‡å‡†è¾“å‡º 1
process.stdout.write('hello')

console.error('é”™è¯¯');
console.warn('è­¦å‘Š'); // é”™è¯¯è¾“å‡º 2 
process.stderr.write('error');

// ç›‘å¬ç”¨æˆ·çš„è¾“å…¥
process.stdin.on('data',function(data){ // 0 
    console.log(data)
});

// ä»£å·éƒ½æ˜¯æ–‡ä»¶æè¿°ç¬¦
// console.assert(1===1===1,'å‡ºé”™äº†'); // nodeä¸­æœ‰ä¸€ä¸ªç°æˆçš„æ¨¡å— assert
console.time('start');
Promise.resolve().then(()=>{
    console.timeEnd('start');
})
// console.dir(global,{showHidden:true}); // æ˜¾ç¤ºéšè—çš„ä¿¡æ¯

````
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ process è¿›ç¨‹
  `console.log(process)`å¾—åˆ°æ•´ä¸ªprocesså¯¹è±¡
  
```` javascript
console.log(global)
console.log(process);
console.log(process.platform === 'win32');
console.log(process.argv); //è¿è¡Œçš„å‚æ•° å‰ä¸¤ä¸ªä¸ç”¨ç®¡
let argvs = process.argv.slice(2);
//  æŠŠargvså˜æˆå¯¹è±¡ {color:red,port:3000}
// [--color,'red','--port',3000];
let obj = {}
argvs.forEach((element, index) => {
    if (element.includes('--')) {
        obj[element.slice(2)] = argvs[index + 1]
    }
});
console.log(obj); // è§£æç”¨æˆ·ä¼ é€’çš„å‚æ•°


console.log(process.env.DEBUG); // ç¯å¢ƒ å˜é‡
if (process.env.NODE_ENV === 'development') {
    console.log('å½“å‰æ˜¯å¼€å‘ç¯å¢ƒ ')
} else {
    console.log('ä¸Šçº¿ç¯å¢ƒ ')
}
// console.log(process.pid);  
// åœ¨å“ªé‡Œè¿è¡Œçš„
console.log(process.chdir('1.node')); //æ”¹å˜å·¥ä½œç›®å½•
console.log(process.cwd()); // å½“å‰å·¥ä½œç›®å½• è¯»å–æ–‡ä»¶é»˜è®¤ä»è·Ÿæ–‡ä»¶å¤¹ä¸‹è¯»å– (æ³¨æ„çš„ç‚¹)
//  console.log(process.nextTick());
// nextTick > then

// process.kill(20352); // æ€æ­»è¿›ç¨‹
// process.exit(2); // é€€å‡ºè¿›ç¨‹ï¼Œé€€å‡ºè‡ªå·±

// processè¿›ç¨‹
//   argv æ‰§è¡Œå‚æ•°
//   env ç¯å¢ƒå˜é‡
//   pid å½“å‰è¿›ç¨‹id
//   chdir/cwd chdirå¯ä»¥æ”¹å˜æ‰§è¡Œçš„å·¥ä½œç›®å½• cwdä»£è¡¨çš„æ—¶å½“å‰ç›®å½•
//   nextTick ä¸‹ä¸€é˜Ÿåˆ—
//   stdout
//   stderr
//   stdin
//   kill
//   exit 

Promise.resolve().then(() => {
    console.log('then')
})
// 
process.nextTick(() => {
    console.log('nextTick')
});

// nextTick ç­‰æ‰€æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œç©ç«‹åˆ»æ‰§è¡Œçš„
class A {
    constructor() {
        this.arr = [];
        console.log(this.arr); // []
        process.nextTick(()=>{ 
            console.log(this.arr); // ['123','456']
        })
    }
    add(val) {
        this.arr.push(val);
    }
}
let a = new A();
a.add('123');
a.add('456');

// nodeçš„äº‹ä»¶ç¯

// Buffer ç¼“å­˜åŒº äºŒè¿›åˆ¶ /  16è¿›åˆ¶
// clearImmediate / setImmediate nodeå®ç°çš„

````
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ _filenane å’Œ _dirname
ä¸æ˜¯globalä¸Šçš„å±æ€§
_filenaneå½“å‰æ‰§è¡Œæ–‡ä»¶çš„ç»å¯¹è·¯å¾„  
_dirnameå½“å‰æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹çš„ç»å¯¹è·¯å¾„
## ğŸŒ¹ğŸŒ¹ 2ã€æ ¸å¿ƒæ¨¡å—
ä¸éœ€è¦å®‰è£…ï¼Œå¼•å…¥å³ç”¨
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ path
ä¸“é—¨ç”¨æ¥å¤„ç†è·¯å¾„ åç¼€å è·¯å¾„çš„ä¿¡æ¯
1ã€path.join([...paths])
````javascript  
let path = require('path');
path.join('/foo', 'bar', 'baz/asdf', 'quux', '..');
// è¿”å›: '/foo/bar/baz/asdf'
path.join('foo', {}, 'bar');
// æŠ›å‡º 'TypeError: Path must be a string. Received {}'
console.log(path.dirname(__dirname)); // çˆ¶è·¯å¾„
console.log(__dirname);
````
2ã€path.resolve()
path.resolve() æ–¹æ³•ä¼šæŠŠä¸€ä¸ªè·¯å¾„æˆ–è·¯å¾„ç‰‡æ®µçš„åºåˆ—è§£æä¸ºä¸€ä¸ªç»å¯¹è·¯å¾„ã€‚
ç»™å®šçš„è·¯å¾„çš„åºåˆ—æ˜¯ä»å³å¾€å·¦è¢«å¤„ç†çš„ï¼Œåé¢æ¯ä¸ª path è¢«ä¾æ¬¡è§£æï¼Œç›´åˆ°æ„é€ å®Œæˆä¸€ä¸ªç»å¯¹è·¯å¾„
````javascript  
path.resolve('/foo/bar', './baz');
// è¿”å›: '/foo/bar/baz'

path.resolve('/foo/bar', '/tmp/file/');
// è¿”å›: '/tmp/file'

path.resolve('wwwroot', 'static_files/png/', '../gif/image.gif');
// å¦‚æœå½“å‰å·¥ä½œç›®å½•ä¸º /home/myself/nodeï¼Œ
// åˆ™è¿”å› '/home/myself/node/wwwroot/static_files/gif/image.gif'
````
3ã€path.basename()
path.basename() æ–¹æ³•è¿”å›ä¸€ä¸ª path çš„æœ€åä¸€éƒ¨åˆ†ï¼Œç±»ä¼¼äº Unix ä¸­çš„ basename å‘½ä»¤ã€‚ æ²¡æœ‰å°¾éƒ¨æ–‡ä»¶åˆ†éš”ç¬¦
````javascript  
path.basename('/foo/bar/baz/asdf/quux.html');
// è¿”å›: 'quux.html'

path.basename('/foo/bar/baz/asdf/quux.html', '.html');
// è¿”å›: 'quux'
````
4ã€path.extname()
path.extname() æ–¹æ³•è¿”å› path çš„æ‰©å±•åï¼Œå³ä» path çš„æœ€åä¸€éƒ¨åˆ†ä¸­çš„æœ€åä¸€ä¸ª .ï¼ˆå¥å·ï¼‰å­—ç¬¦åˆ°å­—ç¬¦ä¸²ç»“æŸã€‚ å¦‚æœ path çš„æœ€åä¸€éƒ¨åˆ†æ²¡æœ‰ . æˆ– path çš„æ–‡ä»¶åï¼ˆè§ path.basename()ï¼‰çš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯ .ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ã€‚
````javascript
path.extname('index.html');
// è¿”å›: '.html'

path.extname('index.coffee.md');
// è¿”å›: '.md'

path.extname('index.');
// è¿”å›: '.'

path.extname('index');
// è¿”å›: ''

path.extname('.index');
// è¿”å›: ''
````
4ã€path.dirname()
path.dirname() æ–¹æ³•è¿”å›ä¸€ä¸ª path çš„ç›®å½•åï¼Œç±»ä¼¼äº Unix ä¸­çš„ dirname å‘½ä»¤
````javascript
path.dirname('/foo/bar/baz/asdf/quux');
// è¿”å›: '/foo/bar/baz/asdf'
console.log(__dirname);
````
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ vm æ ¸å¿ƒæ¨¡å—
vm æ¨¡å—æä¾›äº†ä¸€ç³»åˆ— API ç”¨äºåœ¨ V8 è™šæ‹Ÿæœºç¯å¢ƒä¸­ç¼–è¯‘å’Œè¿è¡Œä»£ç ã€‚
JavaScript ä»£ç å¯ä»¥è¢«ç¼–è¯‘å¹¶ç«‹å³è¿è¡Œï¼Œæˆ–ç¼–è¯‘ã€ä¿å­˜ç„¶åå†è¿è¡Œ.

è®©å­—ç¬¦ä¸²æ‰§è¡Œçš„æ–¹æ³•:
````javascript
// 1)è®©å­—ç¬¦ä¸²æ‰§è¡Œ
let a = 100; // ä¸å¹²å‡€çš„æ‰§è¡Œ
eval('console.log(a)'); // æ²™ç®±

// 2)è®©å­—ç¬¦ä¸²æ‰§è¡Œ
let str = 'console.log(a)'
let fn = new Function('a',str); // æ¨¡æ¿å¼•æ“
fn(1);

// 3) nodeæ‰§è¡Œå­—ç¬¦ä¸²
let vm = require('vm');
let str = 'console.log(a)';
vm.runInThisContext(str);

// runInThisContext fs.readFileSync fs.existsSync path.join resolve extname basename
````
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ net
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ http
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ fs
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ http
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ querystring
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ events
````javascript
const EventEmitter = require('events');

class MyEmitter extends EventEmitter {}

const myEmitter = new MyEmitter();
myEmitter.on('event', () => {
  console.log('è§¦å‘äº†ä¸€ä¸ªäº‹ä»¶ï¼');
});
myEmitter.emit('event');
````
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ util 
`const util = require('util');`

## ğŸŒ¹ğŸŒ¹ 3ã€ç¬¬ä¸‰æ–¹æ¨¡å—
éœ€è¦å®‰è£…å¼•å…¥
* express
* koa
* [mime](https://www.npmjs.com/package/mime) æ¨¡å—æ˜¯ä¸€ä¸ªåŸºäºmime-dbçš„MIMEç±»å‹è§£æåŠå¤„ç†ç¨‹åºã€‚
  

# ğŸŒ¹ EventLoop
---

````javascript
setTimeout(() => {
    console.log('timeout1');
    process.nextTick(()=>{ //åœ¨å½“å‰æ‰§è¡Œ
        console.log('nextTick1');
    })
}, 1000);
// è™½ç„¶éƒ½å†™1000æ¯«ç§’ æ˜¯æœ‰è¯¯å·®
process.nextTick(function(){ // nextTickæ‰§è¡Œçš„æ—¶å€™ç”¨äº†0.8ms
    setTimeout(() => {
        console.log('timeout2'); 
    }, 1000); // 1000.02ms
    console.log('nextTick2');
})
// nextTick2 timeout1 timeout2 nextTick1
````


````javascript
setTimeout(function(){
    console.log('setTimeout1')
    Promise.resolve().then(()=>{ // å¾®
        console.log('then1')
    })
},1000)

// å¾®ä»»åŠ¡
Promise.resolve().then(function(){
    console.log('then2')
    setTimeout(function(){ // å®
        console.log('setTimeout2')
    },1000)
})
// nodeä¸­ï¼šthen2 setTimeout1 setTimeout2 then1
// æµè§ˆå™¨ä¸­ï¼šthen2 setTimeout1 then1 setTimeout2 
// setTimeoutæ—¶é—´è®¾ä¸º0ä¼šå‡ºç°ä¸¤ç§æƒ…å†µ ç”±äºè®¾å¤‡æ€§èƒ½å¼•èµ·çš„å·®è·
````
ä¸ç¡®å®šçš„ï¼š
````javascript
setImmediate(function(){
    console.log('setImmediate')
});
setTimeout(function(){
    console.log('setTimeout')
},0); // ->4
````
ç¡®å®šçš„ï¼š ioæ“ä½œåå…ˆæ‰§è¡Œcheck
````javascript 
//  
let fs = require('fs');
fs.readFile('./gitignore',function(){ // ioçš„ä¸‹ä¸€ä¸ªäº‹ä»¶é˜Ÿåˆ—æ˜¯checké˜¶æ®µ
    setImmediate(function(){
        console.log('setImmediate')
    });
    setTimeout(function(){
        console.log('setTimeout')
    },0); // ->4
})
// 
let fs = require('fs');
setTimeout(function(){
    Promise.resolve().then(()=>{
        console.log('then2');
    })
},0);
Promise.resolve().then(()=>{
    console.log('then1');
});
fs.readFile('./gitigore',function(){
    process.nextTick(function(){
        console.log('nextTick')
    })
    setImmediate(()=>{
        console.log('setImmediate')
    });
});
````

# ğŸŒ¹ æ¨¡å—
---
## ğŸŒ¹ğŸŒ¹ ä»‹ç»
- æ–¹ä¾¿ç»´æŠ¤ æ–¹ä¾¿ç®¡ç† ä»£ç ç»Ÿä¸€
- å‰ç«¯æ¨¡å— (ç½‘ç»œçš„é—®é¢˜)
- æ¨¡å—åŠ è½½æ˜¯åŒæ­¥çš„
- cmd seajs amd requirejs umd ç»Ÿä¸€æ¨¡å—è§„èŒƒ
- è‡ªå·±å®ç°æ¨¡å—åŒ– let obj = {} å•ä¾‹
- é—­åŒ… let fn = (function(){return {}});
- esModule es6çš„æ¨¡å—åŒ– 
- commonjsè§„èŒƒ node (åŸç† é—­åŒ…çš„å½¢å¼)
    - æŠŠæ–‡ä»¶è¯»å‡ºæ¥,å¥—ä¸€ä¸ªå‡½æ•°ï¼Œå®‰è£…è§„èŒƒæ¥å†™ï¼ŒæŠŠéœ€è¦å¯¼å‡ºçš„ç»“æœæ”¾åˆ°æŒ‡å®šçš„åœ°æ–¹
    - åˆ«äººå¯ä»¥æ‹¿åˆ°è¿™ä¸ªå‡½æ•°æ‰§è¡Œï¼Œæ‹¿åˆ°ä½ å¯¼å‡ºçš„ä¸œè¥¿è€Œå·²
    - å¼•ç”¨çš„è¿‡ç¨‹æ˜¯åŒæ­¥çš„

- nodeæ¨¡å—åˆ†ç±» æ ¸å¿ƒæ¨¡å—/å†…ç½®æ¨¡å— ã€ ç¬¬ä¸‰æ–¹æ¨¡å— bluebird ã€æ–‡ä»¶æ¨¡å—ã€è‡ªå·±å†™çš„æ¨¡å—  (fs,path);

## ğŸŒ¹ğŸŒ¹ å®ç°commonè§„èŒƒ
- å¦‚ä½•å¯¼å…¥æ¨¡å— require  
- å¯¼å‡ºæ¨¡å—  module.exports =  this
- å¦‚ä½•å®šä¹‰æ¨¡å—1ä¸ªæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªæ¨¡å—
```javascript

* æ¨¡å—çš„åŠ è½½é¡ºåº
  
````javascript   
console.log(module.paths);
// å½“å‰ç›®å½•ä¸‹æ‰¾ node_modulesï¼Œç„¶åé€çº§ç½‘ä¸Šæ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æ ¹ç›®å½• node_modules
````
* `exports` å’Œ `module.exports`

````javascript
// a.js å¯¼å‡º
let a = 1
let b = 2
exports.a = 1 //å•ä¸ªå¯¼å‡º
// module.exports = {a,b} //å¤šä¸ªå¯¼å‡º

// b.js å¯¼å…¥
let s = requiue('./a')
console.log(s)
````
nodeä¸­é€šè¿‡requireå®ç°æ¨¡å—åŠ è½½
> åŒæ­¥çš„
> 1ã€æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶
> 2ã€è¯»å–æ­¤æ–‡ä»¶å†…å®¹
> 3ã€æŠŠä»–å°è£…åœ¨ä¸€ä¸ªå‡½æ•°å…§æ‰§è¡Œ`(function (exports,require,module,filename,dirname){ // æ‰§è¡Œä»£ç  })`
>  exports: å½“å‰æ¨¡å—çš„å¯¼å‡ºå¯¹è±¡
>  require: requiueæ–¹æ³•
>  module: å½“å‰æ¨¡å—
>  filename: å½“å‰æ¨¡å—æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
>  dirname:å½“å‰æ¨¡å—æ–‡ä»¶å¤¹çš„ç»å¯¹è·¯å¾„
> 4ã€æ‰§è¡ŒåæŠŠæ¨¡å—çš„module.exportsèµ‹å€¼ç»™requieçš„å˜é‡


`console.log(module)` æ‰“å°å½“å‰æ¨¡å—ä¿¡æ¯ï¼š

````
Module {
  id: '.', // æ¨¡å—idæ°¸è¿œä¸ºå½“å‰æ¨¡å— å…¥å£æ¨¡å—
  exports: {}, // å¯¼å‡ºå¯¹è±¡ é»˜è®¤{}
  parent: null,  // çˆ¶æ¨¡å— æ­¤æ¨¡å—æ˜¯æœ‰å“ªä¸ªæ¨¡å—åŠ è½½çš„
  filename: // å½“å‰æ¨¡å—çš„è§‰å¾—è·¯å¾„
   '/Users/bingyang/Documents/zhufeng/201805coding/tempCodeRunnerFile.js',
  loaded: false, // æ˜¯å¦åŠ è½½å®Œæˆ
  children: [], //æ­¤æ¨¡å—åŠ è½½äº†é‚£äº›æ¨¡å—
  paths: // æ¨¡å—åŠ è½½æŸ¥æ‰¾è·¯å¾„
   [ '/Users/bingyang/Documents/zhufeng/201805coding/node_modules',
     '/Users/bingyang/Documents/zhufeng/node_modules',
     '/Users/bingyang/Documents/node_modules',
     '/Users/bingyang/node_modules',
     '/Users/node_modules',
     '/node_modules' ] 
}
````
å¤šæ¬¡åŠ è½½æ¨¡å—åªä¼šæ‰§è¡Œä¸€æ¬¡ æœ‰ç¼“å­˜

````javascript
// a.js
let a = 1
console.log('åŠ è½½æ¨¡å—a') 
module.exports = a
// b.js
var a = requiue('./a');
var a = requiue('./a'); // å¯¼å…¥ä¸¤æ¬¡åªä¼šæ‰§è¡Œä¸€æ¬¡
````

è‡ªå·±å®ç°ä¸€ä¸ªrequiueåŠ è½½å‡½æ•°

````javascript
let path = require('path');
let fs = require('fs');
let vm = require('vm');
function Module(filename) {
  this.loaded = false;
  this.filename = filename; // æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
  this.exports = {} // æ¨¡å—å¯¹åº”çš„å¯¼å‡ºç»“æœ
}
Module._extensions = ['.js','.json'];

Module._resolveFilename = function (p) {
  p = path.join(__dirname,p); // c://xx/a
  if(!/\.\w+$/.test(p)){
    // å°è¯•æ·»åŠ æ‰©å±•å
    for(let i = 0;i<Module._extensions.length;i++){
      let filePath = p + Module._extensions[i];// æ‹¼å‡ºä¸€ä¸ªè·¯å¾„
      // åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      try{
        fs.accessSync(filePath);
        return filePath;
      }catch(e){
        if (i >= Module._extensions.length){
          throw new Error('module not Found')
        }
      }
    }
  }else{
    return p
  }
}
Module._cache = {};
Module._extensions['.json'] = function (module) {
  let content = fs.readFileSync(module.filename,'utf8');
  module.exports = JSON.parse(content)
}

Module.wrapper = ['(function (exports,require,module){','\r\n})'];
Module.wrap = function (content) {
  return Module.wrapper[0] + content + Module.wrapper[1];
}
Module._extensions['.js'] = function (module) {
  let content = fs.readFileSync(module.filename, 'utf8');
  let script = Module.wrap(content);
  let fn = vm.runInThisContext(script);
  // module.exports = exports = {}
  // exports.a = 'hello world'
  fn.call(module.exports, module.exports, req, module);
}
Module.prototype.load = function () {
  // åŠ è½½æ¨¡å—æœ¬èº« jsæŒ‰ç…§jsåŠ è½½ jsonæŒ‰ç…§jsonåŠ è½½
  let extname = path.extname(this.filename);
  Module._extensions[extname](this);
}
function req(path) { // è‡ªå·±å®ç°çš„requireæ–¹æ³• å¯ä»¥åŠ è½½æ¨¡å—
  // å…ˆè¦æ ¹æ®è·¯å¾„ å˜å‡ºä¸€ä¸ªç»å¯¹è·¯å¾„
  let filename = Module._resolveFilename(path);
  // æ–‡ä»¶è·¯å¾„ (ç»å¯¹è·¯å¾„) å”¯ä¸€
  if (Module._cache[filename]){
    // å¦‚æœåŠ è½½è¿‡ç›´æ¥æŠŠåŠ è½½çš„ç»“æœè¿”å›å³å¯
    // æœ‰ç¼“å­˜æŠŠexportså±æ€§å¯¼å‡ºå³å¯
    return Module._cache[filename].exports;
  }
  // é€šè¿‡è¿™ä¸ªæ–‡ä»¶ååˆ›å»ºä¸€ä¸ªæ¨¡å—
  let module = new Module(filename);
  module.load(); // è®©è¿™ä¸ªæ¨¡å—è¿›è¡ŒåŠ è½½ æ ¹æ®ä¸åŒçš„åç¼€åŠ è½½ä¸åŒçš„å†…å®¹
  Module._cache[filename] = module; // è¿›è¡Œæ¨¡å—çš„ç¼“å­˜
  // è¿”å›æœ€åçš„ç»“æœ
  return module.exports;
}
// module.exports exports æœ‰ä»€ä¹ˆå…³ç³»
let str = req('./b.js');
str = req('./b.js');
console.log(str);

// å¤šæ¬¡requireåªä¼šæ‰§è¡Œä¸€æ¬¡ cache

//1.å†™ä¸€ä¸ªè‡ªå·±çš„requireæ–¹æ³•
//2.Moudleæ˜¯ä¸€ä¸ªç±»
//3.è¦å®ç°ä¸€ä¸ªModule._loadæ–¹æ³•å®ç°æ¨¡å—çš„åŠ è½½
//4.Module._resolveFilename è§£æè·¯å¾„çš„
//5.Module._cacheåŠ è½½çš„ç¼“å­˜
//6.åˆ›å»ºä¸€ä¸ªæ¨¡å—
//7.æ”¾åˆ°ç¼“å­˜ä¸­
//8.Module._extensions
````
---

# ğŸŒ¹ npmå‘åŒ…
## ğŸŒ¹ğŸŒ¹ å®ç°å…¨å±€åŒ…
1ã€æ·»åŠ bin 
åœ¨package.jsonæ–‡ä»¶ä¸‹æ·»åŠ  æŒ‡ä»¤
````
  "bin": {
    "icey": "bin/www"
  },
````

2ã€åˆ›å»ºä¸€ä¸ª `wwww`æ–‡ä»¶ï¼Œæ— åç¼€åï¼Œæ·»åŠ  `#! /usr/bin/env node`
````
#! /usr/bin/env node
console.log('æˆ‘å¾ˆå¸…1');
console.log(process.argv.slice(2));
````

3ã€`sudo npm link`

## ğŸŒ¹ğŸŒ¹ å‘åŒ…
- åˆ‡æ¢åˆ°å®˜æ–¹æº
- npm addUser
- å¡«ä¸Šç”¨æˆ·åé‚®ç®± å¯†ç  é‚®ç®±æ³¨æ„è¦éªŒè¯
- npm publish
---

# ğŸŒ¹ å‘å¸ƒè®¢é˜…æ¨¡å¼
## ğŸŒ¹ğŸŒ¹ EventEmitteræ¨¡å—å®ç°
````javascript
// å‘å¸ƒè®¢é˜…  on è®¢é˜… emit å‘å¸ƒ
let EventEmitter = require('events');
// let util = require('util'); 
// function Girl(){
// }
// util.inherits(Girl,EventEmitter);
// æ³¨æ„ï¼Œä¸å»ºè®®ä½¿ç”¨ util.inherits()ã€‚ è¯·ä½¿ç”¨ ES6 çš„ class å’Œ extends å…³é”®è¯è·å¾—è¯­è¨€å±‚é¢çš„ç»§æ‰¿æ”¯æŒ
class Girl extends EventEmitter {} // class ç»§æ‰¿
let girl = new Girl;
function cry(){
    console.log('cry')
}
function eat(){
    console.log('eat')
}
function shopping(){
    console.log('shopping')
}
girl.on('å¤±æ‹äº†',cry);
girl.on('å¤±æ‹äº†',cry);
girl.on('å¤±æ‹äº†',eat);
girl.on('å¤±æ‹äº†',shopping);

girl.emit('å¤±æ‹äº†');

````
## ğŸŒ¹ğŸŒ¹ å…¶ä»–ç”¨æ³• on  once  prependListener
````javascript
let EventEmitter = require('./events');

let e = new EventEmitter();

let eat = function(){
    console.log('åƒ')
}
let cry = function(){
    console.log('å“­')
}
let haha = function(){
    console.log('ç¬‘')
}
// å¯ä»¥ç›‘å¬ç”¨æˆ·æ–°é‚¦å®šçš„äº‹ä»¶
// e.on('newListener',function(type){
//     process.nextTick(()=>{
//         e.emit(type)
//     })
// }); 
e.once('å¤±æ‹',haha); // once this.on('å¤±æ‹',one)
e.on('å¤±æ‹',cry); // once this.on('å¤±æ‹',one)
e.prependListener('å¤±æ‹',eat); // æ·»åŠ åˆ°ä¹‹å‰
// e.removeListener('å¤±æ‹',cry);
e.emit('å¤±æ‹'); // è§¦å‘å®Œæˆåå°±å°†æ•°ç»„çš„onceç»‘å®šçš„å‡½æ•°ç§»é™¤æ‰
e.emit('å¤±æ‹'); // è§¦å‘å®Œæˆåå°±å°†æ•°ç»„çš„onceç»‘å®šçš„å‡½æ•°ç§»é™¤æ‰
// console.log(EventEmitter.defaultMaxListeners)
````

## ğŸŒ¹ğŸŒ¹ è‡ªå·±å®ç°
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ ç®€å•ç‰ˆæœ¬
````javascript
function EventEmitter() {
    this._events = {};
}
// {å¤±æ‹:[fn,fn]}
EventEmitter.prototype.on = function (eventName, callback) {
    if (!this._events) this._events = Object.create(null);
    if (this._events[eventName]) {
        this._events[eventName].push(callback);
    } else {
        this._events[eventName] = [callback];
    }
}
EventEmitter.prototype.emit = function (eventName) {
    if (this._events[eventName]) {
        this._events[eventName].forEach(fn => {
            fn();
        });
    }
}

module.exports = EventEmitter;
````
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ ç»ˆæç‰ˆæœ¬
````javascript
function EventEmitter() {
    this._events = {};
    this.count = 0;
}
// {å¤±æ‹:[fn,fn]}
EventEmitter.prototype.addListener = EventEmitter.prototype.on;
EventEmitter.prototype.eventNames = function () {
    return Object.keys(this._events);
}
EventEmitter.prototype.listeners = function (eventName) {
    return this._events[eventName]
}
EventEmitter.prototype.on = function (eventName, callback, flag) {
    if (!this._events) this._events = Object.create(null);
    if (eventName !== 'newListener') {
        (this._events['newListener'] || []).forEach(fn => fn(eventName))
    }
    if (this._events[eventName] === this.count) {
        console.log('MaxListenersExceededWarning');
    }
    if (this._events[eventName]) {
        if (flag) {
            this._events[eventName].unshift(callback);
        } else {
            this._events[eventName].push(callback);
        }
    } else {
        this._events[eventName] = [callback];
    }
}
EventEmitter.prototype.once = function (eventName, callback,flag) {
    function one() {
        callback();
        this.removeListener(eventName, one);
    }
    one.g = callback;
    // {å¤±æ‹:[one]}
    this.on(eventName, one,flag);
}
EventEmitter.prototype.removeListener = function (eventName, listener) {
    this._events[eventName] = this._events[eventName].filter((fn) => {
        return fn != listener && fn.g !== listener;
    })
}
EventEmitter.prototype.prependListener = function (eventName, callback) {
    this.on(eventName, callback, true);
}
EventEmitter.prototype.prependOnceListener = function(eventName, listener){
    this.once(eventName,call,true);
}
EventEmitter.defaultMaxListeners = 10;
EventEmitter.prototype.getMaxListeners = function () {
    return this.count && EventEmitter.defaultMaxListeners;
}
EventEmitter.prototype.setMaxListeners = function (n) {
    return this.count = n;
}
EventEmitter.prototype.emit = function (eventName) {
    if (this._events[eventName]) {
        this._events[eventName].forEach(fn => {
            fn.call(this);
        });
    }
}
module.exports = EventEmitter;
````

# ğŸŒ¹ ç¼–ç 
---
## ğŸŒ¹ğŸŒ¹ ç¼–ç åŸºç¡€çŸ¥è¯†
1ã€å­—èŠ‚
* è®¡ç®—æœºå†…éƒ¨ï¼Œæ‰€æœ‰ä¿¡æ¯æœ€ç»ˆéƒ½æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶
* æ¯ä¸ªäºŒè¿›åˆ¶ ä½ `bit` æœ‰ 0 å’Œ 1 ä¸¤ç§çŠ¶æ€ï¼Œ
* 8ä¸ªäºŒè¿›åˆ¶ä½å°±å¯ä»¥ç»„åˆå‡º256ç§çŠ¶æ€ï¼Œè¿™è¢«æˆä¸ºä¸€ä¸ªå­—èŠ‚ `byte`

2ã€å•ä½
* 8ä½ï¼ˆbitï¼‰ = 1 å­—èŠ‚ ï¼ˆbyteï¼‰
* 1024å­—èŠ‚ = 1K
* 1024K = 1M
* 1024M = 1G
* 1024G = 1T
* 1ä¸ªå­—èŠ‚,æœ€å¤§255,ä¸€ä¸ªæ±‰å­—ä¸‰ä¸ªå­—èŠ‚

## ğŸŒ¹ğŸŒ¹ JavaScriptä¸­çš„è¿›åˆ¶
1ã€è¿›åˆ¶è¡¨ç¤º
````javascript
let a = 0b10100;//äºŒè¿›åˆ¶
let b = 0o24;//å…«è¿›åˆ¶
let c = 20;//åè¿›åˆ¶
let d = 0x14;//åå…­è¿›åˆ¶
console.log(a == b);
console.log(b == c);
console.log(c == d);
````
2ã€è¿›åˆ¶è½¬æ¢

* åè¿›åˆ¶è½¬ä»»æ„è¿›åˆ¶ `.toString(ç›®æ ‡è¿›åˆ¶)`
````
console.log(c.toString(2));
````

* ä»»æ„è¿›åˆ¶è½¬åè¿›åˆ¶ `parseInt('ä»»æ„è¿›åˆ¶å­—ç¬¦ä¸²', åŸå§‹è¿›åˆ¶)`
````
console.log(parseInt('10100', 2));
````

## ğŸŒ¹ğŸŒ¹ ASCII
æœ€å¼€å§‹è®¡ç®—æœºåªåœ¨ç¾å›½ç”¨ï¼Œå…«ä½çš„å­—èŠ‚å¯ä»¥ç»„åˆå‡º256ç§ä¸åŒçŠ¶æ€ã€‚0-32 ç§çŠ¶æ€è§„å®šäº†ç‰¹æ®Šç”¨é€”,ä¸€æ—¦ç»ˆç«¯ã€æ‰“å°æœºé‡ä¸Šçº¦å®šå¥½çš„è¿™äº›å­—èŠ‚è¢«ä¼ è¿‡æ¥æ—¶ï¼Œå°±è¦åšä¸€äº›çº¦å®šçš„åŠ¨ä½œå¦‚ï¼š
* é‡ä¸Š 0Ã—10, ç»ˆç«¯å°±æ¢è¡Œ
* é‡ä¸Š 0Ã—07, ç»ˆç«¯å°±å‘äººä»¬å˜Ÿå˜Ÿå«

åˆæŠŠæ‰€æœ‰çš„ç©ºæ ¼ã€æ ‡ç‚¹ç¬¦å·ã€æ•°å­—ã€å¤§å°å†™å­—æ¯åˆ†åˆ«ç”¨è¿ç»­çš„å­—èŠ‚çŠ¶æ€è¡¨ç¤ºï¼Œä¸€ç›´ç¼–åˆ°äº†ç¬¬ 127 å·ï¼Œè¿™æ ·è®¡ç®—æœºå°±å¯ä»¥ç”¨ä¸åŒå­—èŠ‚æ¥å­˜å‚¨è‹±è¯­çš„æ–‡å­—äº†.
è¿™128ä¸ªç¬¦å·ï¼ˆåŒ…æ‹¬32ä¸ªä¸èƒ½æ‰“å°å‡ºæ¥çš„æ§åˆ¶ç¬¦å·ï¼‰ï¼Œåªå ç”¨äº†ä¸€ä¸ªå­—èŠ‚çš„åé¢7ä½ï¼Œæœ€å‰é¢çš„ä¸€ä½ç»Ÿä¸€è§„å®šä¸º0  
> American Standard Code for Information Interchangeï¼šç¾å›½ä¿¡æ¯äº’æ¢æ ‡å‡†ä»£ç 

## ğŸŒ¹ğŸŒ¹  GB2312
åæ¥è¥¿æ¬§ä¸€äº›å›½å®¶ç”¨çš„ä¸æ˜¯è‹±æ–‡ï¼Œå®ƒä»¬çš„å­—æ¯åœ¨ ASCII é‡Œæ²¡æœ‰ä¸ºäº†å¯ä»¥ä¿å­˜ä»–ä»¬çš„æ–‡å­—ï¼Œä»–ä»¬ä½¿ç”¨127å·è¿™åçš„ç©ºä½æ¥ä¿å­˜æ–°çš„å­—æ¯ï¼Œä¸€ç›´ç¼–åˆ°äº†æœ€åä¸€ä½ 255ã€‚æ¯”å¦‚æ³•è¯­ä¸­çš„Ã©çš„ç¼–ç ä¸º 130ã€‚å½“ç„¶äº†ä¸åŒå›½å®¶è¡¨ç¤ºçš„ç¬¦å·ä¹Ÿä¸ä¸€æ ·ï¼Œæ¯”å¦‚ï¼Œ130 åœ¨æ³•è¯­ç¼–ç ä¸­ä»£è¡¨äº† `Ã©`,åœ¨å¸Œä¼¯æ¥è¯­ç¼–ç ä¸­å´ä»£è¡¨äº†å­—æ¯ `Gimel (×’)`ã€‚
> ä»128 åˆ° 255 è¿™ä¸€é¡µçš„å­—ç¬¦é›†è¢«ç§°ä¸ºæ‰©å±•å­—ç¬¦é›†ã€‚

ä¸­å›½ä¸ºäº†è¡¨ç¤ºæ±‰å­—ï¼ŒæŠŠ127å·ä¹‹åçš„ç¬¦å·å–æ¶ˆäº†ï¼Œè§„å®š
* ä¸€ä¸ªå°äº127çš„å­—ç¬¦çš„æ„ä¹‰ä¸åŸæ¥ç›¸åŒï¼Œä½†ä¸¤ä¸ªå¤§äº 127 çš„å­—ç¬¦è¿åœ¨ä¸€èµ·æ—¶ï¼Œå°±è¡¨ç¤ºä¸€ä¸ªæ±‰å­—ï¼›  
* å‰é¢çš„ä¸€ä¸ªå­—èŠ‚ï¼ˆä»–ç§°ä¹‹ä¸ºé«˜å­—èŠ‚ï¼‰ä»0xA1ç”¨åˆ°0xF7ï¼Œåé¢ä¸€ä¸ªå­—èŠ‚ï¼ˆä½å­—èŠ‚ï¼‰ä» 0xA1 åˆ° 0xFEï¼›  
* è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç»„åˆå‡ºå¤§çº¦ 7000 å¤šä¸ª ` (247-161)*(254-161)=(7998)` ç®€ä½“æ±‰å­—äº†ã€‚
* è¿˜æŠŠæ•°å­¦ç¬¦å·ã€æ—¥æ–‡å‡åå’ŒASCIIé‡ŒåŸæ¥å°±æœ‰çš„æ•°å­—ã€æ ‡ç‚¹å’Œå­—æ¯éƒ½é‡æ–°ç¼–æˆä¸¤ä¸ªå­—é•¿çš„ç¼–ç ã€‚è¿™å°±æ˜¯å…¨è§’å­—ç¬¦ï¼Œ127 ä»¥ä¸‹é‚£äº›å°±å«åŠè§’å­—ç¬¦ã€‚
* æŠŠè¿™ç§æ±‰å­—æ–¹æ¡ˆå«åš GB2312ã€‚GB2312 æ˜¯å¯¹ ASCII çš„ä¸­æ–‡æ‰©å±•

## ğŸŒ¹ğŸŒ¹ GBK
åæ¥è¿˜æ˜¯ä¸å¤Ÿç”¨ï¼Œäºæ˜¯å¹²è„†ä¸å†è¦æ±‚ä½å­—èŠ‚ä¸€å®šæ˜¯ 127 å·ä¹‹åçš„å†…ç ï¼Œåªè¦ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯å¤§äº 127 å°±å›ºå®šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ±‰å­—çš„å¼€å§‹,åˆå¢åŠ äº†è¿‘ 20000 ä¸ªæ–°çš„æ±‰å­—ï¼ˆåŒ…æ‹¬ç¹ä½“å­—ï¼‰å’Œç¬¦å·ã€‚

## ğŸŒ¹ğŸŒ¹ GB18030 / DBCS 
åˆåŠ äº†å‡ åƒä¸ªæ–°çš„å°‘æ•°æ°‘æ—çš„å­—ï¼ŒGBKæ‰©æˆäº†GB18030 é€šç§°ä»–ä»¬å«åš DBCS `Double Byte Character Setï¼šåŒå­—èŠ‚å­—ç¬¦é›†ã€‚`
åœ¨ DBCS ç³»åˆ—æ ‡å‡†é‡Œï¼Œæœ€å¤§çš„ç‰¹ç‚¹æ˜¯ä¸¤å­—èŠ‚é•¿çš„æ±‰å­—å­—ç¬¦å’Œä¸€å­—èŠ‚é•¿çš„è‹±æ–‡å­—ç¬¦å¹¶å­˜äºåŒä¸€å¥—ç¼–ç æ–¹æ¡ˆé‡Œ.å„ä¸ªå›½å®¶éƒ½åƒä¸­å›½è¿™æ ·æå‡ºä¸€å¥—è‡ªå·±çš„ç¼–ç æ ‡å‡†ï¼Œç»“æœäº’ç›¸ä¹‹é—´è°ä¹Ÿä¸æ‡‚è°çš„ç¼–ç ï¼Œè°ä¹Ÿä¸æ”¯æŒåˆ«äººçš„ç¼–ç 

## ğŸŒ¹ğŸŒ¹ Unicode
ISO çš„å›½é™…ç»„ç»‡åºŸäº†æ‰€æœ‰çš„åœ°åŒºæ€§ç¼–ç æ–¹æ¡ˆï¼Œé‡æ–°æä¸€ä¸ªåŒ…æ‹¬äº†åœ°çƒä¸Šæ‰€æœ‰æ–‡åŒ–ã€æ‰€æœ‰å­—æ¯å’Œç¬¦ çš„ç¼–ç ï¼ Unicode å½“ç„¶æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„é›†åˆï¼Œç°åœ¨çš„è§„æ¨¡å¯ä»¥å®¹çº³100å¤šä¸‡ä¸ªç¬¦å·ã€‚
* International Organization for Standardizationï¼šå›½é™…æ ‡å‡†åŒ–ç»„ç»‡ã€‚
* Universal Multiple-Octet Coded Character Setï¼Œç®€ç§° UCSï¼Œä¿—ç§° Unicode

ISO å°±ç›´æ¥è§„å®šå¿…é¡»ç”¨ä¸¤ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ 16 ä½æ¥ç»Ÿä¸€è¡¨ç¤ºæ‰€æœ‰çš„å­—ç¬¦ï¼Œå¯¹äº ASCII é‡Œçš„é‚£äº› åŠè§’å­—ç¬¦ï¼ŒUnicode ä¿æŒå…¶åŸç¼–ç ä¸å˜ï¼Œåªæ˜¯å°†å…¶é•¿åº¦ç”±åŸæ¥çš„ 8 ä½æ‰©å±•ä¸º16 ä½ï¼Œè€Œå…¶ä»–æ–‡åŒ–å’Œè¯­è¨€çš„å­—ç¬¦åˆ™å…¨éƒ¨é‡æ–°ç»Ÿä¸€ç¼–ç ã€‚  
ä» Unicode å¼€å§‹ï¼Œæ— è®ºæ˜¯åŠè§’çš„è‹±æ–‡å­—æ¯ï¼Œè¿˜æ˜¯å…¨è§’çš„æ±‰å­—ï¼Œå®ƒä»¬éƒ½æ˜¯ç»Ÿä¸€çš„ä¸€ä¸ªå­—ç¬¦ï¼åŒæ—¶ï¼Œä¹Ÿéƒ½æ˜¯ç»Ÿä¸€çš„ ä¸¤ä¸ªå­—èŠ‚
* å­—èŠ‚æ˜¯ä¸€ä¸ª8ä½çš„ç‰©ç†å­˜è´®å•å…ƒï¼Œ
* è€Œå­—ç¬¦åˆ™æ˜¯ä¸€ä¸ªæ–‡åŒ–ç›¸å…³çš„ç¬¦å·ã€‚

## ğŸŒ¹ğŸŒ¹ UTF-8
Unicode åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…æ— æ³•æ¨å¹¿ï¼Œç›´åˆ°äº’è”ç½‘çš„å‡ºç°ï¼Œä¸ºè§£å†³ Unicode å¦‚ä½•åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„é—®é¢˜ï¼Œäºæ˜¯é¢å‘ä¼ è¾“çš„ä¼—å¤š UTF æ ‡å‡†å‡ºç°äº†ï¼Œ
> Universal Character Setï¼ˆUCSï¼‰Transfer Formatï¼šUTFç¼–ç 

* UTF-8 å°±æ˜¯åœ¨äº’è”ç½‘ä¸Šä½¿ç”¨æœ€å¹¿çš„ä¸€ç§ Unicode çš„å®ç°æ–¹å¼
* UTF-8 å°±æ˜¯æ¯æ¬¡ä»¥8ä¸ªä½ä¸ºå•ä½ä¼ è¾“æ•°æ®
* è€Œ UTF-16 å°±æ˜¯æ¯æ¬¡ 16 ä¸ªä½
* UTF-8 æœ€å¤§çš„ä¸€ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯å®ƒæ˜¯ä¸€ç§å˜é•¿çš„ç¼–ç æ–¹å¼
* Unicode ä¸€ä¸ªä¸­æ–‡å­—ç¬¦å  2 ä¸ªå­—èŠ‚ï¼Œè€Œ UTF-8 ä¸€ä¸ªä¸­æ–‡å­—ç¬¦å  3 ä¸ªå­—èŠ‚
* UTF-8 æ˜¯ Unicode çš„å®ç°æ–¹å¼ä¹‹ä¸€

## ğŸŒ¹ğŸŒ¹ ç¼–ç è§„åˆ™
1. å¯¹äºå•å­—èŠ‚çš„ç¬¦å·ï¼Œå­—èŠ‚çš„ç¬¬ä¸€ä½è®¾ä¸º0ï¼Œåé¢7ä½ä¸ºè¿™ä¸ªç¬¦å·çš„ Unicode ç ã€‚å› æ­¤å¯¹äºè‹±è¯­å­—æ¯ï¼ŒUTF-8 ç¼–ç å’Œ ASCII ç æ˜¯ç›¸åŒçš„ã€‚
2. å¯¹äºnå­—èŠ‚çš„ç¬¦å·ï¼ˆn > 1ï¼‰ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚çš„å‰nä½éƒ½è®¾ä¸º1ï¼Œç¬¬n+ 1ä½è®¾ä¸º0ï¼Œåé¢å­—èŠ‚çš„å‰ä¸¤ä½ä¸€å¾‹è®¾ä¸º10ã€‚å‰©ä¸‹çš„æ²¡æœ‰æåŠçš„äºŒè¿›åˆ¶ä½ï¼Œå…¨éƒ¨ä¸ºè¿™ä¸ªç¬¦å·çš„ Unicode ç ã€‚
````
Unicodeç¬¦å·èŒƒå›´     |        UTF-8ç¼–ç æ–¹å¼
(åå…­è¿›åˆ¶)        |              ï¼ˆäºŒè¿›åˆ¶ï¼‰
----------------------+---------------------------------------------
0000 0000-0000 007F | 0xxxxxxx
0000 0080-0000 07FF | 110xxxxx 10xxxxxx
0000 0800-0000 FFFF | 1110xxxx 10xxxxxx 10xxxxxx
0001 0000-0010 FFFF | 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx
````

[Unicodeç¼–ç ](http://www.chi2ko.com/tool/CJK.htm)
````javascript
function transfer(num) {
  let ary = ['1110', '10', '10'];
  let binary = num.toString(2);
  ary[2] = ary[2]+binary.slice(binary.length-6);
  ary[1] = ary[1]+binary.slice(binary.length-12,binary.length-6);
  ary[0] = ary[0]+binary.slice(0,binary.length-12).padStart(4,'0');
  let result =  ary.join('');
  return parseInt(result,2).toString(16);
}
//ä¸‡
let result = transfer(0x4E07);//E4B887

````

## ğŸŒ¹ğŸŒ¹ æ–‡æœ¬ç¼–ç  
ä½¿ç”¨NodeJSç¼–å†™å‰ç«¯å·¥å…·æ—¶ï¼Œæ“ä½œå¾—æœ€å¤šçš„æ˜¯æ–‡æœ¬æ–‡ä»¶ï¼Œå› æ­¤ä¹Ÿå°±æ¶‰åŠåˆ°äº†æ–‡ä»¶ç¼–ç çš„å¤„ç†é—®é¢˜ã€‚æˆ‘ä»¬å¸¸ç”¨çš„æ–‡æœ¬ç¼–ç æœ‰UTF8å’ŒGBKä¸¤ç§ï¼Œå¹¶ä¸”UTF8æ–‡ä»¶è¿˜å¯èƒ½å¸¦æœ‰BOMã€‚åœ¨è¯»å–ä¸åŒç¼–ç çš„æ–‡æœ¬æ–‡ä»¶æ—¶ï¼Œéœ€è¦å°†æ–‡ä»¶å†…å®¹è½¬æ¢ä¸ºJSä½¿ç”¨çš„UTF8ç¼–ç å­—ç¬¦ä¸²åæ‰èƒ½æ­£å¸¸å¤„ç†ã€‚ 
## ğŸŒ¹ğŸŒ¹ ç§»é™¤BOMå¤´

BOMç”¨äºæ ‡è®°ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ä½¿ç”¨Unicodeç¼–ç ï¼Œå…¶æœ¬èº«æ˜¯ä¸€ä¸ªUnicodeå­—ç¬¦ï¼ˆ"\uFEFF"ï¼‰ï¼Œä½äºæ–‡æœ¬æ–‡ä»¶å¤´éƒ¨ã€‚åœ¨ä¸åŒçš„Unicodeç¼–ç ä¸‹ï¼ŒBOMå­—ç¬¦å¯¹åº”çš„äºŒè¿›åˆ¶å­—èŠ‚å¦‚ä¸‹ï¼š

 ````
    Bytes      Encoding
    ----------------------------
    FE FF       UTF16BE
    FF FE       UTF16LE
    EF BB BF    UTF8
 ````
å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æ–‡æœ¬æ–‡ä»¶å¤´å‡ ä¸ªå­—èŠ‚ç­‰äºå•¥æ¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦åŒ…å«BOMï¼Œä»¥åŠä½¿ç”¨å“ªç§Unicodeç¼–ç ã€‚ä½†æ˜¯ï¼ŒBOMå­—ç¬¦è™½ç„¶èµ·åˆ°äº†æ ‡è®°æ–‡ä»¶ç¼–ç çš„ä½œç”¨ï¼Œå…¶æœ¬èº«å´ä¸å±äºæ–‡ä»¶å†…å®¹çš„ä¸€éƒ¨åˆ†ï¼Œå¦‚æœè¯»å–æ–‡æœ¬æ–‡ä»¶æ—¶ä¸å»æ‰BOMï¼Œåœ¨æŸäº›ä½¿ç”¨åœºæ™¯ä¸‹å°±ä¼šæœ‰é—®é¢˜ã€‚ä¾‹å¦‚æˆ‘ä»¬æŠŠå‡ ä¸ªJSæ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶åï¼Œå¦‚æœæ–‡ä»¶ä¸­é—´å«æœ‰BOMå­—ç¬¦ï¼Œå°±ä¼šå¯¼è‡´æµè§ˆå™¨JSè¯­æ³•é”™è¯¯ã€‚å› æ­¤ï¼Œä½¿ç”¨NodeJSè¯»å–æ–‡æœ¬æ–‡ä»¶æ—¶ï¼Œä¸€èˆ¬éœ€è¦å»æ‰BOM

ç§»é™¤BOMå¤´ï¼š
````javascript
function readText(pathname) {
    var bin = fs.readFileSync(pathname);
    if (bin[0] === 0xEF && bin[1] === 0xBB && bin[2] === 0xBF) {
        bin = bin.slice(3);
    }
    return bin.toString('utf-8');
}
````

## ğŸŒ¹ğŸŒ¹ GBKè½¬UTF8 
NodeJSæ”¯æŒåœ¨è¯»å–æ–‡æœ¬æ–‡ä»¶æ—¶ï¼Œæˆ–è€…åœ¨Bufferè½¬æ¢ä¸ºå­—ç¬¦ä¸²æ—¶æŒ‡å®šæ–‡æœ¬ç¼–ç ï¼Œä½†é—æ†¾çš„æ˜¯ï¼ŒGBKç¼–ç ä¸åœ¨NodeJSè‡ªèº«æ”¯æŒèŒƒå›´å†…ã€‚å› æ­¤ï¼Œä¸€èˆ¬æˆ‘ä»¬å€ŸåŠ©iconv-liteè¿™ä¸ªä¸‰æ–¹åŒ…æ¥è½¬æ¢ç¼–ç ã€‚ä½¿ç”¨NPMä¸‹è½½è¯¥åŒ…åï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ä¸‹è¾¹æ–¹å¼ç¼–å†™ä¸€ä¸ªè¯»å–GBKæ–‡æœ¬æ–‡ä»¶çš„å‡½æ•°ã€‚

````javascript
var iconv = require('iconv-lite');
function readGBKText(pathname) {
    var bin = fs.readFileSync(pathname);
    return iconv.decode(bin, 'gbk');
}
````

# ğŸŒ¹ Buffer
---
## ğŸŒ¹ğŸŒ¹ ä»€ä¹ˆæ˜¯Buffer
* ç¼“å†²åŒºBufferæ˜¯æš‚æ—¶å­˜æ”¾è¾“å…¥è¾“å‡ºæ•°æ®çš„ä¸€æ®µå†…å­˜ã€‚
* JSè¯­è¨€æ²¡æœ‰äºŒè¿›åˆ¶æ•°æ®ç±»å‹ï¼Œè€Œåœ¨å¤„ç†TCPå’Œæ–‡ä»¶æµçš„æ—¶å€™ï¼Œå¿…é¡»è¦å¤„ç†äºŒè¿›åˆ¶æ•°æ®ã€‚
* NodeJSæä¾›äº†ä¸€ä¸ªBufferå¯¹è±¡æ¥æä¾›å¯¹äºŒè¿›åˆ¶æ•°æ®çš„æ“ä½œ
* æ˜¯ä¸€ä¸ªè¡¨ç¤ºå›ºå®šå†…å­˜åˆ†é…çš„å…¨å±€å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´è¦æ”¾åˆ°ç¼“å­˜åŒºä¸­çš„å­—èŠ‚æ•°éœ€è¦æå‰ç¡®å®š
* Bufferå¥½æ¯”ç”±ä¸€ä¸ª8ä½å­—èŠ‚å…ƒç´ ç»„æˆçš„æ•°ç»„ï¼Œå¯ä»¥æœ‰æ•ˆçš„åœ¨JavasScriptä¸­è¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®
* bufferæ˜¯äºŒè¿›åˆ¶ (å­˜çš„æ˜¯16è¿›åˆ¶) è¡¨ç¤ºçš„æ˜¯å†…å­˜
* fsè¯»å–æ–‡ä»¶ bufferç±»å‹

## ğŸŒ¹ğŸŒ¹ Bufferå£°æ˜çš„æ–¹å¼
### 1 é€šè¿‡é•¿åº¦å®šä¹‰buffer
````javascript
// åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 10ã€ä¸”ç”¨ 0 å¡«å……çš„ Bufferã€‚
const buf1 = Buffer.alloc(10);
// åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 10ã€ä¸”ç”¨ 0x1 å¡«å……çš„ Bufferã€‚
const buf2 = Buffer.alloc(10, 1);
// åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 10ã€ä¸”æœªåˆå§‹åŒ–çš„ Bufferã€‚
const buf3 = Buffer.allocUnsafe(10);
````
### 2 é€šè¿‡æ•°ç»„å®šä¹‰buffer
````javascript
// åˆ›å»ºä¸€ä¸ªåŒ…å« [0x1, 0x2, 0x3] çš„ Bufferã€‚
const buf4 = Buffer.from([1, 2, 3]);
````
### 3 å­—ç¬¦ä¸²åˆ›å»ºbuffer
````javascript
const buf5 = Buffer.from('ç‹å†°æ´‹');
````

é»˜è®¤æƒ…å†µä¸‹ Bufferä¸æ”¯æŒ gbkç¼–ç ;gbk -> utf8  iconv-liteå¯ä»¥å¤„ç†ä¹±ç 
````javascript
let fs = require('fs');
let r = fs.readFileSync('./1.txt');
let iconvLite = require('iconv-lite');
r = iconvLite.decode(r,'gbk'); 
console.log(r);
````

## ğŸŒ¹ğŸŒ¹ å¸¸ç”¨çš„æ–¹æ³•
### 1 buf.fill(value[, offset[, end]][, encoding]) 
æ‰‹åŠ¨åˆå§‹åŒ–,æ“¦å¹²å‡€æ¡Œå­,å°†bufferå†…å®¹æ¸…0
````javscript
buffer.fill(0);
````
### 2 writeæ–¹æ³• 
`buf.write(string[, offset[, length]][, encoding])`
````javscript
buffer.write('å†°',0,3,'utf8');
buffer.write('æ´‹',3,3,'utf8'); // å†°æ´‹
````
### 3 writeInt8
````javscript
var buf = new Buffer(4);
buf.writeInt8(0,0);
buf.writeInt8(16,1);
buf.writeInt8(32,2);
buf.writeInt8(48,3);//16*3*/
console.log(buf);
console.log(buf.readInt8(0));
console.log(buf.readInt8(1));
console.log(buf.readInt8(2));
console.log(buf.readInt8(3));
````
### 4 Little-Endian&Big-Endian
ä¸åŒçš„CPUæœ‰ä¸åŒçš„å­—èŠ‚åºç±»å‹ï¼Œè¿™äº›å­—èŠ‚åºæ˜¯æŒ‡æ•´æ•°åœ¨å†…å­˜ä¸­ä¿å­˜çš„é¡ºåºã€‚
* Big-endianï¼šå°†é«˜åºå­—èŠ‚å­˜å‚¨åœ¨èµ·å§‹åœ°å€ï¼ˆé«˜ä½ç¼–å€ï¼‰
* Little-endianï¼šå°†ä½åºå­—èŠ‚å­˜å‚¨åœ¨èµ·å§‹åœ°å€ï¼ˆä½ä½ç¼–å€ï¼‰

````javscript
let buf3 = new Buffer(4);
buf3.writeInt16BE(2**8,0);
console.log(buf3);//<Buffer 01 00 00 00>
console.log(buf3.readInt16BE(0));

buf3.writeInt16LE(2**8,2);
console.log(buf3);//<Buffer 01 00 00 01>
console.log(buf3.readInt16LE(2));
````
### 5 toString()
`buf.toString([encoding[, start[, end]]])`
````javscript
let buf4 = new Buffer(6);
buf4.toString('utf8',3,6)
````
### 6 slice()
`buf.slice([start[,end]])`
````javscript
let newBuf = buffer.slice(0,4);
````
### 7 æˆªå–ä¹±ç é—®é¢˜
````javascript
let {StringDecoder}  = require('string_decoder');
let sd = new StringDecoder();
let buffer = new Buffer('å†°æ´‹');
console.log(sd.write(buffer.slice(0,4)));
console.log(sd.write(buffer.slice(4)));
````
### 7 copyæ–¹æ³•
å¤åˆ¶Buffer æŠŠå¤šä¸ªbufferæ‹·è´åˆ°ä¸€ä¸ªå¤§bufferä¸Š
`buf.copy(target[, targetStart[, sourceStart[, sourceEnd]]])`

````javascript
let buf5 = Buffer.from('ç‹å†°æ´‹å•Š');
let buf6 = Buffer.alloc(6);
buf5.copy(buf6,0,0,4);
buf5.copy(buf6,3,3,6);
//buf6=ç‹å†°
````
è‡ªå·±å®ç° copy
````javascript
// copy æ‹·è´
Buffer.prototype.copy = function(targetBuffer,targetStart,sourceStart,SourceEnd){
    sourceStart = sourceStart?sourceStart:0
    SourceEnd = SourceEnd? SourceEnd:this.length
    for(let i=sourceStart;i<SourceEnd;i++){
        // æŠŠå†…å®¹è€ƒåˆ°å¯¹åº”çš„bufferçš„èº«ä¸Š
        targetBuffer[targetStart++] = this[i];
    }
}
````
### 7 concatæ–¹æ³•
`Buffer.concat(list[, totalLength])`

````javascript
let buf1 = Buffer.from('ç‹);
let buf2 = Buffer.from('å†°æ´‹');
let newBuffer = Buffer.concat([buf1,buf2,buf1]);
console.log(newBuffer.toString());
````
è‡ªå·±å®ç° concat
````javascript
// concat è¿æ¥
Buffer.concat = function(bufferArray,len){
    len =typeof len === 'undefined'?bufferArray.reduce((prev,next,current)=>prev+next.length,0)  : len;
    // è®¡ç®—å‡ºä¸€ä¸ªå¤§çš„bufferæ¥
    let buffer = Buffer.alloc(len);
    let pos = 0;
    for(let i = 0;i<bufferArray.length;i++){
        // æŠŠæ•°ç»„é‡Œçš„æ¯ä¸€ä¸ªbufferå…¨éƒ¨æ‹·è´ä¸Šå»
        bufferArray[i].copy(buffer,pos);
        // æ¯æ¬¡æ‹·è´åç´¯åŠ è‡ªèº«çš„é•¿åº¦
        pos += bufferArray[i].length;
    }
    return buffer;
}
````

ğŸŒ° indexof
````javascript
// 2 indexof
Buffer.from('å†°æ´‹æ´‹å†°ç«').indexOf('æ´‹',6) // buf ä¸­ value é¦–æ¬¡å‡ºç°çš„ç´¢å¼•ï¼Œå¦‚æœ buf æ²¡åŒ…å« value åˆ™è¿”å› -1 
````
## ğŸŒ¹ğŸŒ¹ base64 
* Base64æ˜¯ç½‘ç»œä¸Šæœ€å¸¸è§çš„ç”¨äºä¼ è¾“8Bitå­—èŠ‚ç çš„ç¼–ç æ–¹å¼ä¹‹ä¸€ï¼ŒBase64å°±æ˜¯ä¸€ç§åŸºäº64ä¸ªå¯æ‰“å°å­—ç¬¦æ¥è¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®çš„æ–¹æ³•ã€‚
* Base64è¦æ±‚æŠŠæ¯ä¸‰ä¸ª8Bitçš„å­—èŠ‚è½¬æ¢ä¸ºå››ä¸ª6Bitçš„å­—èŠ‚ï¼ˆ38 = 46 = 24ï¼‰ï¼Œç„¶åæŠŠ6Bitå†æ·»ä¸¤ä½é«˜ä½0ï¼Œç»„æˆå››ä¸ª8Bitçš„å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè½¬æ¢åçš„å­—ç¬¦ä¸²ç†è®ºä¸Šå°†è¦æ¯”åŸæ¥çš„é•¿1/3
````javascirpt
const CHARTS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
function transfer(str){
  let buf = Buffer.from(str);
  let result = '';
  for(let b of buf){
      result += b.toString(2);
  }
    return result.match(/(\d{6})/g).map(val=>parseInt(val,2)).map(val=>CHARTS[val]).join('');
}
let r = transfer('ç ');//54+g
````
# ğŸŒ¹ fs
---
## ğŸŒ¹ğŸŒ¹ fsæ¨¡å—
* åœ¨ Node.js ä¸­ï¼Œä½¿ç”¨fsæ¨¡å—æ¥å®ç°æ‰€æœ‰æœ‰å…³æ–‡ä»¶åŠç›®å½•çš„åˆ›å»ºã€å†™å…¥åŠåˆ é™¤æ“ä½œã€‚
* åœ¨fsæ¨¡å—ä¸­ï¼Œæ‰€æœ‰çš„æ–¹æ³•éƒ½åˆ†ä¸ºåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§å®ç°ã€‚
* å…·æœ‰syncåç¼€çš„æ–¹æ³•ä¸ºåŒæ­¥æ–¹æ³•ï¼Œä¸å…·æœ‰syncåç¼€çš„æ–¹æ³•ä¸ºå¼‚æ­¥æ–¹æ³•ã€‚

## ğŸŒ¹ğŸŒ¹ è¯»æ–‡ä»¶ readFile + readFileSync
* æ–¹æ³•éƒ½æ˜¯ å¼‚æ­¥æ²¡æœ‰sync / åŒæ­¥ Sync
* è¿”å›å€¼å¯ä»¥è·å–åŒæ­¥çš„ç»“æœ
* è¯»å–æ–‡ä»¶é»˜è®¤çš„ç»“æœç±»å‹ encoding:null é»˜è®¤æ˜¯buffer
* å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™ä¼šæŠ¥é”™
* è¯»å–çš„æ—¶å€™ä¼šæŠŠå†…å®¹æ•´ä½“è¯»å–åˆ°å†…å­˜ä¸­ è¯»å°çš„æ–‡ä»¶)ï¼Œå¤§çš„æ–‡ä»¶æµæ“ä½œ
* å¼‚æ­¥ error-first

````javascript  
let fs = require('fs');
let path = require('path');
// åŒæ­¥
let r = fs.readFileSync(path.join(__dirname,'note.md'),{encoding:'utf8',flag:'r'});
console.log(r);
// å¼‚æ­¥
fs.readFile(path.join(__dirname,'note.md'),'utf8',function(err,data){ // å›è°ƒä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•° æ°¸è¿œæ˜¯é”™è¯¯
    console.log(data);
});
console.log(r);
````
## ğŸŒ¹ğŸŒ¹ å†™æ–‡ä»¶ writeFile + writeFileSync + appendFile
* å†™å…¥æ—¶é»˜è®¤æ–‡ä»¶å­˜åœ¨å°±åˆ›å»ºï¼Œæœ‰æ–‡ä»¶çš„è¯ ä¼šè¢«æ¸…ç©º
* å†™å…¥æ—¶ ä»–ä¼šæŠŠå†…å®¹ä»¥äºŒè¿›åˆ¶çš„å½¢å¼å†™å…¥è¿›å»

````javascript
let fs = require('fs');
// åŒæ­¥ fs.writeFileSync(file, data[, options])
fs.writeFileSync('./1.txt',Date.now()+'\n',{flag:'a'});
// å¼‚æ­¥ fs.writeFile(file, data[, options], callback)
fs.writeFile(path.join(__dirname,'1.txt'),'{data:1}',function(err){
    console.log('æˆåŠŸ')
});
// è¿½åŠ  fs.appendFile(file, data[, options], callback)
fs.appendFile(path.join(__dirname,'1.txt'),'{data:1}',function(err){
    console.log('æˆåŠŸ')
});
````

## ğŸŒ¹ğŸŒ¹ æ‹·è´æ–‡ä»¶ 
1ã€ç›´æ¥ è¯»readFile å†å†™å…¥ writeFile
````javascript
// æ‹·è´æ–¹æ³•  ä¸èƒ½è¯»ä¸€ç‚¹å†™ä¸€ç‚¹ï¼Œæƒ³æŒ‡å®šä½ç½®è¯»å–
fs.readFile(path.join(__dirname,'1.txt'),(err,data)=>{
    fs.writeFile(path.join(__dirname,'2.txt'),data,(err)=>{
        console.log('æ‹·è´æˆåŠŸ')
    })
});
````

## ğŸŒ¹ğŸŒ¹ open
`fs.open(filename,flags,[mode],callback);`
> mode:æƒé™ r 4  w 2   x 1  chmod 777 666 0o438
> `callback:(err,fd)=>{}`  fd:file descriptor æ–‡ä»¶æè¿°ç¬¦(æ•°å­—ç±»å‹) ReadStream ä½¿ç”¨çš„æ•´æ•°å‹æ–‡ä»¶æè¿°ç¬¦
> `process.stdin 0 process.stdout 1 process.stderr 2`

````javascript
let fs = require('fs');
let path = require('path');
//
fs.open(path.join(__dirname,'1.txt'),'w',(err,fd)=>{
    // todo
})
````

## ğŸŒ¹ğŸŒ¹ å†™å…¥æŒ‡å®šå†…å®¹ open + write

````javascript
fs.open(path.join(__dirname,'1.txt'),'w',(err,fd)=>{
    let buf = Buffer.from('ç‹å†°æ´‹');
    // buf æŒ‡çš„æ˜¯è¯»å–çš„buffer
    // 0 ä»bufferå“ªä¸ªä½ç½®è¯»å– 
    // 6 è¯»å–å¤šå°‘ä¸ªbufferå¾€é‡Œå†™
    // 0 ä»æ–‡ä»¶å“ªä¸ªä½ç½®å†™å…¥
    // bytesWrittenå®é™…å†™å…¥çš„ä¸ªæ•°
    fs.write(fd,buf,0,4,0,(err,bytesWritten)=>{
        console.log('å†™å…¥æˆåŠŸ')
    })
})

````

## ğŸŒ¹ğŸŒ¹ è¯»å–æŒ‡å®šå†…å®¹ open + read
````javascript  
fs.open(path.join(__dirname,'1.txt'),'r',(err,fd)=>{
    let buffer = Buffer.alloc(5);
    /**
     * fdæ–‡ä»¶ï¼Œæè¿°ç¬¦
     * buffer è¯»å–åˆ°é‚£ä¸ªbufferä¸­
     * 0 ä»bufferå“ªä¸ªåœ°æ–¹å¼€å§‹å†™å…¥
     * 5 å†™å…¥å¤šé•¿
     * 1 ä»æ–‡ä»¶çš„é‚£ä¸ªä½ç½®å¼€å§‹è¯»å–
     * bytesReadå®é™…è¯»å–åˆ°çš„ä¸ªæ•°
     */
    fs.read(fd,buffer,0,4,1,(err,bytesRead)=>{
        console.log(buffer.toString());
        fs.close(fd,()=>{
            console.log('å…³é—­')
        })
    });
});
````

## ğŸŒ¹ğŸŒ¹ æ‹·è´æŒ‡å®šä½ç½® open + read + write

````javascript
let fs = require('fs');
let path = require('path');
// 1.txt => 2.txt
// 1.å‡†å¤‡æ‰“å¼€ 1.txt å’Œ 2.txt
const BUFFER_SIZE = 5;
let readPos = 0;
let writePos = 0;
// å¼‚æ­¥çš„é€’å½’æ˜¯å¦‚ä½•æ“ä½œçš„ 
fs.open(path.join(__dirname, '1.txt'), 'r', (err, rfd) => {
    fs.open(path.join(__dirname, '2.txt'), 'w', (err, wfd) => {
        // 
        function next() {
            let buf = Buffer.alloc(BUFFER_SIZE); // ç”³è¯·è¯»å‡ºæ¥çš„bufferçš„é•¿åº¦
            fs.read(rfd, buf, 0, BUFFER_SIZE, null, (err, byteRead) => {
                if (byteRead > 0) {
                    // å†™å…¥è¯»å–åˆ°çš„ä¸ªæ•° å¯èƒ½æƒ³è¯»10ä¸ª ä½†æ˜¯åªæœ‰5ä¸ª
                    readPos += byteRead
                    fs.write(wfd, buf, 0, byteRead, null, (err, byteWritten) => {
                        writePos += byteWritten;
                        next();
                    });
                }else{
                    fs.close(rfd,()=>{ });
                    // è¯»å–å®Œæ¯• ä¸ä¸€å®šè¡¨ç¤ºå†™å…¥å®Œæ¯• 
                    fs.fsync(wfd,()=>{
                        fs.close(wfd,()=>{})
                    });
                }
            })
        }
        // 
        next();
    });
});


````

## ğŸŒ¹ğŸŒ¹ ç›®å½•æ“ä½œ 

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ åˆ›å»ºç›®å½•
> fs.mkdir(path[, mode], callback)
> è¦æ±‚çˆ¶ç›®å½•å¿…é¡»å­˜åœ¨

* åˆ¤æ–­ä¸€ä¸ªæ–‡ä»¶æ˜¯å¦æœ‰æƒé™è®¿é—®
> fs.access(path[, mode], callback)
> 
````javascript
fs.access('/etc/passwd', fs.constants.R_OK | fs.constants.W_OK, (err) => {
  console.log(err ? 'no access!' : 'can read/write');
});
````
* å¹¿åº¦ä¼˜å…ˆéå†

å¼‚æ­¥åˆ›å»ºå¤šçº§ç›®å½• async + await
> 
````javascript
let fs = require('fs');
let util = require('util');
let access = util.promisify(fs.access); // promisifyå°†æ”¹ioæ“ä½œpromiseåŒ–
let mkdir = util.promisify(fs.mkdir);
async function makep(p) {
    let paths = p.split('/');
    for (let i = 0; i < paths.length; i++) {
        let dirPath = paths.slice(0, i + 1).join('/');
        try{
            await access(dirPath)
        }catch(e){
            await mkdir(dirPath);
        }
    }
}
makep('a/b/c/d/e').then(data => {
    console.log('åˆ›å»ºæˆæœ')
})
````

åŒæ­¥åˆ›å»ºå¤šçº§ç›®å½•  
````javascript  
function makep(p) {  // åŒæ­¥åˆ›å»ºç›®å½•
    let paths = p.split('/');
    for (let i = 0; i < paths.length; i++) {
        let dirPath = paths.slice(0,i+1).join('/');
        try{
            // å¦‚æœèƒ½è®¿é—®åˆ° ä¸å¹²ä»»ä½•äº‹ ï¼Œè®¿é—®ä¸åˆ°æ‰åˆ›å»º
            fs.accessSync(dirPath);
        }catch(e){
            fs.mkdirSync(dirPath);
        }
    }
}
makep('a/b/c/d/e');
````  

é€’å½’åˆ›å»ºå¤šçº§ç›®å½• å¼‚æ­¥
````javascript
function makep(p,fn){
    let paths = p.split('/');
    let index = 0;
    function next(){
        if(index ===paths.length ) return fn();
        let realPath = paths.slice(0,++index).join('/');
        // å¦‚æœæ–‡ä»¶æ— æ³•è®¿é—®åˆ° é‚£å°±è¯´æ˜æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»º åè¿‡æ¥å¦‚æœæ–‡ä»¶ å­˜åœ¨å°±åˆ›å»ºä¸€ä¸‹ä¸ª
        fs.access(realPath,(err)=>{
            if(err){
                fs.mkdir(realPath,(err)=>{
                    next();
                });
            }else{
                next();
            }
        })
    }
    next();
}
makep('e/d/e/g/s/q',()=>{
    console.log('ok')
})
````


### ğŸŒ¹ğŸŒ¹ğŸŒ¹ æŸ¥çœ‹æ–‡ä»¶ç›®å½•ä¿¡æ¯
`fs.stat(path, callback)`
> stats.isFile()
stats.isDirectory()
atime(Access Time)ä¸Šæ¬¡è¢«è¯»å–çš„æ—¶é—´ã€‚
ctime(State Change Time)ï¼šå±æ€§æˆ–å†…å®¹ä¸Šæ¬¡è¢«ä¿®æ”¹çš„æ—¶é—´ã€‚
mtime(Modified time)ï¼šæ¡£æ¡ˆçš„å†…å®¹ä¸Šæ¬¡è¢«ä¿®æ”¹çš„æ—¶é—´ã€‚

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ ç§»åŠ¨æ–‡ä»¶æˆ–ç›®å½•
`fs.rename(oldPath, newPath, callback)`

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ è¯»å–ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
`fs.readdir(path[, options], callback)`

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ æˆªæ–­æ–‡ä»¶
`fs.ftruncate(fd[, len], callback)`

````javascript
const fd = fs.openSync('temp.txt', 'r+');
// æˆªæ–­æ–‡ä»¶è‡³å‰4ä¸ªå­—èŠ‚
fs.ftruncate(fd, 4, (err) => {
  console.log(fs.readFileSync('temp.txt', 'utf8'));
});
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ åˆ é™¤ç›®å½•
`rmdir`
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ åˆ é™¤æ–‡ä»¶
`fs.unlink(path, callback)`

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ åˆ é™¤éç©ºç›®å½•
`rmdirSync` `rmdir` `unlink`

#### ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ ç®€å•å®ç°
````javascript
// å¦‚æœåˆ é™¤ä¸€ä¸ªæ–‡ä»¶å¤¹ å…ˆè¯»å–å‡º æ–‡ä»¶å¤¹çš„å†…å®¹fs.readdir
// åˆ¤æ–­å½“å‰è¿™ä¸ªè·¯å¾„æ˜¯æ–‡ä»¶å¤¹è¿˜æ˜¯æ–‡ä»¶ï¼Œæ–‡ä»¶çš„çŠ¶æ€ fs.stat
// statObj.isDirectory  statObj.isFile
// fs.rmdir åˆ é™¤ç›®å½•    fs.unlink åˆ é™¤æ–‡ä»¶
let fs  =require('fs');
let path = require('path');
fs.readdir('a',function (err,files) {
  let paths = files.map(dir => path.join('a', dir))
  console.log(paths);
  paths.forEach(p=>{
    fs.stat(p,(err,statObj)=>{
      if (statObj.isDirectory()){
        fs.rmdir(p)
      }else{
        fs.unlink(p)
      }
    });
  });
});
````

#### ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ å…ˆåºå¹¿åº¦éå†
````javascript  
let fs  =require('fs');
let path = require('path');
// å…ˆåºå¹¿åº¦éå†
function rmdirSync(dir){
    let arr = [dir]; // åˆ›å»ºä¸€ä¸ªè®°å½•è¡¨
    let index = 0 ; // ä»è®°å½•è¡¨é‡Œæ‹¿å‡ºç¬¬ä¸€é¡¹ a
    let current; // a
    while(current = arr[index++]){
        let dirsPath = fs.readdirSync(current); // [b,c]
        dirsPath = dirsPath.map(item=> path.join(current,item)); // => [a/b,a/c]
        arr = [...arr,...dirsPath] // => [a,a/b,a/c]
    };
    for(let i =arr.length-1;i>=0;i--){
        fs.rmdirSync(arr[i]);
    }
}
rmdirSync('a');
// ç”¨ä¼ ç»Ÿçš„å›è°ƒ fs.readdir  fs.rmdir å®ç°å¹¿åº¦åˆ é™¤
````
#### ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ Promiseç‰ˆ
````javascript
// 1ã€å¼‚æ­¥primise æ·±åº¦ä¼˜å…ˆ åˆ é™¤
let {promisify} = require('util'); // async - > await
let fs = require('mz/fs');
async function removePromise(dir) {
    let statObj = await fs.stat(dir);
    if (statObj.isDirectory()) {
      let files = await fs.readdir(dir);
      files = files.map(file => removePromise(path.join(dir, file)));
      await Promise.all(files); // åˆ é™¤å„¿å­
      await fs.rmdir(dir);// åˆ é™¤è‡ªå·±
    } else {
      await fs.unlink(dir);
    }
}
removePromise('a').then(()=>{
  console.log('åˆ é™¤æˆåŠŸ');
},err=>{
  console.log(err);
})
// 2ã€ç‰ˆæœ¬2
function removePromise(dir) {
    return new Promise((resolve,reject)=>{
      fs.stat(dir,(err,statObj)=>{
        if(statObj.isDirectory()){
          fs.readdir(dir,(err,files)=>{
            files = files.map(file=>path.join(dir,file));
            // [a/b,a/c,a/1.js]
            // ç­‰å¾…å„¿å­åˆ é™¤å åˆ é™¤è‡ªå·±
            Promise.all(files.map(file =>removePromise(file))).then(()=>{
              fs.rmdir(dir,resolve);
            });
          })
        }else{
          // æ–‡ä»¶åˆ é™¤å æˆåŠŸå³å¯
          fs.unlink(dir,resolve);
        }
      })
    });
}
removePromise('a').then(()=>{
  console.log('åˆ é™¤ok');
})
````

#### ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ å¹¶è¡Œ
````javascript
function removeDir(dir, cb) {
    fs.stat(dir,(err,statObj)=>{
      if (statObj.isDirectory()){
        fs.readdir(dir,(err,files)=>{
          let paths = files.map(file=>path.join(dir,file));
          // è·å–æ¯ä¸€ä¸ªè·¯å¾„
          if(paths.length>0){
            let i = 0;
            function done() { // Promise.all ç­‰å¾…å¼‚æ­¥éƒ½æ‰§è¡Œå®Œå å†æ‰§è¡Œä¹‹åçš„æ“ä½œ 
              i++;
              if(i === paths.length){
                removeDir(dir, cb);
              }
            }
            paths.forEach(p => {
              // åˆ é™¤æŸä¸ªåé€šçŸ¥ä¸‹ å½“åˆ é™¤çš„å­ç›®å½•ä¸ªæ•° ç­‰äºæˆ‘ä»¬çš„å­ç›®å½•æ•°ï¼Œåˆ é™¤çˆ¶çº§å³å¯
              removeDir(p,done);
            })
          }else{
            fs.rmdir(dir,cb); // å½“å‰ç›®å½•ä¸‹æ²¡ä¸œè¥¿ç›´æ¥åˆ é™¤å³å¯
          }
        })
      }else{
        fs.unlink(dir,cb);
      }
    })
}

````

#### ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ å¼‚æ­¥æ·±åº¦ä¼˜å…ˆ ï¼ˆä¸²è¡Œ series paralleï¼‰
````javascript
function removeDir(dir,cb) { 
    fs.stat(dir,(err,statObj)=>{
      if (statObj.isDirectory()){
        fs.readdir(dir,(err,files)=>{
          let paths = files.map(file=>path.join(dir,file));
          function next(index) {
            // ç¬¬ä¸€æ¬¡å–å‡ºçš„æ˜¯a/1.js
            if (index === paths.length) return fs.rmdir(dir,cb);
            let currentPath = paths[index];
            // æ–‡ä»¶åˆ é™¤åç»§ç»­æ‹¿å‡ºä¸‹ä¸€é¡¹ ç»§ç»­åˆ é™¤
            // ä¸²è¡Œåˆ é™¤ï¼Œåˆ é™¤å®Œç¬¬ä¸€ä¸ªï¼Œç¬¬ä¸€ä¸ªåˆ é™¤å®Œåè°ƒç”¨ç¬¬äºŒä¸ªåˆ é™¤çš„æ–¹æ³•
            removeDir(currentPath,()=>next(index+1));
          }
          next(0);
        })
      }else{
        fs.unlink(dir,cb);
      }
    })
}
removeDir('a',()=>{
  console.log('åˆ é™¤æˆåŠŸ');
});
````

#### ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ æ·±åº¦ æœ‰å„¿å­å°±æ·±å…¥è¿›å»
````javascript
function removeDirSync(dir) {
  let stateObj = fs.statSync(dir);
  if(stateObj.isDirectory()){
    // æ˜¯ç›®å½•ç»§ç»­è¯»å–
    let dirs = fs.readdirSync(dir);
    dirs.forEach(d=>{
      let p = path.join(dir,d);
      removeDirSync(p);
    });
    // å„¿å­åˆ é™¤å®Œæˆåç»§ç»­åˆ é™¤è‡ªå·±
    fs.rmdirSync(dir);
  }else{
    fs.unlinkSync(dir);
  }
}
removeDirSync('a');
````
## ğŸŒ¹ğŸŒ¹ flags ğŸš©
| ç¬¦å· | å«ä¹‰ |
| - | - |
| r	| è¯»æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸å­˜åœ¨æŠ¥é”™
| r+	| è¯»å–å¹¶å†™å…¥ï¼Œæ–‡ä»¶ä¸å­˜åœ¨æŠ¥é”™
| rs	| åŒæ­¥è¯»å–æ–‡ä»¶å¹¶å¿½ç•¥ç¼“å­˜
| w	| å†™å…¥æ–‡ä»¶ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå­˜åœ¨åˆ™æ¸…ç©º
| wx	| æ’å®ƒå†™å…¥æ–‡ä»¶
| w+	| è¯»å–å¹¶å†™å…¥æ–‡ä»¶ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå­˜åœ¨åˆ™æ¸…ç©º
| wx+	| å’Œw+ç±»ä¼¼ï¼Œæ’ä»–æ–¹å¼æ‰“å¼€
| a	| è¿½åŠ å†™å…¥
| ax	| ä¸aç±»ä¼¼ï¼Œæ’ä»–æ–¹å¼å†™å…¥
| a+	| è¯»å–å¹¶è¿½åŠ å†™å…¥ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
| ax+	| ä½œç”¨ä¸a+ç±»ä¼¼ï¼Œä½†æ˜¯ä»¥æ’ä»–æ–¹å¼æ‰“å¼€æ–‡ä»¶

## ğŸŒ¹ğŸŒ¹ é™„å½•
* r è¯»å–
* w å†™å…¥
* s åŒæ­¥
* + å¢åŠ ç›¸åæ“ä½œ
* x æ’ä»–æ–¹å¼
* r+ w+çš„åŒºåˆ«?
    * å½“æ–‡ä»¶ä¸å­˜åœ¨æ—¶ï¼Œr+ä¸ä¼šåˆ›å»ºï¼Œè€Œä¼šå¯¼è‡´è°ƒç”¨å¤±è´¥ï¼Œä½†w+ä¼šåˆ›å»ºã€‚
    * å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œr+ä¸ä¼šè‡ªåŠ¨æ¸…ç©ºæ–‡ä»¶ï¼Œä½†w+ä¼šè‡ªåŠ¨æŠŠå·²æœ‰æ–‡ä»¶çš„å†…å®¹æ¸…ç©ºã€‚

## ğŸŒ¹ğŸŒ¹ linuxæƒé™
### ğŸ‘€ æŸ¥çœ‹  
`ls -l`  `ls -l xxx.xx`  
### ğŸŒ° æ —å­ 
> `-rw-r--r--   1 bingyang  staff   12  7 16 17:18 CNAME`  
> æ–‡ä»¶ç±»å‹ä¸æƒé™	é“¾æ¥å ç”¨çš„èŠ‚ç‚¹(i-node) æ–‡ä»¶æ‰€æœ‰è€… æ–‡ä»¶æ‰€æœ‰è€…çš„ç”¨æˆ·ç»„ æ–‡ä»¶å¤§å° æ–‡ä»¶çš„åˆ›å»ºæ—¶é—´ æœ€è¿‘ä¿®æ”¹æ—¶é—´ æ–‡ä»¶åç§°  


# ğŸŒ¹ path
---
## ğŸŒ¹ğŸŒ¹ pathæ˜¯nodeä¸­ä¸“é—¨å¤„ç†è·¯å¾„çš„ä¸€ä¸ªæ ¸å¿ƒæ¨¡å—
* path.join å°†å¤šä¸ªå‚æ•°å€¼å­—ç¬¦ä¸²ç»“åˆä¸ºä¸€ä¸ªè·¯å¾„å­—ç¬¦ä¸²
* path.basename è·å–ä¸€ä¸ªè·¯å¾„ä¸­çš„æ–‡ä»¶å
* path.extname è·å–ä¸€ä¸ªè·¯å¾„ä¸­çš„æ‰©å±•å
* path.sep æ“ä½œç³»ç»Ÿæå®šçš„æ–‡ä»¶åˆ†éš”ç¬¦
* path.delimiter å±æ€§å€¼ä¸ºç³»ç»ŸæŒ‡å®šçš„ç¯å¢ƒå˜é‡è·¯å¾„åˆ†éš”ç¬¦
* path.normalize å°†éæ ‡å‡†çš„è·¯å¾„å­—ç¬¦ä¸²è½¬åŒ–ä¸ºæ ‡å‡†è·¯å¾„å­—ç¬¦ä¸² ç‰¹ç‚¹ï¼š
å¯ä»¥è§£æ . å’Œ ..
å¤šä¸ªæ å¯ä»¥è½¬æ¢æˆä¸€ä¸ªæ 
åœ¨windowsä¸‹åæ ä¼šè½¬åŒ–æˆæ­£æ 
å¦‚ç»“å°¾ä»¥æ ç»“å°¾çš„ï¼Œåˆ™ä¿ç•™æ–œæ 

* path.resolve
> ä»¥åº”ç”¨ç¨‹åºæ ¹ç›®å½•ä¸ºèµ·ç‚¹
å¦‚æœå‚æ•°æ˜¯æ™®é€šå­—ç¬¦ä¸²ï¼Œåˆ™æ„æ€æ˜¯å½“å‰ç›®å½•çš„ä¸‹çº§ç›®å½•
å¦‚æœå‚æ•°æ˜¯.. å›åˆ°ä¸Šä¸€çº§ç›®å½•
å¦‚æœæ˜¯/å¼€å¤´è¡¨ç¤ºä¸€ä¸ªç»å¯¹çš„æ ¹è·¯å¾„

````javascript
var path = require('path');
var fs = require('fs');
/**
 * normalize å°†éæ ‡å‡†åŒ–çš„è·¯å¾„è½¬åŒ–æˆæ ‡å‡†åŒ–çš„è·¯å¾„
 * 1.è§£æ. å’Œ ..
 * 2.å¤šä¸ªæ–œæ ä¼šè½¬æˆä¸€ä¸ªæ–œæ 
 * 3.windowä¸‹çš„æ–œæ ä¼šè½¬æˆæ­£æ–œæ 
 * 4.å¦‚æœä»¥æ–œæ ä¼šä¿ç•™
 **/

console.log(path.normalize('./a////b//..\\c//e//..//'));
//  \a\c\

//å¤šä¸ªå‚æ•°å­—ç¬¦ä¸²åˆå¹¶æˆä¸€ä¸ªè·¯å¾„ å­—ç¬¦ä¸²
console.log(path.join(__dirname,'a','b'));

/**
 * resolve
 * ä»¥å°±ç”¨ç¨‹åºä¸ºæ ¹ç›®å½•ï¼Œåšä¸ºèµ·ç‚¹ï¼Œæ ¹æ®å‚æ•°è§£æå‡ºä¸€ä¸ªç»å¯¹è·¯å¾„
 *  1.ä»¥åº”ç”¨ç¨‹åºä¸ºæ ¹èµ·ç‚¹
 *  2... .
 *  3. æ™®é€š å­—ç¬¦ä¸²ä»£è¡¨å­ç›®å½•
 *  4. /ä»£è¡¨ç»åœ°è·¯å¾„æ ¹ç›®å½•
 */
console.log(path.resolve());//ç©ºä»£è¡¨å½“å‰çš„ç›®å½• è·¯å¾„
console.log(path.resolve('a','/c'));// /a/b
// d:\c
//å¯ä»¥è·å–ä¸¤ä¸ªè·¯å¾„ä¹‹é—´çš„ç›¸å¯¹å…³ç³»
console.log(path.relative(__dirname,'/a'));
// a
//è¿”å›æŒ‡å®šè·¯å¾„çš„æ‰€åœ¨ç›®å½•
console.log(path.dirname(__filename)); // 9.path
console.log(path.dirname('./1.path.js'));//  9.path
//basename è·å–è·¯å¾„ä¸­çš„æ–‡ä»¶å
console.log(path.basename(__filename));
console.log(path.basename(__filename,'.js'));
console.log(path.extname(__filename));

console.log(path.sep);//æ–‡ä»¶åˆ†éš”ç¬¦ window \ linux /
console.log(path.win32.sep);
console.log(path.posix.sep);
console.log(path.delimiter);//è·¯å¾„ åˆ†éš”ç¬¦ window ; linux :
````
# ğŸŒ¹ æµ
---
## ğŸŒ¹ğŸŒ¹ æµçš„æ¦‚å¿µ
* æµæ˜¯ä¸€ç»„æœ‰åºçš„ï¼Œæœ‰èµ·ç‚¹å’Œç»ˆç‚¹çš„å­—èŠ‚æ•°æ®ä¼ è¾“æ‰‹æ®µ
* å®ƒä¸å…³å¿ƒæ–‡ä»¶çš„æ•´ä½“å†…å®¹ï¼Œåªå…³æ³¨æ˜¯å¦ä»æ–‡ä»¶ä¸­è¯»åˆ°äº†æ•°æ®ï¼Œä»¥åŠè¯»åˆ°æ•°æ®ä¹‹åçš„å¤„ç†
* æµæ˜¯ä¸€ä¸ªæŠ½è±¡æ¥å£ï¼Œè¢« Node ä¸­çš„å¾ˆå¤šå¯¹è±¡æ‰€å®ç°ã€‚æ¯”å¦‚HTTP æœåŠ¡å™¨requestå’Œresponseå¯¹è±¡éƒ½æ˜¯æµã€‚

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ Nodeä¸­å››ç§åŸºæœ¬çš„æµç±»å‹
* Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ `fs.createReadStream()`).
* Writable - å¯å†™çš„æµ (ä¾‹å¦‚ `fs.createWriteStream()`).
* Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ `net.Socket`).
* Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplexæµ (ä¾‹å¦‚ `zlib.createDeflate()`).

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ æµä¸­çš„æ•°æ®æœ‰ä¸¤ç§æ¨¡å¼,äºŒè¿›åˆ¶æ¨¡å¼å’Œå¯¹è±¡æ¨¡å¼
* äºŒè¿›åˆ¶æ¨¡å¼ï¼šæ¯ä¸ªåˆ†å—éƒ½æ˜¯bufferæˆ–è€…stringå¯¹è±¡.
* å¯¹è±¡æ¨¡å¼ï¼šæµå†…éƒ¨å¤„ç†çš„æ˜¯ä¸€ç³»åˆ—æ™®é€šå¯¹è±¡.
>æ‰€æœ‰ä½¿ç”¨ Node.js API åˆ›å»ºçš„æµå¯¹è±¡éƒ½åªèƒ½æ“ä½œ strings å’Œ Bufferå¯¹è±¡ã€‚ä½†æ˜¯ï¼Œé€šè¿‡ä¸€äº›ç¬¬ä¸‰æ–¹æµçš„å®ç°ï¼Œä½ ä¾ç„¶èƒ½å¤Ÿå¤„ç†å…¶å®ƒç±»å‹çš„ JavaScript å€¼ (é™¤äº† nullï¼Œå®ƒåœ¨æµå¤„ç†ä¸­æœ‰ç‰¹æ®Šæ„ä¹‰)ã€‚ è¿™äº›æµè¢«è®¤ä¸ºæ˜¯å·¥ä½œåœ¨ â€œå¯¹è±¡æ¨¡å¼â€ï¼ˆobject modeï¼‰ã€‚ åœ¨åˆ›å»ºæµçš„å®ä¾‹æ—¶ï¼Œå¯ä»¥é€šè¿‡ objectMode é€‰é¡¹ä½¿æµçš„å®ä¾‹åˆ‡æ¢åˆ°å¯¹è±¡æ¨¡å¼ã€‚è¯•å›¾å°†å·²ç»å­˜åœ¨çš„æµåˆ‡æ¢åˆ°å¯¹è±¡æ¨¡å¼æ˜¯ä¸å®‰å…¨çš„ã€‚

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ å¯è¯»æµçš„ä¸¤ç§æ¨¡å¼
å¯è¯»æµäº‹å®ä¸Šå·¥ä½œåœ¨ä¸‹é¢ä¸¤ç§æ¨¡å¼ä¹‹ä¸€ï¼š`flowing` å’Œ `paused`
* åœ¨ `flowing` æ¨¡å¼ä¸‹ï¼Œ å¯è¯»æµè‡ªåŠ¨ä»ç³»ç»Ÿåº•å±‚è¯»å–æ•°æ®ï¼Œå¹¶é€šè¿‡ `EventEmitter` æ¥å£çš„äº‹ä»¶å°½å¿«å°†æ•°æ®æä¾›ç»™åº”ç”¨ã€‚
* åœ¨ `paused` æ¨¡å¼ä¸‹ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨ `stream.read()` æ–¹æ³•æ¥ä»æµä¸­è¯»å–æ•°æ®ç‰‡æ®µã€‚
* æ‰€æœ‰åˆå§‹å·¥ä½œæ¨¡å¼ä¸º paused çš„ Readable æµï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰ç§é€”å¾„åˆ‡æ¢åˆ° flowing æ¨¡å¼ï¼š
    * ç›‘å¬ `data` äº‹ä»¶
    * `stream.resume()` æ–¹æ³•
    * è°ƒç”¨ `stream.pipe()` æ–¹æ³•å°†æ•°æ®å‘é€åˆ° Writable
* å¯è¯»æµå¯ä»¥é€šè¿‡ä¸‹é¢é€”å¾„åˆ‡æ¢åˆ° paused æ¨¡å¼ï¼š
    * å¦‚æœä¸å­˜åœ¨ç®¡é“ç›®æ ‡ï¼ˆpipe destinationï¼‰ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ `stream.pause()` æ–¹æ³•å®ç°ã€‚
    * å¦‚æœå­˜åœ¨ç®¡é“ç›®æ ‡ï¼Œå¯ä»¥é€šè¿‡å–æ¶ˆ 'data' äº‹ä»¶ç›‘å¬ï¼Œå¹¶è°ƒç”¨ `stream.unpipe()` æ–¹æ³•ç§»é™¤æ‰€æœ‰ç®¡é“ç›®æ ‡æ¥å®ç°ã€‚

> å¦‚æœ Readable åˆ‡æ¢åˆ° flowing æ¨¡å¼ï¼Œä¸”æ²¡æœ‰æ¶ˆè´¹è€…å¤„ç†æµä¸­çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®å°†ä¼šä¸¢å¤±ã€‚ æ¯”å¦‚ï¼Œ è°ƒç”¨äº† `readable.resume()` æ–¹æ³•å´æ²¡æœ‰ç›‘å¬ 'data' äº‹ä»¶ï¼Œæˆ–æ˜¯å–æ¶ˆäº† 'data' äº‹ä»¶ç›‘å¬ï¼Œå°±æœ‰å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µã€‚

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ ç¼“å­˜åŒº
* Writable å’Œ Readable æµéƒ½ä¼šå°†æ•°æ®å­˜å‚¨åˆ°å†…éƒ¨çš„ç¼“å†²å™¨ï¼ˆbufferï¼‰ä¸­ã€‚è¿™äº›ç¼“å†²å™¨å¯ä»¥ é€šè¿‡ç›¸åº”çš„ `writable._writableState.getBuffer()` æˆ– `readable._readableState.buffer` æ¥è·å–ã€‚
* ç¼“å†²å™¨çš„å¤§å°å–å†³äºä¼ é€’ç»™æµæ„é€ å‡½æ•°çš„ highWaterMark é€‰é¡¹ã€‚ å¯¹äºæ™®é€šçš„æµï¼Œ highWaterMark é€‰é¡¹æŒ‡å®šäº†æ€»å…±çš„å­—èŠ‚æ•°ã€‚å¯¹äºå·¥ä½œåœ¨å¯¹è±¡æ¨¡å¼çš„æµï¼Œ highWaterMark æŒ‡å®šäº†å¯¹è±¡çš„æ€»æ•°ã€‚
* å½“å¯è¯»æµçš„å®ç°è°ƒç”¨ `stream.push(chunk)`æ–¹æ³•æ—¶ï¼Œæ•°æ®è¢«æ”¾åˆ°ç¼“å†²å™¨ä¸­ã€‚å¦‚æœæµçš„æ¶ˆè´¹è€…æ²¡æœ‰è°ƒç”¨ `stream.read()` æ–¹æ³•ï¼Œ è¿™äº›æ•°æ®ä¼šå§‹ç»ˆå­˜åœ¨äºå†…éƒ¨é˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°è¢«æ¶ˆè´¹ã€‚
* å½“å†…éƒ¨å¯è¯»ç¼“å†²å™¨çš„å¤§å°è¾¾åˆ° highWaterMark æŒ‡å®šçš„é˜ˆå€¼æ—¶ï¼Œæµä¼šæš‚åœä»åº•å±‚èµ„æºè¯»å–æ•°æ®ï¼Œç›´åˆ°å½“å‰ç¼“å†²å™¨çš„æ•°æ®è¢«æ¶ˆè´¹ (ä¹Ÿå°±æ˜¯è¯´ï¼Œ æµä¼šåœ¨å†…éƒ¨åœæ­¢è°ƒç”¨ `readable._read()` æ¥å¡«å……å¯è¯»ç¼“å†²å™¨)ã€‚
* å¯å†™æµé€šè¿‡åå¤è°ƒç”¨ `writable.write(chunk)` æ–¹æ³•å°†æ•°æ®æ”¾åˆ°ç¼“å†²å™¨ã€‚ å½“å†…éƒ¨å¯å†™ç¼“å†²å™¨çš„æ€»å¤§å°å°äº highWaterMark æŒ‡å®šçš„é˜ˆå€¼æ—¶ï¼Œ è°ƒç”¨ `writable.write()` å°†è¿”å›trueã€‚ ä¸€æ—¦å†…éƒ¨ç¼“å†²å™¨çš„å¤§å°è¾¾åˆ°æˆ–è¶…è¿‡ highWaterMark ï¼Œè°ƒç”¨ `writable.write()` å°†è¿”å› false ã€‚
* stream API çš„å…³é”®ç›®æ ‡ï¼Œ å°¤å…¶å¯¹äº `stream.pipe()` æ–¹æ³•ï¼Œ å°±æ˜¯é™åˆ¶ç¼“å†²å™¨æ•°æ®å¤§å°ï¼Œä»¥è¾¾åˆ°å¯æ¥å—çš„ç¨‹åº¦ã€‚è¿™æ ·ï¼Œå¯¹äºè¯»å†™é€Ÿåº¦ä¸åŒ¹é…çš„æºå¤´å’Œç›®æ ‡ï¼Œå°±ä¸ä¼šè¶…å‡ºå¯ç”¨çš„å†…å­˜å¤§å°ã€‚
* Duplex å’Œ Transform éƒ½æ˜¯å¯è¯»å†™çš„ã€‚ åœ¨å†…éƒ¨ï¼Œå®ƒä»¬éƒ½ç»´æŠ¤äº† ä¸¤ä¸ª ç›¸äº’ç‹¬ç«‹çš„ç¼“å†²å™¨ç”¨äºè¯»å’Œå†™ã€‚ åœ¨ç»´æŒäº†åˆç†é«˜æ•ˆçš„æ•°æ®æµçš„åŒæ—¶ï¼Œä¹Ÿä½¿å¾—å¯¹äºè¯»å’Œå†™å¯ä»¥ç‹¬ç«‹è¿›è¡Œè€Œäº’ä¸å½±å“ã€‚

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ å¯è¯»æµçš„ä¸‰ç§çŠ¶æ€
* åœ¨ä»»æ„æ—¶åˆ»ï¼Œä»»æ„å¯è¯»æµåº”ç¡®åˆ‡å¤„äºä¸‹é¢ä¸‰ç§çŠ¶æ€ä¹‹ä¸€ï¼š
````
readable._readableState.flowing = null
readable._readableState.flowing = false
readable._readableState.flowing = true
````
* è‹¥ `readable._readableState.flowing` ä¸º nullï¼Œç”±äºä¸å­˜åœ¨æ•°æ®æ¶ˆè´¹è€…ï¼Œå¯è¯»æµå°†ä¸ä¼šäº§ç”Ÿæ•°æ®ã€‚ åœ¨è¿™ä¸ªçŠ¶æ€ä¸‹ï¼Œç›‘å¬ `data` äº‹ä»¶ï¼Œè°ƒç”¨ `readable.pipe()` æ–¹æ³•ï¼Œæˆ–è€…è°ƒç”¨ `readable.resume()` æ–¹æ³•ï¼Œ readable._readableState.flowing çš„å€¼å°†ä¼šå˜ä¸º true ã€‚è¿™æ—¶ï¼Œéšç€æ•°æ®ç”Ÿæˆï¼Œå¯è¯»æµå¼€å§‹é¢‘ç¹è§¦å‘äº‹ä»¶ã€‚
* è°ƒç”¨ `readable.pause()` æ–¹æ³•ï¼Œ `readable.unpipe()` æ–¹æ³•ï¼Œ æˆ–è€…æ¥æ”¶ â€œèƒŒå‹â€ï¼ˆback pressureï¼‰ï¼Œ å°†å¯¼è‡´ readable._readableState.flowing å€¼å˜ä¸º falseã€‚ è¿™å°†æš‚åœäº‹ä»¶æµï¼Œä½† ä¸ä¼š æš‚åœæ•°æ®ç”Ÿæˆã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸º `data` äº‹ä»¶è®¾ç½®ç›‘å¬å‡½æ•°ä¸ä¼šå¯¼è‡´ `readable._readableState.flowing` å˜ä¸º trueã€‚

å½“ readable._readableState.flowing å€¼ä¸º false æ—¶ï¼Œ æ•°æ®å¯èƒ½å †ç§¯åˆ°æµçš„å†…éƒ¨ç¼“å­˜ä¸­ã€‚

## ğŸŒ¹ğŸŒ¹ å¯è¯»æµ createReadStream
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ åˆ›å»ºå¯è¯»æµ
````javascript
let fs = require('fs');
// åˆ›å»ºå¯è¯»æµ è‡ªå·±è¯»å–ï¼Œæˆ–è€…ç­‰å¾…å‘å°„ 
// è¿”å›çš„å°±æ˜¯ä¸€ä¸ªå¯è¯»æµ
let rs = fs.createReadStream('1.txt', {
  flags: 'r', // å¦‚ä½•æ“ä½œæ–‡ä»¶
  encoding: null, // è¯»å–æ–‡ä»¶çš„ç¼–ç æ ¼å¼ é»˜è®¤buffer
  autoClose: true, // è¯»å–å®Œæ¯•å æ˜¯å¦è‡ªåŠ¨å…³é—­
  start: 0, // å¼€å§‹è¯»å–çš„ä½ç½®
  end: 15, // ç»“æŸä½ç½®( åŒ…å )
  highWaterMark: 4 // 64kæ¯æ¬¡é»˜è®¤è¯»å–64k
});
````
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ ç›‘å¬äº‹ä»¶
1. ç›´æ¥ç›‘å¬dataäº‹ä»¶ (newListener=> å†…éƒ¨ä¼šè‡ªåŠ¨è§¦å‘dataäº‹ä»¶) 
````javascript
// ç›¸å½“äºæµåŠ¨æ¨¡å¼,ç›‘å¬dataæ–¹æ³•åä¸åœçš„è§¦å‘ ç›´åˆ°è¯»å–å®Œæ¯•ä¸ºæ­¢
// let arrs = [];
// rs.setEncoding('utf8');
rs.on('data', (data) => {
  //arrs.push(data);
  rs.pause(); // å¯ä»¥æš‚åœdataäº‹ä»¶çš„è§¦å‘
  setTimeout(() => {
    console.log('æ¢å¤')
    rs.resume(); // æ¢å¤çš„ä¹Ÿæ˜¯dataäº‹ä»¶
  }, 1000);
});
````
2.  ç›‘å¬endäº‹ä»¶
è¯¥äº‹ä»¶ä¼šåœ¨è¯»å®Œæ•°æ®åè¢«è§¦å‘
````javascript
rs.on('end', function () {
  // æ‹¼æ¥åå°†ç»“æœä¸€èµ·æ‰“å°å‡ºæ¥
  console.log(Buffer.concat(arrs).toString());
});
````
3. ç›‘å¬erroräº‹ä»¶
````javascript
rs.on('error', function (err) {
    console.log(err);
});
````
4. ç›‘å¬openäº‹ä»¶
````javascript
rs.on('open', function () {
    console.log(err);
});
````
5. ç›‘å¬closeäº‹ä»¶
````javascript
rs.on('close', function () {
    console.log(err);
});
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ å…¶ä»–äº‹ä»¶
1. è®¾ç½®ç¼–ç 
ä¸æŒ‡å®š `{encoding:'utf8'}`æ•ˆæœç›¸åŒï¼Œè®¾ç½®ç¼–ç 
````javascript
rs.setEncoding('utf8');
````
2. æš‚åœå’Œæ¢å¤è§¦å‘data
`é€šè¿‡pause()æ–¹æ³•å’Œresume()æ–¹æ³•`
````javascript
rs.on('data', function (data) {
    rs.pause();
    console.log(data);
});
setTimeout(function () {
    rs.resume();
},2000);
````
## ğŸŒ¹ğŸŒ¹ è‡ªå·±å†™ä¸ªå¯è¯»æµ 
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ ç®€å•å®ç° ReadStream  

````javascript
let EventEmitter = require('events');
let fs = require('fs');
class ReadStream extends EventEmitter{
  constructor(path,options = {}){
    super();
    this.path = path;
    this.flags = options.flags || 'r';
    this.encoding = options.encoding || null;
    this.autoClose = options.autoClose || true;
    // this.start = options.start || 0;
    // this.end = options.end|| null;
    this.highWaterMark = options.highWaterMark|| 64*1024;

    // è¯»å–æ–‡ä»¶ 1.æ‰“å¼€æ–‡ä»¶
    this.open();
    // å½“ç”¨æˆ·ç›‘å¬äº†on('data')äº‹ä»¶çš„æ—¶å€™ å°±ä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶
    this.on('newListener',(type)=>{
      if(type === 'data'){
        this.read(); // è¯»å–æ–‡ä»¶å†…å®¹ å¹¶å‘å°„å‡ºæ¥
      }
    })
  }
  read(){ // æ ¸å¿ƒçš„è¯»å–æ–¹æ³•
    if(typeof this.fd !== 'number'){
      return this.once('open',()=>this.read())
    }
    let buffer = Buffer.alloc(3);
    fs.read(this.fd, buffer,0,3,0,(err,byteRead)=>{
      this.emit('data', buffer);
    })
  }
  destroy(){
    if (typeof this.fd == 'number'){
      fs.close(this.fd,()=>{
        this.emit('close');
      })
    }else{
      this.emit('close');
    }
  }
  open(){
    fs.open(this.path,this.flags,(err,fd)=>{
      if(err){ // æ‰“å¼€æ–‡ä»¶å‡ºé”™
        this.emit('error',err);
        this.destroy(); // å†™ä¸ªé€šç”¨çš„ å› ä¸ºè¯»å–å®Œæ¯•åä¹Ÿéœ€è¦å…³é—­æ–‡ä»¶
        return;
      }
      this.fd = fd; // ä¿å­˜æ–‡ä»¶æè¿°ç¬¦ æ–‡ä»¶æ‰“å¼€äº†
      this.emit('open'); // è§¦å‘å¼€å¯äº‹ä»¶
    });
  }
}
module.exports = ReadStream;
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ è¿›é˜¶å®ç° æš‚åœæ¨¡å¼ ReadStream  

````javascript
let EventEmitter = require('events');
let fs = require('fs');
class ReadStream extends EventEmitter {
  constructor(path, options = {}) {
    super();
    this.path = path;
    this.flags = options.flags || 'r';
    this.encoding = options.encoding || null;
    this.mode = options.mode || 0o666
    this.start = options.start || 0;
    this.end = options.end || null;
    this.highWaterMark = options.highWaterMark || 64 * 1024;
    this.autoClose = options.autoClose || true;
    // å®šä¹‰ä¸€ä¸ªæ§åˆ¶è¯»å–çš„åç§»é‡ é»˜è®¤å’Œstartæ˜¯ä¸€æ ·çš„
    this.pos = this.start;

    // é»˜è®¤å«éæµåŠ¨æ¨¡å¼ å°±æ˜¯ä¸å‡ºç»“æœï¼Œåªæœ‰on('data') æ—¶ flowingçš„å€¼å˜ä¸º true
    this.flowing = null;

    this.open(); //1sä¹‹åæ‰èƒ½è·å– æ‹¿åˆ°fdæ“ä½œç¬¦å·çš„ fdé»˜è®¤æ˜¯å¼‚æ­¥è·å–çš„ this.emit('open')

    this.buffer = Buffer.alloc(this.highWaterMark);
    this.on('newListener', (type) => {
      // ç”¨æˆ·ç›‘å¬äº†dataäº‹ä»¶
      if (type === 'data') {
        this.flowing = true;
        this.read();
      }
    })
  }
  read() { //è¯»å–æ•°æ®
    // åˆ©ç”¨å‘å¸ƒè®¢é˜…çš„æ¨¡å¼ å½“æŸä¸ªå€¼æœ‰äº†åé€šçŸ¥æˆ‘ç»§ç»­è¯»å–
    if (typeof this.fd !== 'number') {
      return this.once('open', () => this.read());
    }
    // æˆ‘ä»¬éœ€è¦æä¸€ä¸ªbufferç”¨æ¥å­˜æ”¾è¯»å–åˆ°çš„å†…å®¹ï¼Œä¸ºäº†æ€§èƒ½å¥½ï¼Œæ¯æ¬¡ç”¨åŒä¸€ä¸ªå†…å­˜
    // 1 2 3  this.pos = 3
    // 4 5 6  this.pos = 6
    // 7 æ¯æ¬¡è¯»å–çš„æ—¶å€™è¦çœ‹ä¸€ä¸‹è¿˜è¦è¯»å¤šå°‘ä¸ª Math.min


    let howMuchToRead = this.end ? Math.min(this.highWaterMark, this.end - this.pos + 1) : this.highWaterMark;
    // æ¯æ¬¡è¯»å–çš„ä¸ªæ•°
    fs.read(this.fd, this.buffer, 0, howMuchToRead, this.pos, (err, byteReads) => { // byteReadsçœŸå®è¯»å–åˆ°çš„ä¸ªæ•°
      // å¯ä»¥æ‹¿åˆ°è¯»å–çš„å†…å®¹äº† this.buffer
      if (byteReads>0){
        this.pos += byteReads;
        let r = this.buffer.slice(0, byteReads); // æˆªå–æœ‰æ•ˆçš„å­—èŠ‚
        r = this.encoding ? r.toString(this.encoding) : r
        this.emit('data', r);// å‘å°„è¯»å–åˆ°çš„ç»“æœ

        // åˆ¤æ–­æ˜¯å¦æ˜¯æµåŠ¨æ¨¡å¼ 
        if (this.flowing) {
          this.read();
        }
      }else{
        this.emit('end');
        if(this.autoClose){
          this.destroy();
        }
      }
    });
  }
  resume() {
    this.flowing = true;
    this.read();
  }
  pause(){
    this.flowing = false
  }
  destroy() { // ç”¨æ¥å…³é—­çš„
    if (typeof this.fd === 'number') {
      fs.close(this.fd, () => {
        this.emit('close');
      });
    } else {
      this.emit('close');
    }
  }
  open() {
    fs.open(this.path, this.flags, (err, fd) => {
      if (err) {
        // å¦‚æœæ‰“å¼€æ–‡ä»¶å‡ºé”™å°±å‘å°„ é”™è¯¯äº‹ä»¶
        this.emit('error', err);
        // å¦‚æœéœ€è¦è‡ªåŠ¨å…³é—­ å…³é—­æ–‡ä»¶
        if (this.autoClose) {
          this.destroy();
        }
        return;
      }
      this.fd = fd;
      this.emit('open', this.fd); // å½“å‰fdæ‹¿åˆ°äº†ï¼Œå¹¶ä¸”è§¦å‘openäº‹ä»¶
    })
  }
  pipe(ws){
    this.on('data',function (data) {
      let flag = ws.write(data);
      if(!flag){
        this.pause();
      }
    });
    ws.on('drain', () => {
      this.resume();
    });
  }
}

module.exports = ReadStream
````

## ğŸŒ¹ğŸŒ¹ å¯å†™æµ createWriteStream

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ åˆ›å»ºå¯å†™æµ
1. ç¬¬ä¸€æ¬¡è°ƒç”¨write ä¼šçœŸçš„åƒæ–‡ä»¶é‡Œå†™å…¥ ï¼Œä¹‹åå†™åˆ°ç¼“å­˜ä¸­[]
2. å†™å…¥æ—¶ ä¼šæ‹¿å½“å‰å†™å…¥çš„å†…å®¹çš„é•¿åº¦å’ŒhighWaterMarkæ¯”ï¼Œå¦‚æœå°äºhightWaterMark,ä¼šè¿”å›true >=ä¼šè¿”å›false
3. å¦‚æœå½“å‰å†™å…¥çš„ä¸ªæ•°å¤§äºäº†highWaterMarkä¼šè§¦å‘drainäº‹ä»¶ 
4. å½“æ–‡ä»¶ä¸­çš„å†…å®¹å†™å®Œå ä¼šæ¸…ç©ºç¼“å­˜
````javascript
let fs = require('fs')

let ws = fs.createWriteStream('2.txt',{
  flags:'w', // å¼€å¯æ–‡ä»¶åšä»€ä¹ˆæ“ä½œ
  encoding:'utf8', // å½“å‰å†™å…¥çš„ç¼–ç 
  autoClose:true, // æ˜¯å¦è¯»å–å®Œæ¯•åè‡ªåŠ¨å…³é—­
  start:0,// ä»å“ªä¸ªä½ç½®å†™å…¥
  mode:0o666, // å¯è¯»å¯å†™
  highWaterMark:3 // æœ€é«˜æ°´ä½çº¿ (é¢„è®¡å ç”¨çš„å­—èŠ‚æ•°) é»˜è®¤16*1024
});
// å†™ writeæ–¹æ³•åªèƒ½å†™å…¥  å­—ç¬¦ä¸²æˆ–è€…buffer
// å‘ä¸€ä¸ªæ–‡ä»¶é‡Œå†™å…¥ä¹ä¸ªæ•° 123456789
let flag = ws.write('123456789','utf8'); // å¼‚æ­¥æ“ä½œ

ws.on('drain',function () {
  console.log('æŠ½å¹²')
})
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ writeæ–¹æ³•
`ws.write(chunk,[encoding],[callback]);`
1. chunkå†™å…¥çš„æ•°æ®buffer/string
2. encodingç¼–ç æ ¼å¼chunkä¸ºå­—ç¬¦ä¸²æ—¶æœ‰ç”¨ï¼Œå¯é€‰
3. callback å†™å…¥æˆåŠŸåçš„å›è°ƒ
> è¿”å›å€¼ä¸ºå¸ƒå°”å€¼ï¼Œç³»ç»Ÿç¼“å­˜åŒºæ»¡æ—¶ä¸ºfalse,æœªæ»¡æ—¶ä¸ºtrue

````javascript
let flag = ws.write('123456789','utf8'); // å¼‚æ­¥æ“ä½œ
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ endæ–¹æ³•
`ws.end(chunk,[encoding],[callback]);`
è¡¨æ˜æ¥ä¸‹æ¥æ²¡æœ‰æ•°æ®è¦è¢«å†™å…¥ Writable é€šè¿‡ä¼ å…¥å¯é€‰çš„ chunk å’Œ encoding å‚æ•°ï¼Œå¯ä»¥åœ¨å…³é—­æµä¹‹å‰å†å†™å…¥ä¸€æ®µæ•°æ® å¦‚æœä¼ å…¥äº†å¯é€‰çš„ callback å‡½æ•°ï¼Œå®ƒå°†ä½œä¸º 'finish' äº‹ä»¶çš„å›è°ƒå‡½æ•°
````javascript
let fs = require('fs');
let WS = require('./writeStream');
let ws = fs.createWriteStream('2.txt',{
  highWaterMark:3
});
let i = 9;
function write() {
  let flag = true;
  while (i>0 && flag) {
    flag = ws.write(i--+'');
  }
}
write();
ws.end('hello'); // ç»“æŸäº† ä¼šè®²ç¼“å­˜åŒºçš„å†…å®¹å…¨éƒ¨æ¸…ç©º,è§¦å‘endåä¸ä¼šå†è§¦å‘drainäº‹ä»¶

// ws.on('drain',()=>{
//   console.log('å¹²äº†');
//   write();
// });

// ws.write() ws.end() ws.on('drain');

````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ drainæ–¹æ³•
å¦‚æœå½“å‰å†™å…¥çš„ä¸ªæ•°å¤§äºäº†highWaterMarkä¼šè§¦å‘drainäº‹ä»¶ 
`ws.on('drain',callback)`
1. å½“ä¸€ä¸ªæµä¸å¤„åœ¨ drain çš„çŠ¶æ€ï¼Œ å¯¹ write() çš„è°ƒç”¨ä¼šç¼“å­˜æ•°æ®å—ï¼Œ å¹¶ä¸”è¿”å› falseã€‚ ä¸€æ—¦æ‰€æœ‰å½“å‰æ‰€æœ‰ç¼“å­˜çš„æ•°æ®å—éƒ½æ’ç©ºäº†ï¼ˆè¢«æ“ä½œç³»ç»Ÿæ¥å—æ¥è¿›è¡Œè¾“å‡ºï¼‰ï¼Œ é‚£ä¹ˆ 'drain' äº‹ä»¶å°±ä¼šè¢«è§¦å‘
2. å»ºè®®ï¼Œ ä¸€æ—¦ write() è¿”å› falseï¼Œ åœ¨ 'drain' äº‹ä»¶è§¦å‘å‰ï¼Œ ä¸èƒ½å†™å…¥ä»»ä½•æ•°æ®å—

````javascript
// ws.on('drain',function () {
//   console.log('æŠ½å¹²')
// })
let fs = require('fs');
let ws = fs.createWriteStream('./2.txt',{
  flags:'w',
  encoding:'utf8',
  highWaterMark:3
});
let i = 10;
function write(){
 let  flag = true;
 while(i&&flag){
      flag = ws.write("1");
      i--;
     console.log(flag);
 }
}
write();
ws.on('drain',()=>{
  console.log("drain");
  write();
});
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ finishæ–¹æ³•
åœ¨è°ƒç”¨äº† stream.end() æ–¹æ³•ï¼Œä¸”ç¼“å†²åŒºæ•°æ®éƒ½å·²ç»ä¼ ç»™åº•å±‚ç³»ç»Ÿä¹‹åï¼Œ 'finish' äº‹ä»¶å°†è¢«è§¦å‘ã€‚

````javascript
var writer = fs.createWriteStream('./2.txt');
for (let i = 0; i < 100; i++) {
  writer.write(`hello, ${i}!\n`);
}
writer.end('ç»“æŸ\n');
writer.on('finish', () => {
  console.error('æ‰€æœ‰çš„å†™å…¥å·²ç»å®Œæˆ!');
});
````

## ğŸŒ¹ğŸŒ¹ pipeç”¨æ³•
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ pipeç”¨æ³•
````javascript
readStream.pipe(writeStream);
var from = fs.createReadStream('./1.txt'); // è¯»æµ
var to = fs.createWriteStream('./2.txt'); // å†™æµ
from.pipe(to);
````
> å°†æ•°æ®çš„æ»ç•™é‡é™åˆ¶åˆ°ä¸€ä¸ªå¯æ¥å—çš„æ°´å¹³ï¼Œä»¥ä½¿å¾—ä¸åŒé€Ÿåº¦çš„æ¥æºå’Œç›®æ ‡ä¸ä¼šæ·¹æ²¡å¯ç”¨å†…å­˜ã€‚

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ unpipeç”¨æ³•
* readable.unpipe()æ–¹æ³•å°†ä¹‹å‰é€šè¿‡stream.pipe()æ–¹æ³•ç»‘å®šçš„æµåˆ†ç¦»
* å¦‚æœ destination æ²¡æœ‰ä¼ å…¥, åˆ™æ‰€æœ‰ç»‘å®šçš„æµéƒ½ä¼šè¢«åˆ†ç¦».

````javascript
let fs = require('fs');
var from = fs.createReadStream('./1.txt');
var to = fs.createWriteStream('./2.txt');
from.pipe(to);
setTimeout(() => {
  console.log('å…³é—­å‘2.txtçš„å†™å…¥');
  from.unpipe(writable);
  console.log('æ‰‹å·¥å…³é—­æ–‡ä»¶æµ');
  to.end();
}, 1000);
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ cork å’Œ uncork
* è°ƒç”¨ `writable.cork()` æ–¹æ³•å°†å¼ºåˆ¶æ‰€æœ‰å†™å…¥æ•°æ®éƒ½å­˜æ”¾åˆ°å†…å­˜ä¸­çš„ç¼“å†²åŒºé‡Œã€‚ ç›´åˆ°è°ƒç”¨ `stream.uncork()` æˆ– `stream.end()` æ–¹æ³•æ—¶ï¼Œç¼“å†²åŒºé‡Œçš„æ•°æ®æ‰ä¼šè¢«è¾“å‡ºã€‚
* writable.uncork()å°†è¾“å‡ºåœ¨stream.cork()æ–¹æ³•è¢«è°ƒç”¨ä¹‹åç¼“å†²åœ¨å†…å­˜ä¸­çš„æ‰€æœ‰æ•°æ®

````javascript
stream.cork();
stream.write('1');
stream.write('2');
process.nextTick(() => stream.uncork());
````

## ğŸŒ¹ğŸŒ¹ è‡ªå·±å®ç°å¯å†™æµ WriteStream
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ ç®€å•å®ç° WriteStream
````javascript
let fs = require('fs');
let EventEmitter = require('events');

class WriteStream extends EventEmitter {
  constructor(path, options) {
    super();
    this.path = path;
    this.flags = options.flags || 'w';
    this.encoding = options.encoding || 'utf8';
    this.highWaterMark = options.highWaterMark || 16 * 1024
    this.mode = options.mode || 0o666;
    this.autoClose = options.autoClose || true;
    this.start = options.start || 0;
    this.pos = this.start;
    this.writing = false;
    // å½“æ–‡ä»¶æ­£åœ¨è¢«å†™å…¥çš„æ—¶å€™ è¦å°†å…¶ä»–å†™å…¥çš„å†…å®¹æ”¾åˆ°ç¼“å­˜åŒºä¸­
    this.cache = [];
    // é»˜è®¤æƒ…å†µä¸‹ä¸ä¼šè§¦å‘drainäº‹ä»¶ åªæœ‰å½“å†™å…¥çš„é•¿åº¦ç­‰äºhighWaterMarkæ—¶æ‰ä¼šè§¦å‘
    this.needDrain = false;
    this.len = 0;
    this.open(); // fd
  }
  destroy() {
    if (typeof this.fd === 'number') {
      fs.close(this.fd, () => {
        this.emit('close');
      })
    } else {
      this.emit('close');
    }
  }
  open() {
    fs.open(this.path, this.flags, (err, fd) => {
      if (err) {
        this.emit('error');
        if (this.autoClose) {
          this.destroy();
        }
        return;
      }
      this.fd = fd;
      this.emit('open', this.fd);
    })
  }
  write(chunk, encoding="utf8", callback=()=>{}) {
    // å…ˆåˆ¤æ–­æ²¡æœ‰å†™å…¥çš„å†…å®¹å’ŒhighWateræ¥æ¯”è¾ƒ
    chunk = Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk);
    this.len += chunk.length;
    if (this.len >= this.highWaterMark) {
      this.needDrain = true;
    }
    if (this.writing) {
      this.cache.push({
        chunk,
        encoding,
        callback
      });
    } else {
      // æ²¡æœ‰æ­£åœ¨å†™å…¥
      this.writing = true;
      this._write(chunk, encoding, () => {
        callback();
        this.clearBuffer(); // æ¸…ç©ºæ•°ç»„é‡Œçš„ä¸‹ä¸€é¡¹
      });
    }
    // ç¬¬ä¸€æ¬¡å¾€æ–‡ä»¶é‡Œå†™å…¥ï¼Œç¬¬äºŒæ¬¡æ”¾åˆ°ç¼“å­˜åŒºä¸­

    return this.len < this.highWaterMark
  }
  clearBuffer(){
    let obj = this.cache.shift();
    if(obj){
      this._write(obj.chunk, obj.encoding,()=>{
        obj.callback();
        this.clearBuffer();
      })
    }else{
      if(this.needDrain){ // æ˜¯å¦éœ€è¦è§¦å‘drain
        this.writing = false; // è§¦å‘drainåä¸‹æ¬¡å†æ¬¡å†™å…¥æ—¶ å¾€æ–‡ä»¶é‡Œå†™å…¥
        this.emit('drain'); // è§¦å‘drainäº‹ä»¶
      }
    }
  }
  _write(chunk, encoding, callback) {
    if (typeof this.fd !== 'number') {
      return this.once('open', () => this._write(chunk, encoding, callback));
    }
    fs.write(this.fd, chunk, 0, chunk.length, this.pos, (err, byteWritten) => {
      this.pos += byteWritten; // ç§»åŠ¨å†™å…¥çš„åç§»é‡
      this.len -= byteWritten; // å‡å°‘æ²¡æœ‰å†™å…¥çš„ä¸ªæ•°
      callback();  // æ¸…ç©ºç¼“å­˜åŒºçš„å†…å®¹
    });
  }
}
module.exports = WriteStream;
````

## ğŸŒ¹ğŸŒ¹ Readableæ¨¡å¼ 
'readable' äº‹ä»¶å°†åœ¨æµä¸­æœ‰æ•°æ®å¯ä¾›è¯»å–æ—¶è§¦å‘ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸º 'readable' äº‹ä»¶æ·»åŠ å›è°ƒå°†ä¼šå¯¼è‡´ä¸€äº›æ•°æ®è¢«è¯»å–åˆ°å†…éƒ¨ç¼“å­˜ä¸­ã€‚
````javascript
const readable = getReadableStreamSomehow();
readable.on('readable', () => {
  // æœ‰ä¸€äº›æ•°æ®å¯è¯»äº†
});
````
* å½“åˆ°è¾¾æµæ•°æ®å°¾éƒ¨æ—¶ï¼Œ 'readable' äº‹ä»¶ä¹Ÿä¼šè§¦å‘ã€‚è§¦å‘é¡ºåºåœ¨ 'end' äº‹ä»¶ä¹‹å‰ã€‚
* äº‹å®ä¸Šï¼Œ 'readable' äº‹ä»¶è¡¨æ˜æµæœ‰äº†æ–°çš„åŠ¨æ€ï¼šè¦ä¹ˆæ˜¯æœ‰äº†æ–°çš„æ•°æ®ï¼Œè¦ä¹ˆæ˜¯åˆ°äº†æµçš„å°¾éƒ¨ã€‚ å¯¹äºå‰è€…ï¼Œ stream.read() å°†è¿”å›å¯ç”¨çš„æ•°æ®ã€‚è€Œå¯¹äºåè€…ï¼Œ stream.read() å°†è¿”å› nullã€‚

````javascript
let fs =require('fs');
let rs = fs.createReadStream('./1.txt',{
  start:3,
  end:8,
  encoding:'utf8',
  highWaterMark:3
});
rs.on('readable',function () {
  console.log('readable');
  console.log('rs._readableState.buffer.length',rs._readableState.length);
  let d = rs.read(1);
  console.log('rs._readableState.buffer.length',rs._readableState.length);
  console.log(d);
  setTimeout(()=>{
      console.log('rs._readableState.buffer.length',rs._readableState.length);
  },500)
});
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ åŸºæœ¬ç”¨æ³•
è¯»æµçš„æ¨¡å¼æœ‰ï¼šæµåŠ¨æ¨¡å¼ï¼ˆä¸Šé¢çš„ï¼‰å’Œ readable  
readableä¸€èˆ¬ä¸ç”¨ã€‚è¡Œè¯»å–å™¨ ä¼šç”¨åˆ°ã€‚æºç å°±ä¸å†™äº†
````javascript
let fs = require('fs');
let rs = fs.createReadStream('./2.txt',{
  highWaterMark:3
});
//  readableæ¨¡å¼
rs.setEncoding('utf8');
// é»˜è®¤ç›‘å¬readableå ä¼šæ‰§è¡Œå›è°ƒï¼Œè£…æ»¡highWaterMarkè¿™ä¹ˆå¤šçš„å†…å®¹
// è‡ªå·±å»è¯»å–ï¼Œå¦‚æœå®¹å™¨æ˜¯ç©ºçš„ä¼šç»§ç»­è¯»å–highWaterMarkè¿™ä¹ˆå¤š,ç›´åˆ°æ²¡ä¸œè¥¿ä¸ºæ­¢
// ç±»ä¼¼å–æ°´ï¼Œå–äº†ä¸€å‡ï¼Œä¼šåœä¸€ä¸‹ã€‚æœåŠ¡å‘˜ä¼šé©¬ä¸Šå†å€’ä¸Šä¸€å‡ã€‚ä¸åœçš„è¯»
rs.on('readable',()=>{
  let r = rs.read(1);
  console.log(rs._readableState.length);
  setTimeout(() => {
    console.log(rs._readableState.length);
  }, 1000);
});

// ç”¨æ³•ï¼šè¡Œè¯»å–å™¨ 
````

## ğŸŒ¹ğŸŒ¹ æµçš„ç»å…¸åº”ç”¨ è¡Œè¯»å–å™¨
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ è¡Œè¯»å–å™¨
æ¯è¯»ä¸€è¡Œï¼Œè§¦å‘è§¦å‘ä¸€æ¬¡äº‹ä»¶ï¼Œè¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚å†™ä¸€è¡Œã€‚å°±æ˜¯è¯»ä¸€è¡Œå†™ä¸€è¡Œï¼š
* ä»¥å‰çš„æ‰“å°è¦æ¯ç§’å¯ä»¥æ‰“å°10ä¸ªå­—ç¬¦ï¼Œæ¢è¡ŒåŸè¦0.2ç§’ï¼Œæ­£è¦å¯ä»¥æ‰“å°2ä¸ªå­—ç¬¦ã€‚
* ç ”åˆ¶äººå‘˜å°±æ˜¯åœ¨æ¯è¡Œåé¢åŠ ä¸¤ä¸ªè¡¨ç¤ºç»“æŸçš„å­—ç¬¦ã€‚ä¸€ä¸ªå«åš"å›è½¦"ï¼Œå‘Šè¯‰æ‰“å­—æœºæŠŠæ‰“å°å¤´å®šä½åœ¨å·¦è¾¹ç•Œï¼›å¦ä¸€ä¸ªå«åš"æ¢è¡Œ"ï¼Œå‘Šè¯‰æ‰“å­—æœºæŠŠçº¸å‘ä¸‹ç§»ä¸€è¡Œã€‚
* Unixç³»ç»Ÿé‡Œï¼Œæ¯è¡Œç»“å°¾åªæœ‰æ¢è¡Œ"(line feed)"ï¼Œå³"\n",
* Windowsç³»ç»Ÿé‡Œé¢ï¼Œæ¯è¡Œç»“å°¾æ˜¯"<å›è½¦><æ¢è¡Œ>"ï¼Œå³"\r\n"
* Macç³»ç»Ÿé‡Œï¼Œæ¯è¡Œç»“å°¾æ˜¯"å›è½¦"(carriage return)ï¼Œå³"\r"
* åœ¨ASCIIç é‡Œ
* æ¢è¡Œ \n 10 0A
* å›è½¦ \r 13 0D

````javascript
let fs = require('fs');
// ç›®æ ‡åŠŸèƒ½ æ¯è¯»ä¸€è¡Œ è¾“å‡ºä¸€è¡Œ data
let line = new LinReader('./1.txt')
line.on('newLine',function(data){
    console.log(data)
})
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ è‡ªå·±å®ç°ä¸€ä¸ªlineReader è¡Œè¯»å–å™¨ã€‚
````javascript
let fs = require('fs');
let EventEmitter = require('events');
class LineReader extends EventEmitter{
  constructor(path){
    super();
    this.rs = fs.createReadStream(path);
    // ç›‘å¬readaleäº‹ä»¶
    const RETURN = 13;
    const LINE = 10;
    let arr = []; // å­˜æ”¾è¯»å–å‡ºæ¥çš„å†…å®¹
    this.rs.on('readable',()=>{
      // ä¸€ä¸ªä¸ªçš„æ‹¿å‡ºæ¥ç¢°åˆ°å›è½¦å å°±æŠŠä¹‹å‰çš„å†…å®¹å‘å°„å‡ºæ¥ \r\n
      let char;
      while (char = this.rs.read(1)) { // å–å‡ºæ¯ä¸€ä¸ª
        switch (char[0]) {
          case RETURN:
            this.emit('newLine',Buffer.concat(arr).toString());
            arr = []; // å¦‚æœ\rä¸‹ä¸€ä¸ªä¸æ˜¯\nçš„è¯ ä¹Ÿæ”¾åˆ°æ•°ç»„ä¸­
            if(this.rs.read(1)[0]!==LINE){
              arr.push(char); 
            }
            break;
          case LINE: // macä¸‹æ²¡æœ‰\r åªæœ‰\n
            this.emit('newLine', Buffer.concat(arr).toString());
            arr = []; // å¦‚æœ\rä¸‹ä¸€ä¸ªä¸æ˜¯\nçš„è¯ ä¹Ÿæ”¾åˆ°æ•°ç»„ä¸­
            break;
          default:
            arr.push(char); // å°†è¯»å–å‡ºæ¥çš„bufferæ”¾åˆ°æ•°ç»„ä¸­
        }
      }
    });
    this.rs.on('end',()=>{
      this.emit('newLine', Buffer.concat(arr).toString());
    })
  }
} 
let line = new LineReader('./3.txt');

line.on('newLine',function(data) {
    console.log(data);
});
// promise äº‹ä»¶ç¯ (2)  æµ 

// è¯»æµ on('data') on('readable')  å†™æµ  write end
````

## ğŸŒ¹ğŸŒ¹ è‡ªå®šä¹‰æµ
* æ‰€æœ‰æµéƒ½åŸºäº `stream` è¿™ä¸ªæ¨¡å—,éƒ½æ˜¯é€šè¿‡ç»§æ‰¿è¯¥æ¨¡å—å†…ç½®çš„å¯¹è±¡å®ç°çš„

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ åˆ¤æ–­æµæ˜¯ä¸æ˜¯æµ
````javascript
let stream = require('stream'); 
let rs = fs.createReadStream('./1.txt');
console.log(rs instanceof stream);
````
### ğŸŒ¹ğŸŒ¹ğŸŒ¹ è‡ªå®šä¹‰ä¸€ä¸ªå¯è¯»æµ Readable 
> å¯è¯»çš„æµ (ä¾‹å¦‚ `fs.createReadStream()`).

````javascript
let {Readable} = require('stream');
// è‡ªå·±å®ç°æµ fs.createReadStream

// æ‰€æœ‰çš„æµéƒ½åŸºäºè¿™ä¸ªæ¨¡å—
let {Readable} = require('stream');
// é»˜è®¤fs.createReadStreamè‡ªå·±å®ç°äº†ä¸€ä¸ª_read è°ƒç”¨çš„fs.read
// æ‰€æœ‰è‡ªå·±å®ç°ä¸€ä¸ªæµä¹Ÿè¦å®ç°è¿™ä¸ªæ–¹æ³•
class MyStream extends Readable{
  constructor(){
    super();
    this.index = 9;
  }
  _read() { // å¦‚æœæƒ³è‡ªå·±å®ç°å¯è¯»æµ éœ€è¦ç»§æ‰¿Readableï¼Œå¹¶ä¸”é‡å†™_readæ–¹æ³•ï¼Œæ–¹æ³•ä¸­è°ƒç”¨push å°±æ˜¯æŠŠç»“æœä¼ é€’ç»™on('data')äº‹ä»¶
    this.push(this.index--+'');
    if(this.index == 0){
      this.push(null);
    }
  }
}
let myStream = new MyStream();
myStream.on('data',(data)=>{
  console.log(data.toString());
});
myStream.on('end',function () {
  console.log('end');
})

````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ è‡ªå®šä¹‰ä¸€ä¸ªå¯å†™æµ Writable
> å¯å†™çš„æµ (ä¾‹å¦‚ 'fs.createWriteStream()').

````javascript
let {Writable} = require('stream');
let fs = require('fs');
class MyStream extends Writable{
  constructor(){
    super();
    this.index = 9;
  }
  _write(chunk,encoding,callback){ // this.clearBuffer()
    console.log(chunk,encoding);
    // å¯ä»¥å€ŸåŠ©å¯å†™æµå®ç°è‡ªå·±å†™å…¥çš„é€»è¾‘
    callback(); // ä¸è°ƒç”¨callback åé¢çš„writeå°±ä¸ä¼šæ‰§è¡Œ
  }
}
let myStream = new MyStream();
myStream.write('1','utf8');
myStream.write('1', 'utf8');
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ è‡ªå®šä¹‰ä¸€ä¸ªåŒå·¥æµï¼ˆå¯è¯»å¯å†™æµï¼‰ Duplex
> å¯è¯»å†™çš„æµ (ä¾‹å¦‚ `net.Socket`).

````javascript
let {Duplex} = require('stream');
let fs = require('fs');
class MyStream extends Duplex{
  constructor(){
    super();
  }
  _read(){
    this.push('1');
  }
  _write(chunk,encoding,callback){
    console.log(chunk)
    callback();
  }
}
let myStream = new MyStream
myStream.write('ok');

````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ è‡ªå®šä¹‰ä¸€ä¸ªè½¬æ¢æµ Transform
> Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplexæµ (ä¾‹å¦‚ `zlib.createDeflate()`).  
> å‹ç¼©æ–‡ä»¶.pipe(å‹ç¼©æµs).pipe(å‹ç¼©å¥½çš„æ–‡ä»¶)  ä¸­é—´çš„ `å‹ç¼©æµs` ä»å†™æµ è½¬æ¢æˆ è¯»æµ
> è½¬åŒ–æµ (å†™æµ -> è¯»æµ) socket res
````javascript
let {Transform} = require('stream');
let fs = require('fs');
class MyStream extends Transform{
  _transform(chunk,encoding,callback){
    this.push(chunk.toString().toUpperCase());
    callback();
  }
}
let myStream = new MyStream
// è½¬åŒ–æµ å°±æ˜¯å†å¯è¯»æµå’Œå¯å†™æµä¹‹é—´ åšè½¬åŒ–æ“ä½œ
process.stdin.pipe(myStream).pipe(process.stdout);
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ è‡ªå®šä¹‰ç®¡é“æµ readable
````javascript
const stream = require('stream')
var index = 0;
const readable = stream.Readable({
    highWaterMark: 2,
    read: function () {
        process.nextTick(() => {
            console.log('push', ++index)
            this.push(index+'');
        })
    }
})

const writable = stream.Writable({
    highWaterMark: 2,
    write: function (chunk, encoding, next) {
        console.log('å†™å…¥:', chunk.toString())
    }
})

readable.pipe(writable);
````


### ğŸŒ¹ğŸŒ¹ğŸŒ¹ è‡ªå®šä¹‰å¯¹è±¡æµ
é»˜è®¤æƒ…å†µä¸‹ï¼Œæµå¤„ç†çš„æ•°æ®æ˜¯Buffer/Stringç±»å‹çš„å€¼ã€‚æœ‰ä¸€ä¸ªobjectModeæ ‡å¿—ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®å®ƒè®©æµå¯ä»¥æ¥å—ä»»ä½•JavaScriptå¯¹è±¡ã€‚
````javascript
const {Transform} = require('stream');
let fs = require('fs');
let rs = fs.createReadStream('./users.json');
rs.setEncoding('utf8');
let toJson = Transform({
    readableObjectMode: true,
    transform(chunk, encoding, callback) {
        this.push(JSON.parse(chunk));
        callback();
    }
});
let jsonOut = Transform({
    writableObjectMode: true,
    transform(chunk, encoding, callback) {
        console.log(chunk);
        callback();
    }
});
rs.pipe(toJson).pipe(jsonOut)
````
````json
[
  {"name":"zfpx1","age":8},
  {"name":"zfpx2","age":9}
]
````

### ğŸŒ¹ğŸŒ¹ğŸŒ¹ unshift
readable.unshift() æ–¹æ³•ä¼šæŠŠä¸€å—æ•°æ®å‹å›åˆ°Bufferå†…éƒ¨ã€‚ è¿™åœ¨å¦‚ä¸‹ç‰¹å®šæƒ…å½¢ä¸‹æœ‰ç”¨ï¼š ä»£ç æ­£åœ¨æ¶ˆè´¹ä¸€ä¸ªæ•°æ®æµï¼Œå·²ç»"ä¹è§‚åœ°"æ‹‰å–äº†æ•°æ®ã€‚ åˆéœ€è¦"åæ‚”-æ¶ˆè´¹"ä¸€äº›æ•°æ®ï¼Œä»¥ä¾¿è¿™äº›æ•°æ®å¯ä»¥ä¼ ç»™å…¶ä»–äººç”¨ã€‚
````javascript
const {Transform} = require('stream');
const { StringDecoder } = require('string_decoder');
let decoder = new StringDecoder('utf8');
let fs = require('fs');
let rs = fs.createReadStream('./req.txt');

function parseHeader(stream, callback) {
    let header = '';
    rs.on('readable',onReadable);
    function onReadable() {

        let chunk;
        while(null != (chunk = rs.read())){
            const str = decoder.write(chunk);
            if(str.match(/\r\n\r\n/)){
                const split = str.split(/\r\n\r\n/);
                console.log(split);
                header+=split.shift();
                const remaining = split.join('\r\n\r\n');
                const buf = Buffer.from(remaining,'utf8');
                rs.removeListener('readable', onReadable);
                if(buf.length){
                    stream.unshift(buf);
                }
                callback(null,header,rs);
            }else{
                header += str;
            }
        }
    }
}
parseHeader(rs,function(err,header,stream){
    console.log(header);
    stream.setEncoding('utf8');
    stream.on('data',function (data) {
        console.log('data',data);
    });
});
````
````txt
Host: www.baidu.com
User-Agent: curl/7.53.0
Accept: */*
name=zfpx&age=9
````

## ğŸŒ¹ğŸŒ¹ æµçš„ç†è§£ ğŸ˜„
[TODO](https://zhufengzhufeng.github.io/201802/html/16.Stream-4.html)
